<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω c√¥ng vi·ªác</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #74ebd5, #acb6e5);
    }
    input, textarea {
      margin: 5px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input[type="text"] {
      width: 200px;
    }
    button {
      padding: 10px 18px;
      margin: 5px;
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #addBtn { background-color: #007bff; }
    #addBtn:hover { background-color: #0056b3; }

    #exportBtn { background-color: #28a745; }
    #exportBtn:hover { background-color: #1e7e34; }

    #clearBtn { background-color: #e74c3c; }
    #clearBtn:hover { background-color: #c0392b; }

    table {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    th {
      background-color: #f2f2f2;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 12px;
      width: 500px;
      max-height: none;
      overflow-y: visible;
    }
    #modalNote {
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      
    }
    .close {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }
    .modal-buttons button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      color: white;
    }
    .edit-btn { background-color: #ffc107; }
    .delete-btn { background-color: #dc3545; }
    /* T√πy ch·ªânh chi·ªÅu r·ªông c·ªôt trong b·∫£ng xu·∫•t */
  .export-table {
    table-layout: fixed;
  }

  .export-table th:nth-child(1),
  .export-table td:nth-child(1) {
       width: 6%;   /* STT */
  }

  .export-table th:nth-child(2),
  .export-table td:nth-child(2) {
       width: 22%;  /* C√¥ng vi·ªác */
  }

  .export-table th:nth-child(3),
  .export-table td:nth-child(3) {
    width: 44%;  /* Ghi ch√∫ - d√†i g·∫•p ƒë√¥i */
  }

  .export-table th:nth-child(4),
  .export-table td:nth-child(4) {
    width: 22%;  /* Tr·∫°ng th√°i */
  }

  .export-table th:nth-child(5),
  .export-table td:nth-child(5) {
    width: 22%;  /* Ng√†y nh·∫≠p */
  }

    .hide-when-capture {
      display: inline-block;
    }
    @media (max-width: 600px) {
      input, textarea {
        width: 100%;
      }
      .modal-content {
        width: 95%;
      }
      #addBtn, #exportBtn, #clearBtn {
        width: 48%;
        font-size: 14px;
      }
      th, td {
        font-size: 14px;
        padding: 8px;
      }
    }
    @media (min-width: 768px) {
      .modal-content { width: 600px; }
    }

    .input-wrapper {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .search-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 15px;
    }
    #searchInput {
      padding: 10px 15px;
      border: 2px solid #9b59b6;
      border-radius: 10px;
      width: 300px;
      font-size: 15px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    #searchInput:focus {
      border-color: #8e44ad;
      box-shadow: 0 0 8px rgba(142, 68, 173, 0.5);
    }

    #toast {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 16px;
      position: fixed;
      z-index: 1000;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      font-size: 16px;
      transition: visibility 0s, opacity 0.5s ease;
      opacity: 0;
    }
    #taskTable tbody tr {
  cursor: pointer;
  transition: background-color 0.2s ease;
}

#taskTable tbody tr:hover {
  background-color: #ced413;
}
#taskTable th:first-child,
#taskTable td:first-child {
  text-align: center;
  vertical-align: middle;
  width: 50px;
  max-width: 50px;
}
.export-table {
  table-layout: fixed;
}

.export-table th:first-child,
.export-table td:first-child {
  text-align: center;
  vertical-align: middle;
  width: 50px;
  max-width: 50px;
}
/* x√≥a */
.cancel-btn {
    background-color: #0090f0;
    border: none;
    color: black;
    padding: 8px 16px;
    margin: 4px;
    border-radius: 5px;
    cursor: pointer;
  }

  .cancel-btn:hover {
    background-color: #080707;
  }

  .delete-btn {
    background-color: #dc3545;
    color: white;
    padding: 8px 16px;
    border: none;
    margin: 4px;
    border-radius: 5px;
    cursor: pointer;
  }

  .delete-btn:hover {
    background-color: #c82333;
  }
  #modalTask, #modalNote {
    background-color: #e0e0e0; /* n·ªÅn x√°m m·∫∑c ƒë·ªãnh */
    padding: 8px;
    border-radius: 4px;
  }
  #taskTable th:nth-child(4),
#taskTable td:nth-child(4) {
  width: 120px;
  text-align: center;
}

.status-label {
  font-weight: bolder;
  color: #333;
  font-size: 14px;
  margin-bottom: 6px;
  display: inline-block;
  font-family: 'Segoe UI', sans-serif;
  margin-top: 20px;
}

#modalStatus {
  width: 160px;
  padding: 8px 12px;
  font-size: 14px;
  border: 1.8px solid #4a90e2;
  border-radius: 6px;
  background-color: #f9faff;
  color: #222;
  outline: none;
  cursor: not-allowed; /* Do disabled select show not-allowed cursor */
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#modalStatus:disabled {
  background-color: #e6e9f0;
  color: #888;
  border-color: #aab3cc;
}

#modalStatus:not(:disabled):focus {
  border-color: #357ae8;
  box-shadow: 0 0 5px rgba(53, 122, 232, 0.5);
}

#taskTable th:nth-child(5),
#taskTable td:nth-child(5) {
  width: 110px;
  text-align: center;
}

/* th√™m */


.filter-container {
    margin-bottom: 5px;
    font-family: Arial, sans-serif;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .filter-container label {
    font-weight: 600;
    color: #333;
  }

  .filter-container select {
    padding: 10px 15px;
    margin-left: 10px;
    margin-top: 5px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    cursor: pointer;
    transition: border-color 0.2s ease-in-out;
    border: 2px solid #9b59b6;
    border-radius: 10px;
  }

  .filter-container select:hover,
  .filter-container select:focus {
    border-color: #007BFF;
    outline: none;
  } 
  button:disabled {
  background-color: #ccc;   /* M√†u n·ªÅn x√°m */
  color: #666;              /* M√†u ch·ªØ nh·∫°t */
  cursor: not-allowed;      /* Con tr·ªè b·ªã ch·∫∑n */
  opacity: 0.7;             /* M·ªù nh·∫π */
}

/* th√¥ng b√°o m∆∞·ª£t */
.toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
}

.toast {
  background-color: #2e7d32;
  color: #fff;
  padding: 15px 20px;
  margin-top: 10px;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  min-width: 260px;
  opacity: 0;
  transform: translateX(100%);
  animation: slideIn 0.4s forwards, fadeOut 0.4s forwards 5s;
}

@keyframes slideIn {
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes fadeOut {
  to {
    opacity: 0;
    transform: translateX(-100%);
  }
}
  #repairPagination button {
    margin: 2px;
    padding: 5px 10px;
    border: none;
    border-radius: 5px;
    background-color: #080707;
    cursor: pointer;
  }

  #repairPagination button:hover:not(:disabled) {
    background-color: #bbb;
  }

  #repairPagination button:disabled {
    background-color: #080707;
    cursor: not-allowed;
    color: #888;
  }

  #repairPagination button.active-page {
    background-color: #007bff;
    color: white;
    font-weight: bold;
  }

  .ModalRepair {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  }
  .modal-repair-wrapper {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;   /* cƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
    justify-content: center; /* cƒÉn gi·ªØa theo chi·ªÅu ngang */
    z-index: 10000;
  }

  .modal-repair-wrapper.hidden {
    display: none;
  }

  .modal-repair-box {
    background: #ffffff;
    padding: 24px 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 420px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    animation: fadeSlideIn 0.2s ease-out;
    margin-left: 450px;
    margin-top: 70px;
    /* justify-content: center;
    text-align: center; */
  }

  .modal-repair-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 18px;
    text-align: center;
    color: #333;
  }

  .modal-repair-input {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 12px;
    font-size: 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-sizing: border-box;
  }

  .modal-repair-input:focus {
    border-color: #007bff;
    outline: none;
  }

  .modal-repair-actions {
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }

  .modal-repair-btn {
    flex: 1;
    padding: 10px;
    font-size: 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .modal-repair-btn.save {
    background-color: #28a745;
    color: white;
  }

  .modal-repair-btn.save:hover {
    background-color: #218838;
  }

  .modal-repair-btn.cancel {
    background-color: #dc3545;
    color: white;
  }

  .modal-repair-btn.cancel:hover {
    background-color: #c82333;
  }

  @keyframes fadeSlideIn {
    from {
      transform: translateY(-20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  @keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

#btnSuaGhiChu:hover {
  background-color: #0056b3 !important;
}

#modalGhiChu button:hover {
  opacity: 0.9;
}


/* Modal n·ªÅn */
.modal-ghichu {
  display: none;
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.4);
  justify-content: center;
  align-items: center;
  z-index: 9999;
  font-family: 'Segoe UI', sans-serif;
}

/* H·ªôp modal ch√≠nh */
.modal-ghichu-content {
  background: white;
  padding: 24px;
  width: 90%;
  max-width: 900px;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
  animation: fadeIn 0.3s ease;
}

/* Ti√™u ƒë·ªÅ modal */
.modal-ghichu-content h2 {
  margin-top: 0;
  font-size: 20px;
  color: #333;
}
.ghichu-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 6px;
}
/* V√πng nh·∫≠p ghi ch√∫ */
.ghichu-textarea {
  width: 100%;
  height: 300px;
  padding: 20px 0px;
  padding-left: 10px;
  font-size: 15px;
  border: 1px solid #ccc;
  border-radius: 8px;
  resize: none;
  background-color: #f9f9f9;
  color: #000;
  outline: none;
  margin: 10px;
}

/* V√πng ch·ª©a n√∫t */
.ghichu-buttons {
  margin-top: 20px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* N√∫t s·ª≠a */
.btn-sua {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}
.btn-sua:hover {
  background-color: #0056b3;
}

/* N√∫t ƒë√≥ng */
.btn-dong {
  background-color: red;
  color: #000;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}
.btn-dong:hover {
  background-color: #ccc;
}

/* Hi·ªáu ·ª©ng fade */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}



  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Firebase config & init (injected by assistant) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB3YYnW0BElIeoRW-pBAWrSyo74QE1-64I",
    authDomain: "hieu1-24be7.firebaseapp.com",
    databaseURL: "https://hieu1-24be7-default-rtdb.firebaseio.com",
    projectId: "hieu1-24be7",
    storageBucket: "hieu1-24be7.firebasestorage.app",
    messagingSenderId: "350859931788",
    appId: "1:350859931788:web:945d67c77d5cd2906c4ba9",
    measurementId: "G-VGP7L1QFX7"
  };

  const app = initializeApp(firebaseConfig);
  window.firebaseApp = app;
  window.db = getFirestore(app);
</script>
<!-- End Firebase init -->

</head>
<body>
  <h2 style="text-align: center; color: #2c3e50;">·ª®ng d·ª•ng Qu·∫£n l√Ω C√¥ng vi·ªác C√° nh√¢n v√† Nh√≥m</h2>
  <div class="toast-container" id="toastContainer"></div>
  <!-- Ghi ch√∫ nhanh -->


  <!-- --- USER SWITCH: start --- -->
  <div class="filter-container" style="margin-bottom: 12px; text-align:center;">
    <label for="userSelect" style="font-weight:bold; margin-right:8px;">Ng∆∞·ªùi d√πng:</label>
    <select id="userSelect" onchange="changeUser()" style="padding:8px 12px; border-radius:8px; border:2px solid #9b59b6;">
      <option value="nhi">Ms Nhi</option>
      <option value="quan">Mr Quan</option>
      <option value="all">T·∫•t c·∫£</option>
    </select>
  </div>
  <!-- --- USER SWITCH: end --- -->

  <div class="search-wrapper">
    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm c√¥ng vi·ªác ho·∫∑c ghi ch√∫..." oninput="filterTasks()" style="width: 410px;">
    
    <div class="filter-container">
  <!-- <label for="statusFilter">L·ªçc theo tr·∫°ng th√°i:</label> -->
  <select id="statusFilter">
    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i </option>
    <option value="Ch∆∞a l√†m">Ch∆∞a l√†m</option>
    <option value="ƒêang l√†m">ƒêang l√†m</option>
    <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
  </select>
  

  
  </div>
<!-- loc ng√†y -->
  <label for="startDate" style="margin-top: 10px; margin-left: 10px;font-size: larger;">T·ª´ ng√†y:</label>
<input type="text" style="width: 110px; padding: 5px; border: 2px solid #9b59b6; border-radius: 10px;"  id="startDate" placeholder="dd/mm/yyyy">

<label for="endDate" style="margin-top: 10px;margin-left: 10px; font-size: larger;">ƒê·∫øn ng√†y:</label>
<input type="text" id="endDate" style="width: 110px; padding: 5px; border: 2px solid #9b59b6; border-radius: 10px;"  placeholder="dd/mm/yyyy">

<button id="clearDateFilter"  type="button" style="background-color: red;">X√≥a l·ªçc ng√†y</button>

  
  </div>
  <div class="input-wrapper">
    <input type="text" id="taskInput" placeholder="Nh·∫≠p c√¥ng vi·ªác">
    <input type="text" id="noteInput" placeholder="Ghi ch√∫">
    <button id="addBtn" onclick="addTask()">Th√™m</button>
    <button id="exportBtn" onclick="showExportModal()">Xu·∫•t</button>
    <button id="clearBtn" onclick="showConfirmClearModal()">X√≥a</button>
    <button id="lockBtn" onclick="lockScreen()" style="background-color: orange;">Kh√≥a</button>
    <button onclick="showWeatherModal()" style="background-color: #4ba3c7; color: white;">Th·ªùi ti·∫øt</button>
    <button onclick="showRepairModal()" style="background-color: #534bc7; color: white; "> S·ª≠a xe</button>
    <button onclick="window.open('grab_be.html', '_blank')" style="background-color: #FFD700; color: rgb(11, 11, 11);">
  Grab/Be
</button>
<button onclick="moModalGhiChu()" style="background-color: #c53f92; color: white; "> Ghi Ch√∫</button>

  <table id="taskTable">
    <thead>
      <tr>
        <th>STT</th>
        <th>C√¥ng vi·ªác</th>
        <th>Ghi ch√∫</th>
        <th>Tr·∫°ng th√°i</th> <!-- m·ªõi -->
        <th>Ng√†y nh·∫≠p</th> <!-- th√™m d√≤ng n√†y -->
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ph√¢n trang -->
   <div id="paginationControls" style="margin-top: 10px; text-align: center;">
  <button id="prevPageBtn" style="color: #080707;" >‚¨ÖÔ∏è Tr∆∞·ªõc</button>
  <span id="paginationInfo" >Trang 1</span>
  <button id="nextPageBtn" style="color: #080707;">Sau ‚û°Ô∏è</button>
</div>


  <!-- Modal chi ti·∫øt -->
  <div id="detailModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('detailModal')">&times;</span>
    <h3>Chi ti·∫øt c√¥ng vi·ªác</h3>
    <p><strong>STT:</strong> <span id="modalStt"></span></p>
    <p><strong>C√¥ng vi·ªác:</strong></p>
    <div id="modalTask" contenteditable="false" style="background-color: #e0e0e0; border-radius: 6px; padding: 6px;"></div>
    <p><strong>Ghi ch√∫:</strong></p>
    <div id="modalNote" contenteditable="false" style="background-color: #e0e0e0; border-radius: 6px; padding: 6px;"></div>
   <label for="modalStatus" class="status-label">Tr·∫°ng th√°i:</label><br>
    <select id="modalStatus" disabled>
    <option value="Ch∆∞a l√†m">Ch∆∞a l√†m</option>
    <option value="ƒêang l√†m">ƒêang l√†m</option>
    <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
    </select>
    <div class="form-group" style="margin-top: 10px;">
  <label for="modalDate" style="display: block; font-weight: bold; font-size: 14px;">Ng√†y nh·∫≠p:</label>
  <input type="text" id="modalDate" class="form-control" 
         style="background-color:#e0e0e0; width: 140px;" readonly />
</div>
    
    <div class="modal-buttons">
      <button class="edit-btn" onclick="toggleEditTask()" id="editSaveBtn">S·ª≠a</button>
      <button class="delete-btn" onclick="openDeleteConfirmation()">X√≥a</button>
    </div>
  </div>
</div>

<!-- Modal th√™m ng∆∞·ªùi d√πng m·ªõi -->
<div id="addUserModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:350px; text-align:center;">
    <span class="close" onclick="closeModal('addUserModal')" style="float:right;">&times;</span>
    <h3>üë§ Th√™m ng∆∞·ªùi d√πng m·ªõi</h3>
    <input type="text" id="newUserName" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi d√πng..." 
           style="width:90%; padding:8px; border-radius:8px; border:1px solid #ccc;">
    <div class="modal-buttons" style="justify-content:center;">
      <button class="edit-btn" onclick="addNewUser()">Th√™m</button>
      <button class="delete-btn" onclick="deleteCurrentUser()">X√≥a ng∆∞·ªùi d√πng hi·ªán t·∫°i</button>
    </div>
  </div>
</div>


  <!-- Modal xu·∫•t -->
  <div id="exportModal" class="modal">
    <div class="modal-content" id="exportContent">
      <span class="close hide-when-capture" onclick="closeModal('exportModal')">&times;</span>
      <h3 id="exportTitle">DANH S√ÅCH C√îNG VI·ªÜC</h3>
      <button class="hide-when-capture" onclick="captureExportImage()" style="margin-top: 10px; padding: 6px 12px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">Ch·ª•p ·∫£nh</button>
      <button class="hide-when-capture" onclick="exportToJson()" style="margin-top: 10px; padding: 6px 12px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">Xu·∫•t d·ªØ li·ªáu ra JSON</button>
     <input type="file" id="importJsonInput" accept=".json" style="display: none;" onchange="handleJsonImport(event)">
<button class="hide-when-capture" onclick="document.getElementById('importJsonInput').click()" style="margin-top: 10px; padding: 6px 12px; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
  Nh·∫≠p t·ª´ file JSON
</button>
        <table class="export-table">
          <thead>
            <tr>
              <th>STT</th>
              <th>C√¥ng vi·ªác</th>
              <th>Ghi ch√∫</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Ng√†y nh·∫≠p</th>
            </tr>
          </thead>
          <tbody id="exportBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Modal x√°c nh·∫≠n xo√° -->
<div id="confirmDeleteModal" class="modal">
  <div class="modal-content">
    <h3>X√°c nh·∫≠n xo√°</h3>
    <p>B·∫°n c√≥ ch·∫Øc mu·ªën xo√° c√¥ng vi·ªác n√†y kh√¥ng?</p>
    <div class="modal-buttons">
      <button class="delete-btn" onclick="confirmDelete()">X√°c nh·∫≠n</button>
      <button class="cancel-btn" onclick="closeModal('confirmDeleteModal')">H·ªßy</button>
    </div>
  </div>
</div>

  <!-- Modal x√°c nh·∫≠n x√≥a t·∫•t c·∫£ -->
  <div id="confirmClearModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('confirmClearModal')">&times;</span>
      <h3>X√°c nh·∫≠n</h3>
      <p>B·∫°n c√≥ mu·ªën x√≥a to√†n b·ªô c√¥ng vi·ªác kh√¥ng?</p>
      <div class="modal-buttons">
        <button class="delete-btn" onclick="clearAllTasks()">X√≥a t·∫•t c·∫£</button>
        <button class="edit-btn" onclick="closeModal('confirmClearModal')">H·ªßy</button>
      </div>
    </div>
  </div>
  <!-- t√¥ng s·ªë c√¥ng vi·ªác -->
  <div id="footerInfo" style="display: flex; justify-content: space-between; margin-top: 20px;">
  <div id="taskCount" style="font-weight: bold;"></div>
  <div id="updateDate" style="margin: 4px 0; font-weight: bold; text-align: center;">Ng√†y c·∫≠p nh·∫≠t: --/--/----</div>
  <div id="completedCount" style="font-weight: bold;"></div>
</div>

<div id="weatherModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:9999;">
  <div style="background:#fff; width:90%; max-width:400px; margin:100px auto; padding:20px; border-radius:10px; position:relative;">
    <button onclick="closeWeatherModal()" style="position:absolute; top:10px; right:10px;">‚ùå</button>
    <h3>Th·ªùi ti·∫øt hi·ªán t·∫°i</h3>
    <div id="weatherContent">ƒêang t·∫£i...</div>
  </div>
</div>
<!-- Modal S·ª≠a xe -->
<div id="repairModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
  <div style="background: white; width: 90%; max-width: 800px; margin: 80px auto; padding: 20px; border-radius: 10px; position: relative;">
    <h3>Nh·∫≠p th√¥ng tin s·ª≠a xe</h3>
    <!-- √î t√¨m ki·∫øm -->
<input type="text" id="repairSearchInput" placeholder="T√¨m ki·∫øm..." oninput="renderRepairTable()" 
  style=" padding: 8px 10px; width: 300px; border-radius: 10px; border: 2px solid #9b59b6;">
  <button id="clearAllRepairsBtn" style="margin-top: 10px; background-color: red; color: white; padding: 6px 12px; border-radius: 6px;">
  üóëÔ∏è Xo√° t·∫•t c·∫£
</button>
<input type="file" id="importRepairInput" accept=".json" style="display: none;" onchange="handleRepairJsonImport(event)">

<button class="hide-when-capture" onclick="document.getElementById('importRepairInput').click()" style="margin-top: 10px; padding: 6px 12px; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
  Nh·∫≠p t·ª´ file JSON
</button>



    <!-- D√£y input -->
    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
      <input type="text" id="phutungInput" placeholder="Ph·ª• t√πng" style="flex: 1; min-width: 120px; padding: 8px 10px;border: 2px solid #9b59b6;">
      <input type="text" id="diadiemInput" placeholder="ƒê·ªãa ƒëi·ªÉm" style="flex: 1; min-width: 120px; padding: 8px 10px;border: 2px solid #9b59b6;">
      <input type="text" id="thoigianInput" placeholder="dd/mm/yyyy" style="flex: 1; min-width: 120px; padding: 8px 10px;border: 2px solid #9b59b6;">
      <input type="text" id="chiphiInput" placeholder="Chi ph√≠ (ƒë·ªìng)" style="flex: 1; min-width: 120px; padding: 8px 10px;border: 2px solid #9b59b6;">
      <button onclick="addRepairRow()" style="background-color: #2ecc71; color: white; padding: 6px 12px; border: 2px solid; border-radius: 10px;">Nh·∫≠p</button>
    </div>

    <!-- B·∫£ng hi·ªÉn th·ªã -->
    <table border="1" width="100%" style="border-collapse: collapse; text-align: center;">
      <thead style="background-color: #eee;">
        <tr>
          <th style="width: 50px;">STT</th>
          <th>Ph·ª• t√πng</th>
          <th>ƒê·ªãa ƒëi·ªÉm</th>
          <th>Th·ªùi gian</th>
          <th>Chi ph√≠</th>
        </tr>
      </thead>
      <tbody id="repairTableBody">
        <!-- D·ªØ li·ªáu s·∫Ω th√™m v√†o ƒë√¢y -->
      </tbody>
    </table>
    <div id="repairPagination" style="margin-top: 10px; text-align: center;"></div>

     <p id="totalCost" style="margin-top: 10px; font-weight: bold;">T·ªïng chi ph√≠: 0 VND</p>

    <br />
    <button onclick="closeRepairModal()" style="background-color: #e74c3c; color: white; padding: 8px 16px; border: none; border-radius: 5px;">ƒê√≥ng</button>
  </div>
  <!-- luu lai -->
  <div id="confirmModal" class="ModalRepair" style="display:none;">
  <div class="modal-content" style="padding: 20px; border-radius: 8px; background-color: #fff;">
    <p id="confirmMessage"></p>
    <div style="text-align: right; margin-top: 20px;">
      <button id="confirmYes" style="background-color: red; color: white; padding: 6px 12px; border-radius: 6px;">Xo√°</button>
      <button id="confirmNo" style="margin-left: 10px; padding: 6px 12px; border-radius: 6px; background-color: #0056b3;">Hu·ª∑</button>
    </div>
  </div>
</div>
</div>


<div id="editRepairModal" class="modal-repair-wrapper hidden">
  <div class="modal-repair-box">
    <h2 class="modal-repair-title">üõ†Ô∏è S·ª≠a th√¥ng tin s·ª≠a ch·ªØa</h2>

    <input id="editPhutungInput" class="modal-repair-input" placeholder="Ph·ª• t√πng ƒë√£ thay">
    <input id="editDiadiemInput" class="modal-repair-input" placeholder="ƒê·ªãa ƒëi·ªÉm s·ª≠a ch·ªØa">
    <input id="editThoigianInput" class="modal-repair-input" placeholder="Ng√†y s·ª≠a (dd/mm/yyyy)">
    <input id="editChiphiInput" class="modal-repair-input" placeholder="Chi ph√≠ (ƒë·ªìng)">

    <div class="modal-repair-actions">
      <button onclick="saveEditedRepair()" class="modal-repair-btn save">üíæ L∆∞u</button>
      <button onclick="closeEditRepairModal()" class="modal-repair-btn cancel">‚ùå H·ªßy</button>
    </div>
  </div>
</div>

<!-- ghi ch√∫ -->
 <!-- Modal Ghi Ch√∫ ƒê·∫πp -->
<div id="modalGhiChu" class="modal-ghichu">
  <div class="modal-ghichu-content">
    <h2>üìù Ghi Ch√∫</h2>
    <textarea id="noiDungGhiChu" readonly class="ghichu-textarea"></textarea>
    <div class="ghichu-footer">
    <div id="thoiGianLuu" style="font-size: 13px; color: #666; margin-top: 6px;">
      üïí Ch∆∞a c√≥ l·∫ßn l∆∞u n√†o
    </div>
    <div class="ghichu-buttons">
      <button id="btnSuaGhiChu" onclick="batCheDoSuaGhiChu()" class="btn-sua">‚úèÔ∏è S·ª≠a</button>
      <button onclick="dongModalGhiChu()" class="btn-dong">ƒê√≥ng</button>
    </div>
    </div>
  </div>
</div>
  <!-- Toast -->
  <div id="toast"></div>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
    let currentDetailIndex = -1;
    let isStorageFull = false;
    let isEditing = false;

    let currentPage = 1;
    const tasksPerPage = 10;

    function saveToLocalStorage() {
  try {
    // Kh√¥ng l∆∞u khi ƒëang ·ªü ch·∫ø ƒë·ªô "T·∫•t c·∫£"
    if (currentUser === "all") {
      console.warn("ƒêang ·ªü ch·∫ø ƒë·ªô 'T·∫•t c·∫£' ‚Äî kh√¥ng l∆∞u d·ªØ li·ªáu.");
      return;
    }

    // L∆∞u ri√™ng t·ª´ng ng∆∞·ªùi d√πng
    localStorage.setItem(`tasks_${currentUser}`, JSON.stringify(tasks));

    enableAddButton(); // b·∫≠t l·∫°i n√∫t n·∫øu l∆∞u th√†nh c√¥ng
  } catch (e) {
    if (e.name === "QuotaExceededError" || e.name === "NS_ERROR_DOM_QUOTA_REACHED") {
      showToast("B·ªô nh·ªõ ƒë√£ ƒë·∫ßy! Kh√¥ng th·ªÉ l∆∞u th√™m c√¥ng vi·ªác.");
      disableAddButton(); // v√¥ hi·ªáu h√≥a n√∫t th√™m
    } else {
      console.error("L·ªói l∆∞u localStorage:", e);
    }
  }
}

// v√¥ hi·ªáu qu√° n√∫t th√™m
function disableAddButton() {
  const btn = document.getElementById("addBtn");
  if (btn) btn.disabled = true;
}

function enableAddButton() {
  const btn = document.getElementById("addBtn");
  if (btn) btn.disabled = false;
}

//th√™m t√≠nh nƒÉng danh s√°ch xu·∫•t
    function renderTable() {
      filterTasks();
      
    }
function filterTasks() {
  const keywordInput = document.getElementById("searchInput").value.toLowerCase();
  const selectedStatus = document.getElementById("statusFilter").value;
  const tableBody = document.querySelector("#taskTable tbody");
  const startDateStr = document.getElementById("startDate").value;
  const endDateStr = document.getElementById("endDate").value;

  tableBody.innerHTML = "";

  const statusPriority = {
    "ƒêang l√†m": 1,
    "Ch∆∞a l√†m": 2,
    "Ho√†n th√†nh": 3
  };

  function parseDDMMYYYY(dateStr) {
    const parts = dateStr.split("/");
    const day = parts[0].padStart(2, "0");
    const month = parts[1].padStart(2, "0");
    const year = parts[2];
    return new Date(`${year}-${month}-${day}`);
  }

  const startDate = startDateStr ? parseDDMMYYYY(startDateStr) : null;
  const endDate = endDateStr ? parseDDMMYYYY(endDateStr) : null;

  // üß† T√°ch t·ª´ kh√≥a (theo d·∫•u ph·∫©y ho·∫∑c kho·∫£ng tr·∫Øng)
  const keywords = keywordInput
    .split(/[,\s]+/) // t√°ch theo d·∫•u ph·∫©y ho·∫∑c kho·∫£ng tr·∫Øng
    .filter(k => k.length > 0);

  // üß† X√°c ƒë·ªãnh ki·ªÉu t√¨m ki·∫øm t·ª± ƒë·ªông:
  // - C√≥ d·∫•u ph·∫©y => OR (√≠t nh·∫•t 1 t·ª´)
  // - Kh√¥ng c√≥ d·∫•u ph·∫©y => AND (ph·∫£i ch·ª©a t·∫•t c·∫£ t·ª´)
  const isAndSearch = !keywordInput.includes(",");

  const filteredTasks = tasks.filter(taskObj => {
    const text = `${(taskObj.task || "").toLowerCase()} ${(taskObj.note || "").toLowerCase()}`;

    const taskMatch = keywords.length === 0
      ? true
      : isAndSearch
        ? keywords.every(word => text.includes(word))   // AND: t·∫•t c·∫£ t·ª´ kh√≥a ph·∫£i c√≥
        : keywords.some(word => text.includes(word));   // OR: √≠t nh·∫•t 1 t·ª´ kh√≥a

    const statusMatch =
      selectedStatus === "" ||
      (taskObj.status || "").trim().toLowerCase() === selectedStatus.toLowerCase();

    const taskDateStr = taskObj.date || "";
    let dateMatch = true;

    if ((startDate || endDate) && taskDateStr.includes("/")) {
      const taskDate = parseDDMMYYYY(taskDateStr);
      if (startDate && taskDate < startDate) dateMatch = false;
      if (endDate && taskDate > endDate) dateMatch = false;
    }

    return taskMatch && statusMatch && dateMatch;
  });

  //  S·∫Øp x·∫øp: ghim tr∆∞·ªõc > tr·∫°ng th√°i > ng√†y
  filteredTasks.sort((a, b) => {
    if (a.pinned && !b.pinned) return -1;
    if (!a.pinned && b.pinned) return 1;

    const statusA = (a.status || "").trim();
    const statusB = (b.status || "").trim();
    const priorityA = statusPriority[statusA] || 99;
    const priorityB = statusPriority[statusB] || 99;

    if (priorityA !== priorityB) return priorityA - priorityB;

    const dateA = a.date ? parseDDMMYYYY(a.date) : new Date(0);
    const dateB = b.date ? parseDDMMYYYY(b.date) : new Date(0);
    return dateB - dateA;
  });

  // üßæ PH√ÇN TRANG
  const totalPages = Math.ceil(filteredTasks.length / tasksPerPage);
  if (currentPage > totalPages) currentPage = totalPages || 1;

  const startIndex = (currentPage - 1) * tasksPerPage;
  const paginatedTasks = filteredTasks.slice(startIndex, startIndex + tasksPerPage);

  paginatedTasks.forEach((taskObj, idx) => {
    const row = document.createElement("tr");

    let color = "";
    switch ((taskObj.status || "").trim().toLowerCase()) {
      case "ho√†n th√†nh": color = "green"; break;
      case "ch∆∞a l√†m": color = "red"; break;
      case "ƒëang l√†m": color = "#000000"; break;
      default: color = "black";
    }

    row.innerHTML = `
      <td>${startIndex + idx + 1}</td>
      <td>${taskObj.pinned ? "üìå " : ""}${taskObj.task}</td>
      <td>${taskObj.note}</td>
      <td style="color: ${color}; font-weight: bold;">${taskObj.status || ""}</td>
      <td>${taskObj.date || ""}</td>
    `;

    row.querySelector("td:nth-child(2)").oncontextmenu = (e) => {
      e.preventDefault();
      togglePin(tasks.indexOf(taskObj));
    };

    row.onclick = (e) => {
      if (e.target.tagName.toLowerCase() === "button") return;
      showDetails(tasks.indexOf(taskObj));
    };

    tableBody.appendChild(row);
  });

  // üî¢ C·∫≠p nh·∫≠t ph√¢n trang
  document.getElementById("paginationInfo").textContent =
    `Trang ${currentPage} / ${totalPages || 1}`;

  document.getElementById("prevPageBtn").disabled = currentPage === 1;
  document.getElementById("nextPageBtn").disabled = currentPage === totalPages || totalPages === 0;

  // üìÖ C·∫≠p nh·∫≠t th√¥ng tin th·ªëng k√™
  document.getElementById("taskCount").textContent = `T·ªïng c√¥ng vi·ªác: ${filteredTasks.length}`;
  const completedCount = filteredTasks.filter(task => (task.status || "").toLowerCase().trim() === "ho√†n th√†nh").length;
  document.getElementById("completedCount").textContent = `Ho√†n th√†nh: ${completedCount}`;
  const today = new Date();
  const formattedDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth()+1).padStart(2, '0')}/${today.getFullYear()}`;
  document.getElementById("updateDate").textContent = `Ng√†y c·∫≠p nh·∫≠t: ${formattedDate}`;
}

function togglePin(index) {
  tasks[index].pinned = !tasks[index].pinned;
  saveToLocalStorage();
  filterTasks();
}
function isLocalStorageFull(data) {
  try {
    // th·ª≠ l∆∞u d·ªØ li·ªáu t·∫°m
    localStorage.setItem("__test__", data);
    localStorage.removeItem("__test__");
    return false; // ch∆∞a ƒë·∫ßy
  } catch (e) {
    return true; // ƒë·∫ßy
  }
}



  function addTask() {
  const task = document.getElementById("taskInput").value.trim();
  const note = document.getElementById("noteInput").value.trim();

  if (isStorageFull) {
    showToast("Kh√¥ng th·ªÉ th√™m v√¨ b·ªô nh·ªõ ƒë√£ ƒë·∫ßy.");
    return;
  }

  if (task === "") {
    alert("Vui l√≤ng nh·∫≠p c√¥ng vi·ªác!");
    return;
  }

  const newTask = {
    task,
    note,
    status: "Ch∆∞a l√†m",
    date: new Date().toLocaleDateString("vi-VN"),
    pinned: false // üÜï m·∫∑c ƒë·ªãnh c√¥ng vi·ªác m·ªõi ch∆∞a ghim
  };

  const tempData = JSON.stringify([newTask, ...tasks]);

  if (isLocalStorageFull(tempData)) {
    showToast("B·ªô nh·ªõ g·∫ßn ƒë·∫ßy! Kh√¥ng th·ªÉ th√™m c√¥ng vi·ªác.");
    disableAddButton();
    return;
  }

  tasks.unshift(newTask);
  saveToLocalStorage();
  filterTasks();

  document.getElementById("taskInput").value = "";
  document.getElementById("noteInput").value = "";
  showToast("ƒê√£ th√™m c√¥ng vi·ªác m·ªõi.");
  

  
}



   function deleteTask(index) {
  if (currentUser === "all") {
    showToast("‚ùå Kh√¥ng th·ªÉ x√≥a trong ch·∫ø ƒë·ªô 'T·∫•t c·∫£'!");
    return;
  }

  if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¥ng vi·ªác n√†y kh√¥ng?")) {
    tasks.splice(index, 1);

    // L∆∞u l·∫°i ƒë√∫ng kho ng∆∞·ªùi d√πng hi·ªán t·∫°i
    localStorage.setItem(`tasks_${currentUser}`, JSON.stringify(tasks));

    closeModal("detailModal");
    filterTasks();
    showToast("üóëÔ∏è ƒê√£ x√≥a c√¥ng vi·ªác th√†nh c√¥ng!");
  }
}


    function editTask(index) {
      const taskObj = tasks[index];
      const newTask = prompt("S·ª≠a c√¥ng vi·ªác:", taskObj.task);
      if (newTask === null) return;

      const newNote = prompt("S·ª≠a ghi ch√∫:", taskObj.note);
      if (newNote === null) return;

      tasks[index] = { 
  task: newTask.trim(), 
  note: newNote.trim(),
  status: tasks[index].status // gi·ªØ nguy√™n tr·∫°ng th√°i
};

      saveToLocalStorage();
      closeModal('detailModal');
      filterTasks();
    }

    function showDetails(index) {
  currentDetailIndex = index;
  const task = tasks[index];

  document.getElementById("modalStt").innerText = index + 1;
  document.getElementById("modalTask").innerText = task.task;
  document.getElementById("modalNote").innerText = task.note;
  document.getElementById("modalDate").value = task.date || "";


  // G√°n tr·∫°ng th√°i v√†o dropdown
  const modalStatus = document.getElementById("modalStatus");
  const status = (task.status || "").trim().toLowerCase();
  const validStatuses = ["ch∆∞a l√†m", "ƒëang l√†m", "ho√†n th√†nh"];
  modalStatus.value = validStatuses.includes(status) ? capitalize(status) : "Ch∆∞a l√†m";

  // Reset ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
  const taskDiv = document.getElementById("modalTask");
  const noteDiv = document.getElementById("modalNote");
  const editBtn = document.getElementById("editSaveBtn");

  taskDiv.contentEditable = "false";
  noteDiv.contentEditable = "false";
  taskDiv.style.backgroundColor = "#e0e0e0";
  noteDiv.style.backgroundColor = "#e0e0e0";
  modalStatus.disabled = true;
  editBtn.textContent = "S·ª≠a";
  isEditing = false;

  document.getElementById("detailModal").style.display = "block";
}

// H√†m h·ªó tr·ª£ vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu
function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}



function showExportModal() {
  const exportBody = document.getElementById("exportBody");
  exportBody.innerHTML = "";

  const today = new Date();
  const formattedDateTime = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()} - ${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}`;
  document.getElementById("exportTitle").innerText = `DANH S√ÅCH C√îNG VI·ªÜC ${formattedDateTime}`;

  const keyword = document.getElementById("searchInput").value.toLowerCase();
  const selectedStatus = document.getElementById("statusFilter").value;
  const startDateStr = document.getElementById("startDate").value;
  const endDateStr = document.getElementById("endDate").value;

  function parseDDMMYYYY(dateStr) {
    const parts = dateStr.split("/");
    const day = parts[0].padStart(2, "0");
    const month = parts[1].padStart(2, "0");
    const year = parts[2];
    return new Date(`${year}-${month}-${day}`);
  }

  const startDate = startDateStr ? parseDDMMYYYY(startDateStr) : null;
  const endDate = endDateStr ? parseDDMMYYYY(endDateStr) : null;

  const filteredTasks = tasks.filter(task => {
    const taskMatch =
      task.task.toLowerCase().includes(keyword) ||
      task.note.toLowerCase().includes(keyword);

    const statusMatch =
      selectedStatus === "" ||
      (task.status || "").trim().toLowerCase() === selectedStatus.toLowerCase();

    let dateMatch = true;
    if ((startDate || endDate) && task.date && task.date.includes("/")) {
      const taskDate = parseDDMMYYYY(task.date);
      if (startDate && taskDate < startDate) dateMatch = false;
      if (endDate && taskDate > endDate) dateMatch = false;
    }

    return taskMatch && statusMatch && dateMatch;
  });

  const statusOrder = { 'ƒëang l√†m': 1, 'ch∆∞a l√†m': 2, 'ho√†n th√†nh': 3 };
  filteredTasks.sort((a, b) => {
    return (statusOrder[(a.status || '').toLowerCase()] || 99) - (statusOrder[(b.status || '').toLowerCase()] || 99);
  });

  filteredTasks.forEach((task, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${task.task}</td>
      <td>${task.note}</td>
      <td>${task.status || ""}</td>
      <td>${task.date || ""}</td> 
    `;
    exportBody.appendChild(row);
  });


      

  document.getElementById("exportModal").style.display = "block";
}

    function captureExportImage() {
      const exportContent = document.querySelector("#exportModal .modal-content");
      const originalMaxHeight = exportContent.style.maxHeight;

      document.querySelectorAll(".hide-when-capture").forEach(el => el.style.display = "none");

      exportContent.style.maxHeight = "none";
      exportContent.style.overflow = "visible";

      html2canvas(exportContent, {
        backgroundColor: "#fff",
        scale: 2,
        useCORS: true
      }).then(canvas => {
        const link = document.createElement("a");
        link.download = "danh_sach_cong_viec.jpg";
        link.href = canvas.toDataURL("image/jpeg");
        link.click();

        exportContent.style.maxHeight = originalMaxHeight || "80vh";
        exportContent.style.overflow = "auto";
        document.querySelectorAll(".hide-when-capture").forEach(el => el.style.display = "inline-block");
      });
      document.getElementById("exportModal").style.display = "none";

    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = "none";
    }

    function showConfirmClearModal() {
      document.getElementById("confirmClearModal").style.display = "block";
    }

    function clearAllTasks() {
  if (tasks.length === 0) {
    showToast("Kh√¥ng c√≥ c√¥ng vi·ªác n√†o ƒë·ªÉ x√≥a.");
    closeModal('confirmClearModal')
    return;
  }

  // T·∫°o file backup tr∆∞·ªõc khi x√≥a
  const backupBlob = new Blob([JSON.stringify(tasks, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(backupBlob);
  link.download = `backup_cong_viec_${new Date().toLocaleDateString("vi-VN").replace(/\//g, "-")}.json`;
  link.click();

  // X√≥a to√†n b·ªô
  tasks = [];
  saveToLocalStorage();
  closeModal('confirmClearModal');
  filterTasks();

  showToast("ƒê√£ x√≥a to√†n b·ªô c√¥ng vi·ªác! File backup ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ.");
}

   


  function showToast(message) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerText = message;
  container.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 7000);
}


    // window.onclick = function(event) {
    //   if (event.target.classList.contains("modal")) {
    //     event.target.style.display = "none";
    //   }
    // }
    window.addEventListener("keydown", function(event) {
    if (event.key === "Escape") {
      document.querySelectorAll(".modal").forEach(modal => {
      modal.style.display = "none";
        });
      }
    });

    //window.onload = renderTable;
    document.getElementById("statusFilter").addEventListener("change", filterTasks);


function toggleEditTask() {
  const taskDiv = document.getElementById("modalTask");
  const noteDiv = document.getElementById("modalNote");
  const modalStatus = document.getElementById("modalStatus");
  const editSaveBtn = document.getElementById("editSaveBtn");

  if (!isEditing) {
    // B·∫≠t ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
    taskDiv.contentEditable = "true";
    noteDiv.contentEditable = "true";
    taskDiv.style.backgroundColor = "#fff";
    noteDiv.style.backgroundColor = "#fff";
    modalStatus.disabled = false;

    editSaveBtn.textContent = "L∆∞u";
    isEditing = true;
  } else {
    // L∆∞u thay ƒë·ªïi
    const updatedTask = taskDiv.innerText.trim();
    const updatedNote = noteDiv.innerText.trim();
    const updatedStatus = modalStatus.value;

    if (updatedTask === "") {
      alert("C√¥ng vi·ªác kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
      return;
    }

    // C·∫≠p nh·∫≠t ƒë√∫ng c√¥ng vi·ªác hi·ªán t·∫°i
    tasks[currentDetailIndex].task = updatedTask;
    tasks[currentDetailIndex].note = updatedNote;
    tasks[currentDetailIndex].status = updatedStatus;

    saveToLocalStorage();
    filterTasks();
    showDetails(currentDetailIndex);

    editSaveBtn.textContent = "S·ª≠a";
    isEditing = false;

    // ƒê√≥ng kh√≥a ch·ªânh s·ª≠a
    taskDiv.contentEditable = "false";
    noteDiv.contentEditable = "false";
    taskDiv.style.backgroundColor = "#e0e0e0";
    noteDiv.style.backgroundColor = "#e0e0e0";
    modalStatus.disabled = true;
  }
}
  // x√≥a chi ti·∫øt
  function openDeleteConfirmation() {
    document.getElementById("confirmDeleteModal").style.display = "block";
  }

  function confirmDelete() {
    tasks.splice(currentDetailIndex, 1);
    saveToLocalStorage();
    filterTasks();
    closeModal("detailModal");
    closeModal("confirmDeleteModal");
    showToast("ƒê√£ xo√° c√¥ng vi·ªác!");
    if (currentDetailIndex === -1) return;
  }

  // function closeModal(id) {
  //   document.getElementById(id).style.display = "none";
  // }

  function editField(spanElement, field) {
  const originalValue = spanElement.innerText;
  const input = document.createElement("input");
  input.value = originalValue;
  input.classList.add("edit-input");
  spanElement.replaceWith(input);
  input.focus();

  input.addEventListener("blur", () => saveEdit(input, field));
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") saveEdit(input, field);
  });
}

function saveEdit(inputElement, field) {
  const newValue = inputElement.value.trim();
  const span = document.createElement("span");
  span.classList.add("editable-field");
  span.setAttribute("ondblclick", `editField(this, '${field}')`);
  span.innerText = newValue;

  inputElement.replaceWith(span);

  const taskIndex = spanIndex;
  if (tasks[taskIndex]) {
    tasks[taskIndex][field] = newValue;
    saveTasks();
    filterTasks(document.getElementById("searchInput").value);
  }
}

function exportToJson() {
  let tasksData = [];

  if (currentUser === "all") {
    // G·ªôp d·ªØ li·ªáu c·ªßa t·∫•t c·∫£ ng∆∞·ªùi d√πng (t·ª± ƒë·ªông)
    tasksData = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith("tasks_") && key !== "tasks_all") {
        const data = JSON.parse(localStorage.getItem(key) || "[]");
        tasksData = tasksData.concat(data);
      }
    }
  } else {
    tasksData = JSON.parse(localStorage.getItem(`tasks_${currentUser}`) || "[]");
  }

  const blob = new Blob([JSON.stringify(tasksData, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);

  // üîπ T·∫°o t√™n file t·ª± ƒë·ªông theo ng∆∞·ªùi d√πng
  const fileName =
    currentUser === "all"
      ? "tasks_all.json"
      : `tasks_${currentUser}.json`;

  link.download = fileName;
  link.click();
  document.getElementById("exportModal").style.display = "none";

}


  </script>
  <script>
  flatpickr("#startDate", {
    dateFormat: "d/m/Y",
    onChange: filterTasks
  });

  flatpickr("#endDate", {
    dateFormat: "d/m/Y",
    onChange: filterTasks
  });
  document.getElementById("clearDateFilter").addEventListener("click", () => {
  // X√≥a gi√° tr·ªã 2 input ng√†y
  document.getElementById("startDate")._flatpickr.clear();  // D√πng Flatpickr API clear()
  document.getElementById("endDate")._flatpickr.clear();

  // G·ªçi l·∫°i h√†m l·ªçc ƒë·ªÉ hi·ªÉn th·ªã t·∫•t c·∫£
  filterTasks();
});

document.getElementById("prevPageBtn").addEventListener("click", () => {
  if (currentPage > 1) {
    currentPage--;
    filterTasks();
  }
});

document.getElementById("nextPageBtn").addEventListener("click", () => {
  currentPage++;
  filterTasks();
});
// update file Json
function handleJsonImport(event) {
  const file = event.target.files[0];
  if (!file) return;

  if (currentUser === "all") {
    showToast("‚ùå Kh√¥ng th·ªÉ nh·∫≠p d·ªØ li·ªáu trong ch·∫ø ƒë·ªô 'T·∫•t c·∫£'!");
    event.target.value = ""; // reset input
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) throw new Error("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá");

      // L·∫•y danh s√°ch hi·ªán t·∫°i c·ªßa ng∆∞·ªùi d√πng ƒëang ch·ªçn
      const currentTasks = JSON.parse(localStorage.getItem(`tasks_${currentUser}`) || "[]");
      const merged = [...currentTasks];

      // L·ªçc tr√πng (tr√πng task + note + date)
      data.forEach(task => {
        const exists = merged.some(
          t =>
            t.task === task.task &&
            t.note === task.note &&
            t.date === task.date
        );
        if (!exists) merged.push(task);
      });

     localStorage.setItem(`tasks_${currentUser}`, JSON.stringify(merged));
 showToast(`‚úÖ ƒê√£ nh·∫≠p d·ªØ li·ªáu cho ${currentUser} (${data.length} d√≤ng, ${merged.length - currentTasks.length} m·ªõi)`);
document.getElementById("exportModal").style.display = "none";

  // ƒê·ªìng b·ªô l·∫°i sau khi localStorage ghi xong
  setTimeout(() => {
  tasks = JSON.parse(localStorage.getItem(`tasks_${currentUser}`) || "[]");
  if (typeof filterTasks === "function") filterTasks();
  }, 0);


    } catch (err) {
      console.error(err);
      showToast("‚ùå L·ªói khi ƒë·ªçc file JSON!");
    }
  };
  reader.readAsText(file);
}


function isValidTask(task) {
  return task &&
         typeof task === "object" &&
         task.task &&
         task.status &&
         ["Ch∆∞a l√†m", "ƒêang l√†m", "Ho√†n th√†nh"].includes(task.status) &&
         task.date;
}

function generateTaskKey(task) {
  // ƒê·∫£m b·∫£o note lu√¥n l√† chu·ªói
  return `${task.task}|${task.note || ""}|${task.date}`;
}
</script>

<!-- Modal ƒëƒÉng nh·∫≠p -->
<div id="unlockModal" class="modal" style="display: block;background-color: rgba(0, 0, 0, 0.4); 
  backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);  z-index: 9999 ; margin-bottom: 100px;">
  <div style="margin: 8% auto; padding: 45px; background-color: #f2f2f2; border-radius: 16px; width: 300px; text-align: center;  border-color: red; ">
    <img src="anh_ngau.jpg" alt="avatar" style="width: 75px; height: 75px; border-radius: 50%; object-fit: cover; margin-bottom: 16px;">
    <h2 style="color: #080707; font-size: 20px; margin-bottom: 20px;">Hi·∫øu</h2>
    <input type="password" id="unlockInput" placeholder="Nh·∫≠p m√£ kh√≥a" style="width: 80%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: solid; font-size: 14px;">
    <button onclick="checkUnlockCode()" style="background-color: #dba334; color: rgb(10, 1, 1); padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">M·ªû</button>
    <p id="unlockError" style="color: red; display: none;">Sai m√£ kh√≥a!</p>
  </div>
</div>

<script>

  function lockScreen() {
    const modal = document.getElementById("unlockModal");
    modal.style.display = "block";
    document.getElementById("unlockInput").value = "";
    document.getElementById("unlockError").style.display = "none";
    // document.body.style.overflow = "hidden"; // Kho√° cu·ªôn
  }
  function checkUnlockCode() {
    const code = document.getElementById("unlockInput").value.trim();
    if (code === "78945607") {
      document.getElementById("unlockModal").style.display = "none";
    } else {
      document.getElementById("unlockError").style.display = "block";
    }
  }

  // C·∫•m thao t√°c b√™n ngo√†i khi ch∆∞a m·ªü kh√≥a
  document.addEventListener("DOMContentLoaded", () => {
    document.body.style.overflow = "hidden"; // ·∫®n cu·ªôn
    const interval = setInterval(() => {
      if (document.getElementById("unlockModal").style.display === "none") {
        document.body.style.overflow = "auto"; // M·ªü cu·ªôn
        clearInterval(interval);
      }
    }, 100);

    document.getElementById("unlockInput").addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        checkUnlockCode();
      }})
  });

  // üö´ Ch·∫∑n ESC khi modal ƒëang m·ªü
  document.addEventListener("keydown", function (event) {
    const modal = document.getElementById("unlockModal");
    if (modal && modal.style.display === "block" && event.key === "Escape") {
      event.preventDefault();
      event.stopPropagation();
    }
  });
  let inactivityTimer;
  // t·ª± ƒë·ªông kho√° m√†n h√¨nh sau 5p

function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    lockScreen();
  },  30* 60 * 1000); // 5 ph√∫t = 300.000 ms
}

// Theo d√µi c√°c ho·∫°t ƒë·ªông c·ªßa ng∆∞·ªùi d√πng
['mousemove', 'keydown', 'scroll', 'click'].forEach(event => {
  document.addEventListener(event, resetInactivityTimer);
});

// Kh·ªüi ƒë·ªông b·ªô ƒë·∫øm ngay khi trang load
document.addEventListener("DOMContentLoaded", resetInactivityTimer);

</script>
<script>

  

  function remindUnfinishedTasks() {
  const chuaLamDates = tasks
    .filter(task => (task.status || "").trim().toLowerCase() === "ch∆∞a l√†m")
    .map(task => task.date || "ch∆∞a r√µ ng√†y");

  const dangLamDates = tasks
    .filter(task => (task.status || "").trim().toLowerCase() === "ƒëang l√†m")
    .map(task => task.date || "ch∆∞a r√µ ng√†y");

  if (chuaLamDates.length > 0 || dangLamDates.length > 0) {
    let message = "üîî Ch√∫ √Ω:";

    if (chuaLamDates.length > 0) {
      const uniqueChuaLam = [...new Set(chuaLamDates)].join(", ");
      message += `\n ${chuaLamDates.length} c√¥ng vi·ªác ch∆∞a l√†m ng√†y ${uniqueChuaLam}`;
    }

    if (dangLamDates.length > 0) {
      const uniqueDangLam = [...new Set(dangLamDates)].join(", ");
      message += `\n ${dangLamDates.length} c√¥ng vi·ªác ƒëang l√†m ng√†y ${uniqueDangLam}`;
    }

    showToast(message);
    showSystemNotification("Nh·∫Øc nh·ªü c√¥ng vi·ªác", message);
    
  }
}



window.onload = () => {
  renderTable();
  remindUnfinishedTasks(); 
  // T·ª± ƒë·ªông nh·∫Øc sau m·ªói 60 gi√¢y
  setInterval(remindUnfinishedTasks, 6000000 ); // 60,000ms = 60s
};

</script>
<script>
function showWeatherModal() {
  const modal = document.getElementById("weatherModal");
  const content = document.getElementById("weatherContent");
  modal.style.display = "block";
  content.innerHTML = "ƒêang l·∫•y v·ªã tr√≠...";

  const API_KEY = "158d60200cbd4115b67e68cb32ad7561"; // thay b·∫±ng key ƒë√£ x√°c nh·∫≠n

  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&lang=vi&units=metric`)
          .then(res => res.json())
          .then(data => {
            const name = data.name;
            const country = data.sys.country;
            const temp = data.main.temp.toFixed(1);
            const humidity = data.main.humidity;
            const wind = data.wind.speed;
            const description = data.weather[0].description;

            content.innerHTML = `
              <p><strong>üìç ƒê·ªãa ƒëi·ªÉm:</strong> ${name}, ${country}</p>
              <p><strong>üå°Ô∏è Nhi·ªát ƒë·ªô:</strong> ${temp}¬∞C</p>
              <p><strong>üíß ƒê·ªô ·∫©m:</strong> ${humidity}%</p>
              <p><strong>üí® Gi√≥:</strong> ${wind} m/s</p>
              <p><strong>üå•Ô∏è Tr·∫°ng th√°i:</strong> ${description}</p>
            `;
          })
          .catch(err => {
            console.error(err);
            content.innerHTML = "Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt.";
          });
      },
      (error) => {
        console.warn(error);
        content.innerHTML = "Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠. H√£y cho ph√©p truy c·∫≠p v·ªã tr√≠ ƒë·ªÉ xem th·ªùi ti·∫øt.";
      }
    );
  } else {
    content.innerHTML = "Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.";
  }
}

function closeWeatherModal() {
  document.getElementById("weatherModal").style.display = "none";
}
// B·∫•m ESC ƒë·ªÉ t·∫Øt modal
document.addEventListener("keydown", function (event) {
  if (event.key === "Escape") {
    closeWeatherModal();
  }
});

</script>
<script>
let editingRepairIndex = -1;
let currentEditingIndex = -1;


let repairs = JSON.parse(localStorage.getItem("repairs")) || [];
let repairPage = 1;
const repairRowsPerPage = 5;
// s·ª≠a l√Ω chi ph√≠ ban ƒë·∫ßu
const chiphiInput = document.getElementById("chiphiInput");

chiphiInput.addEventListener("input", function (e) {
  const input = e.target;
  const rawValue = input.value;

  // Ghi l·∫°i v·ªã tr√≠ con tr·ªè tr∆∞·ªõc khi thay ƒë·ªïi
  const oldCursor = input.selectionStart;

  // L·∫•y t·∫•t c·∫£ ch·ªØ s·ªë
  const digits = rawValue.replace(/\D/g, "");

  if (!digits) {
    input.value = "";
    return;
  }

  // ƒê·ªãnh d·∫°ng d·∫•u ch·∫•m h√†ng ngh√¨n
  const formatted = digits.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

  // T√≠nh l·∫°i v·ªã tr√≠ con tr·ªè d·ª±a tr√™n s·ªë ch·ªØ s·ªë tr∆∞·ªõc con tr·ªè c≈©
  let digitCountBeforeCursor = 0;
  for (let i = 0; i < oldCursor; i++) {
    if (/\d/.test(rawValue[i])) digitCountBeforeCursor++;
  }

  // G√°n l·∫°i gi√° tr·ªã ƒë√£ ƒë·ªãnh d·∫°ng
  input.value = formatted;

  // T√¨m v·ªã tr√≠ m·ªõi t∆∞∆°ng ·ª©ng c·ªßa con tr·ªè
  let newCursor = 0;
  let digitSeen = 0;
  for (let i = 0; i < formatted.length; i++) {
    if (/\d/.test(formatted[i])) digitSeen++;
    if (digitSeen === digitCountBeforeCursor) {
      newCursor = i + 1;
      break;
    }
  }

  // C·∫≠p nh·∫≠t l·∫°i v·ªã tr√≠ con tr·ªè sau 1 tick
  setTimeout(() => {
    input.setSelectionRange(newCursor, newCursor);
  }, 0);
});


function showRepairModal() {
  document.getElementById("repairModal").style.display = "block";
  if (editingRepairIndex === -1) {
    repairPage = 1;
    renderRepairTable(); // ch·ªâ khi th√™m m·ªõi
  }
}

function closeRepairModal() {
  document.getElementById("repairModal").style.display = "none";
}

function addRepairRow() {
  const phutung = document.getElementById("phutungInput").value.trim();
  const diadiem = document.getElementById("diadiemInput").value.trim();
  const thoigian = document.getElementById("thoigianInput").value.trim();
  const chiphi = document.getElementById("chiphiInput").value.trim();

  function isValidDateFormat(dateStr) {
  const regex = /^(0?[1-9]|[12][0-9]|3[01])\/(0?[1-9]|1[0-2])\/\d{4}$/;
  return regex.test(dateStr);
  }


  if (!phutung || !diadiem || !thoigian || !chiphi) {
    alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
    return;
  }
  if (!isValidDateFormat(thoigian)) {
  alert("Vui l√≤ng nh·∫≠p ƒë√∫ng ƒë·ªãnh d·∫°ng ng√†y: dd/mm/yyyy");
  return;
  } 

  const parsedChiPhi = parseInt(chiphi.replace(/\./g, ""));

if (editingRepairIndex >= 0) {
  // S·ª¨A
  repairs[editingRepairIndex] = {
    phutung,
    diadiem,
    thoigian,
    chiphi: parsedChiPhi
  };
  showToast("‚úèÔ∏è ƒê√£ s·ª≠a th√¥ng tin! ");
  editingRepairIndex = -1;
} else {
  // TH√äM M·ªöI
  repairs.unshift({
    phutung,
    diadiem,
    thoigian,
    chiphi: parsedChiPhi
  });
  repairPage = 1;
  showToast("‚úÖ ƒê√£ th√™m m·ªõi th√¥ng tin!");
}


  saveRepairs();
  repairPage = 1;
  renderRepairTable();

  // Reset input
  document.getElementById("phutungInput").value = "";
  document.getElementById("diadiemInput").value = "";
  document.getElementById("thoigianInput").value = "";
  document.getElementById("chiphiInput").value = "";
}

function renderRepairTable() {
  const tbody = document.getElementById("repairTableBody");
  tbody.innerHTML = "";

  const searchInput = document.getElementById("repairSearchInput");
  const searchText = (searchInput?.value || "").toLowerCase();

  const filteredRepairs = repairs.filter(item => {
    const pt = item.phutung?.toLowerCase() || "";
    const dd = item.diadiem?.toLowerCase() || "";
    const tg = item.thoigian?.toLowerCase() || "";
    const cp = item.chiphi?.toString() || "";
    return (
      pt.includes(searchText) ||
      dd.includes(searchText) ||
      tg.includes(searchText) ||
      cp.includes(searchText)
    );
  });

  filteredRepairs.sort((a, b) => {
  const [d1, m1, y1] = a.thoigian.split("/").map(Number);
  const [d2, m2, y2] = b.thoigian.split("/").map(Number);

  const dateA = new Date(y1, m1 - 1, d1);
  const dateB = new Date(y2, m2 - 1, d2);

  return dateB - dateA; // m·ªõi nh·∫•t l√™n ƒë·∫ßu
});


  // ‚úÖ T√≠nh t·ªïng chi ph√≠ t·ª´ to√†n b·ªô d√≤ng ƒë√£ l·ªçc (kh√¥ng gi·ªõi h·∫°n theo trang)
  const total = filteredRepairs.reduce((sum, item) => sum + item.chiphi, 0);

  const startIndex = (repairPage - 1) * repairRowsPerPage;
  const endIndex = startIndex + repairRowsPerPage;
  const paginatedRepairs = filteredRepairs.slice(startIndex, endIndex);

  paginatedRepairs.forEach((item, displayIndex) => {
    const row = document.createElement("tr");

    const originalIndex = repairs.findIndex(r =>
      r.phutung === item.phutung &&
      r.diadiem === item.diadiem &&
      r.thoigian === item.thoigian &&
      r.chiphi === item.chiphi
    );
      row.addEventListener("contextmenu", function (e) {
  e.preventDefault(); // ‚úÖ NgƒÉn menu chu·ªôt ph·∫£i
  editRepair(originalIndex); // ‚úÖ G·ªçi s·ª≠a
});

row.addEventListener("dblclick", function () {
  confirmDelete1(originalIndex); // ‚úÖ G·ªçi xo√°
});

    row.setAttribute("onmouseover", "this.style.backgroundColor='#fff8b3'");
    row.setAttribute("onmouseout", "this.style.backgroundColor=''");

    row.innerHTML = `
      <td>${startIndex + displayIndex + 1}</td>
      <td>${item.phutung}</td>
      <td>${item.diadiem}</td>
      <td>${item.thoigian}</td>
      <td>${item.chiphi.toLocaleString("vi-VN")} VND</td>
    `;

    tbody.appendChild(row);
  });

  // ‚úÖ Hi·ªÉn th·ªã t·ªïng sau khi render
  document.getElementById("totalCost").textContent = `T·ªïng chi ph√≠: ${total.toLocaleString("vi-VN")} VND`;

  renderRepairPagination(filteredRepairs.length);

}


function renderRepairPagination(totalItems) {
  const pageCount = Math.ceil(totalItems / repairRowsPerPage);
  const container = document.getElementById("repairPagination");
  container.innerHTML = "";

  if (pageCount <= 1) return;

  const createButton = (text, page, disabled = false, active = false) => {
    const btn = document.createElement("button");
    btn.textContent = text;
    btn.disabled = disabled;
    if (active) btn.className = "active-page";
    btn.onclick = () => {
      repairPage = page;
      renderRepairTable();
    };
    container.appendChild(btn);
  };

  // M≈©i t√™n ƒëi·ªÅu h∆∞·ªõng
  createButton("¬´", 1, repairPage === 1);
  createButton("<", repairPage - 1, repairPage === 1);

  // Hi·ªÉn th·ªã d√£y s·ªë trang g·∫ßn trang hi·ªán t·∫°i
  const visibleRange = 2;
  let start = Math.max(1, repairPage - visibleRange);
  let end = Math.min(pageCount, repairPage + visibleRange);

  if (repairPage <= visibleRange) {
    end = Math.min(pageCount, end + (visibleRange - repairPage + 1));
  }

  if (repairPage >= pageCount - visibleRange + 1) {
    start = Math.max(1, start - (repairPage - (pageCount - visibleRange)));
  }

  for (let i = start; i <= end; i++) {
    createButton(i, i, false, i === repairPage);
  }

  createButton(">", repairPage + 1, repairPage === pageCount);
  createButton("¬ª", pageCount, repairPage === pageCount);
}


function confirmDelete1(index) {
  const item = repairs[index];
  const message = `B·∫°n c√≥ ch·∫Øc mu·ªën xo√° d√≤ng sau?\n- Ph·ª• t√πng: ${item.phutung}\n- Chi ph√≠: ${item.chiphi.toLocaleString("vi-VN")} VND`;

  showConfirmModal(message, () => {
    repairs.splice(index, 1);
    showToast("üóëÔ∏è ƒê√£ xo√° ph·ª• t√πng s·ª≠a ch·ªØa");

    saveRepairs();
    if ((repairPage - 1) * repairRowsPerPage >= repairs.length) {
      repairPage = Math.max(1, repairPage - 1);
    }
    renderRepairTable();
  });
}

function editRepair(index) {
  const item = repairs[index];
  currentEditingIndex = index;

  // ‚úÖ G√°n v√†o c√°c input c·ªßa modal s·ª≠a (editRepairModal)
  document.getElementById("editPhutungInput").value = item.phutung;
  document.getElementById("editDiadiemInput").value = item.diadiem;
  document.getElementById("editThoigianInput").value = item.thoigian;
  document.getElementById("editChiphiInput").value = item.chiphi.toLocaleString("vi-VN");

  showEditRepairModal();
}

function showEditRepairModal() {
  const modal = document.getElementById("editRepairModal");
  if (modal) modal.style.display = "block";
}




function saveRepairs() {
  localStorage.setItem("repairs", JSON.stringify(repairs));
}

function downloadBackupFile(data, filename = "repair-backup.json") {
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  
  URL.revokeObjectURL(url); // Gi·∫£i ph√≥ng b·ªô nh·ªõ
}


// ƒê√≥ng b·∫±ng ESC
document.addEventListener("keydown", function (event) {
  if (event.key === "Escape") {
    closeRepairModal();
  }
});

// x√≥a t·∫•t c·∫£
document.getElementById("clearAllRepairsBtn").addEventListener("click", function () {
  if (repairs.length === 0) {
    alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xo√°.");
    return;
  }

  showConfirmModal("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° to√†n b·ªô d·ªØ li·ªáu s·ª≠a ch·ªØa?", () => {
  if (repairs.length > 0) {
    const now = new Date();
    const timestamp = now.toISOString().replace(/[:.]/g, "-");
    const filename = `repair-backup-${timestamp}.json`;
    downloadBackupFile(repairs, filename);
  }

  repairs = [];
  saveRepairs();
  renderRepairTable();
  showToast("üóëÔ∏è ƒê√£ xo√° to√†n b·ªô & l∆∞u file backup");
});

});



// th√™m modal
let confirmAction = null;

function showConfirmModal(message, onConfirm) {
  document.getElementById("confirmMessage").textContent = message;
  document.getElementById("confirmModal").style.display = "flex";
  confirmAction = onConfirm;
}

document.getElementById("confirmYes").addEventListener("click", function () {
  if (typeof confirmAction === "function") confirmAction();
  document.getElementById("confirmModal").style.display = "none";
});

document.getElementById("confirmNo").addEventListener("click", function () {
  document.getElementById("confirmModal").style.display = "none";
});

// input d·ªØ li·ªáu
function handleRepairJsonImport(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function (e) {
    try {
      const importedData = JSON.parse(e.target.result);

      if (!Array.isArray(importedData)) {
        showToast("‚ùå D·ªØ li·ªáu kh√¥ng ph·∫£i l√† danh s√°ch s·ª≠a ch·ªØa!");
        return;
      }

      const MAX_IMPORT = 1000;
      if (importedData.length > MAX_IMPORT) {
        showToast(`‚ö†Ô∏è File c√≥ qu√° nhi·ªÅu d√≤ng (${importedData.length}). Gi·ªõi h·∫°n l√† ${MAX_IMPORT}.`);
        return;
      }

      const currentRepairs = JSON.parse(localStorage.getItem("repairs") || "[]");

      // X√°c ƒë·ªãnh key duy nh·∫•t ƒë·ªÉ ki·ªÉm tra tr√πng
      const generateRepairKey = (r) =>
        `${r.phutung}-${r.diadiem}-${r.thoigian}-${r.chiphi}`;

      const existingKeys = new Set(currentRepairs.map(generateRepairKey));

      const newRepairs = importedData
        .filter(r =>
          r &&
          typeof r.phutung === "string" &&
          typeof r.diadiem === "string" &&
          typeof r.thoigian === "string" &&
          typeof r.chiphi === "number"
        )
        .filter(r => !existingKeys.has(generateRepairKey(r)));

      if (newRepairs.length === 0) {
        showToast("‚ÑπÔ∏è Kh√¥ng c√≥ d√≤ng m·ªõi n√†o ƒë∆∞·ª£c th√™m (to√†n b·ªô ƒë√£ t·ªìn t·∫°i ho·∫∑c sai ƒë·ªãnh d·∫°ng).");
        return;
      }

      const updatedRepairs = currentRepairs.concat(newRepairs);
      localStorage.setItem("repairs", JSON.stringify(updatedRepairs));

      showToast(`‚úÖ ƒê√£ th√™m ${newRepairs.length} d√≤ng (b·ªè qua ${importedData.length - newRepairs.length} d√≤ng tr√πng ho·∫∑c sai ƒë·ªãnh d·∫°ng)`);

      setTimeout(() => location.reload(), 2000);

    } catch (err) {
      showToast("‚ùå Kh√¥ng th·ªÉ ƒë·ªçc file JSON! C√≥ th·ªÉ file b·ªã h·ªèng ho·∫∑c sai c√∫ ph√°p.");
      console.error("L·ªói ƒë·ªçc file s·ª≠a ch·ªØa:", err);
    }
  };

  reader.readAsText(file);
}
function saveEditedRepair() {
  const pt = document.getElementById("editPhutungInput").value.trim();
  const dd = document.getElementById("editDiadiemInput").value.trim();
  const tg = document.getElementById("editThoigianInput").value.trim();
  const cp = document.getElementById("editChiphiInput").value.trim();

  const parsedCost = parseInt(cp.replace(/\./g, ""));
  const dateRegex = /^(0?[1-9]|[12][0-9]|3[01])\/(0?[1-9]|1[0-2])\/\d{4}$/;

  if (!pt || !dd || !tg || !cp) {
    alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
    return;
  }

  if (!dateRegex.test(tg)) {
    alert("Sai ƒë·ªãnh d·∫°ng ng√†y. D√πng dd/mm/yyyy.");
    return;
  }

  repairs[currentEditingIndex] = {
    phutung: pt,
    diadiem: dd,
    thoigian: tg,
    chiphi: parsedCost,
  };

  saveRepairs();
  renderRepairTable();
  closeEditRepairModal();
}

function closeEditRepairModal() {
  document.getElementById("editRepairModal").style.display = "none";
  currentEditingIndex = -1;
}
const editChiPhiInput = document.getElementById("editChiphiInput");
if (editChiPhiInput) {
  editChiPhiInput.addEventListener("input", function (e) {
    const input = e.target;
    const rawValue = input.value;
    const digits = rawValue.replace(/\D/g, "");
    if (!digits) return input.value = "";

    const formatted = digits.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    input.value = formatted;
  });
}
</script>
<script>
  let cheDoSuaGhiChu = false;

function moModalGhiChu() {
  const textarea = document.getElementById("noiDungGhiChu");
  const daLuu = localStorage.getItem("ghiChu") || "";
  const thoiGianLuu = localStorage.getItem("ghiChu_lastSaved");

  textarea.value = daLuu;
  textarea.setAttribute("readonly", true);
  textarea.classList.add("readonly-field");
  cheDoSuaGhiChu = false;

  document.getElementById("btnSuaGhiChu").textContent = "‚úèÔ∏è S·ª≠a";
  document.getElementById("modalGhiChu").style.display = "flex";

  capNhatThoiGianLuu(thoiGianLuu);
}

function dongModalGhiChu() {
  document.getElementById("modalGhiChu").style.display = "none";
}

function batCheDoSuaGhiChu() {
  const textarea = document.getElementById("noiDungGhiChu");

  if (!cheDoSuaGhiChu) {
    // Chuy·ªÉn sang ch·∫ø ƒë·ªô s·ª≠a
    textarea.removeAttribute("readonly");
    textarea.classList.remove("readonly-field");
    textarea.focus();
    cheDoSuaGhiChu = true;
    document.getElementById("btnSuaGhiChu").textContent = "üíæ L∆∞u";
  } else {
    // L∆∞u n·ªôi dung ghi ch√∫
    const noiDung = textarea.value.trim();
    localStorage.setItem("ghiChu", noiDung);

    // L∆∞u th·ªùi gian
    const thoiGianHienTai = new Date().toLocaleString("vi-VN");
    localStorage.setItem("ghiChu_lastSaved", thoiGianHienTai);
    capNhatThoiGianLuu(thoiGianHienTai);

    textarea.setAttribute("readonly", true);
    textarea.classList.add("readonly-field");
    cheDoSuaGhiChu = false;
    document.getElementById("btnSuaGhiChu").textContent = "‚úèÔ∏è S·ª≠a";

    // Hi·ªáu ·ª©ng highlight khi l∆∞u
    textarea.classList.add("highlight-save");
    setTimeout(() => textarea.classList.remove("highlight-save"), 500);

    showToast("‚úÖ Ghi ch√∫ ƒë√£ ƒë∆∞·ª£c l∆∞u.");
  }
}

function capNhatThoiGianLuu(thoiGian) {
  const lbl = document.getElementById("thoiGianLuu");
  if (thoiGian) {
    lbl.textContent = `üïí L·∫ßn l∆∞u g·∫ßn nh·∫•t: ${thoiGian}`;
  } else {
    lbl.textContent = "üïí Ch∆∞a c√≥ l·∫ßn l∆∞u n√†o";
  }
}
// ƒê√≥ng modal khi b·∫•m ph√≠m ESC
document.addEventListener("keydown", function (event) {
  // Ki·ªÉm tra modal ƒëang m·ªü
  const modal = document.getElementById("modalGhiChu");
  if (event.key === "Escape" && modal.style.display === "flex") {
    dongModalGhiChu();
  }
});



</script>
<!-- --- USER SWITCH SCRIPT: start --- -->
<script>
 currentUser = localStorage.getItem("currentUser") || "nhi";

// Chuy·ªÉn d·ªØ li·ªáu c≈© sang Nhi n·∫øu c√≥
if (localStorage.getItem("tasks") && !localStorage.getItem("tasks_nhi")) {
  localStorage.setItem("tasks_nhi", localStorage.getItem("tasks"));
  localStorage.removeItem("tasks");
}

// --- H√†m n·∫°p d·ªØ li·ªáu theo ng∆∞·ªùi d√πng ---
function getTasksByUser(user) {
  if (user === "all") {
    const nhi = JSON.parse(localStorage.getItem("tasks_nhi") || "[]");
    const quan = JSON.parse(localStorage.getItem("tasks_quan") || "[]");
    return [...nhi, ...quan];
  } else {
    return JSON.parse(localStorage.getItem("tasks_" + user) || "[]");
  }
}

function loadUserTasks() {
  tasks = getTasksByUser(currentUser);
  if (typeof filterTasks === "function") filterTasks();
}

// --- Ghi d·ªØ li·ªáu ---
function saveToLocalStorage() {
  if (currentUser === "all") return;
  localStorage.setItem("tasks_" + currentUser, JSON.stringify(tasks));
}

// --- Chuy·ªÉn ng∆∞·ªùi d√πng ---
function changeUser() {
  const select = document.getElementById("userSelect");
  if (!select) return;

  currentUser = select.value;
  localStorage.setItem("currentUser", currentUser);
  // Reset v·ªÅ trang ƒë·∫ßu (n·∫øu c√≥ ph√¢n trang)
  currentPage = 1;

  // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
  filterTasks();
  updateUIForUser();

  // üîπ C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t "Th√™m"
  const addBtn = document.getElementById("addBtn"); // ƒë√∫ng id trong file c·ªßa b·∫°n
  if (addBtn) {
    const disable = currentUser === "all";
    addBtn.disabled = disable;
    addBtn.style.opacity = disable ? "0.6" : "1";
    addBtn.style.cursor = disable ? "not-allowed" : "pointer";
  }

  // üîπ (T√πy ch·ªçn) c·∫≠p nh·∫≠t c√°c n√∫t kh√°c
  const clearBtn = document.getElementById("clearBtn");
  if (clearBtn) clearBtn.disabled = currentUser === "all";
  const importInput = document.getElementById("importJsonInput");
  if (importInput) importInput.disabled = currentUser === "all";

  showToast(`ƒê√£ chuy·ªÉn sang: ${currentUser === "all" ? "T·∫•t c·∫£" : currentUser}`);
  loadUserTasks();

}


// --- B·∫£o v·ªá khi ·ªü ch·∫ø ƒë·ªô t·∫•t c·∫£ ---
function editableCheck() {
  if (currentUser === "all") {
    showToast("‚ùå Ch·∫ø ƒë·ªô 'T·∫•t c·∫£' ch·ªâ xem - kh√¥ng th·ªÉ ch·ªânh s·ª≠a.");
    closeModal('confirmDeleteModal');
    return false;
  }
  return true;
}

// --- Ghi ƒë√® c√°c h√†m th√™m / s·ª≠a / x√≥a ƒë·ªÉ ki·ªÉm tra ng∆∞·ªùi d√πng ---
const origAddTask = typeof addTask === "function" ? addTask : null;
if (origAddTask) {
  addTask = function() {
    if (!editableCheck()) return;
    origAddTask();
  };
}

if (typeof toggleEditTask === "function") {
  const orig = toggleEditTask;
  toggleEditTask = function() {
    if (!editableCheck()) return;
    orig();
  };
}

if (typeof confirmDelete === "function") {
  const orig = confirmDelete;
  confirmDelete = function() {
    if (!editableCheck()) return;
    orig();
  };
}

// --- C·∫≠p nh·∫≠t khi trang t·∫£i ---
document.addEventListener("DOMContentLoaded", () => {
  const select = document.getElementById("userSelect");
  if (select) select.value = currentUser;
  document.getElementById("addBtn").disabled = (currentUser === "all");
  loadUserTasks();
});
</script>
<!-- --- USER SWITCH SCRIPT: end --- -->
<script>
  // --- QU·∫¢N L√ù NG∆Ø·ªúI D√ôNG ƒê·ªòNG ---
let currentUser = localStorage.getItem("currentUser") || "nhi";

// Kh·ªüi t·∫°o danh s√°ch ng∆∞·ªùi d√πng m·∫∑c ƒë·ªãnh
function loadUsers() {
  let users = JSON.parse(localStorage.getItem("users")) || ["nhi", "quan", "all"];
  const select = document.getElementById("userSelect");
  select.innerHTML = "";

  // T·∫°o c√°c option t·ª´ danh s√°ch
  users.forEach(u => {
    const opt = document.createElement("option");
    opt.value = u;
    opt.textContent = (u === "nhi") ? "Ms Nhi" :
                      (u === "quan") ? "Mr Quan" :
                      (u === "all") ? "T·∫•t c·∫£" : u;
    select.appendChild(opt);
  });

  // Th√™m option ƒë·∫∑c bi·ªát ƒë·ªÉ th√™m user m·ªõi
  const addOpt = document.createElement("option");
  addOpt.value = "__add_new__";
  addOpt.textContent = "‚ûï Th√™m ng∆∞·ªùi d√πng m·ªõi";
  select.appendChild(addOpt);

  // Ch·ªçn l·∫°i ng∆∞·ªùi d√πng hi·ªán t·∫°i
  select.value = currentUser;
}

// Khi ƒë·ªïi ng∆∞·ªùi d√πng
function changeUser() {
  const select = document.getElementById("userSelect");
  const value = select.value;

  if (value === "__add_new__") {
    // N·∫øu ch·ªçn "Th√™m ng∆∞·ªùi d√πng m·ªõi"
    select.value = currentUser;
    document.getElementById("addUserModal").style.display = "block";
    document.getElementById("newUserName").value = "";
    return;
  }

  currentUser = value;
  localStorage.setItem("currentUser", currentUser);

  // üîπ L·∫•y d·ªØ li·ªáu ƒë√∫ng theo user
  if (currentUser === "all") {
    const users = JSON.parse(localStorage.getItem("users")) || [];
    let allTasks = [];
    users.forEach(u => {
      if (u !== "all") {
        const data = JSON.parse(localStorage.getItem(`tasks_${u}`) || "[]");
        allTasks = allTasks.concat(data);
      }
    });
    tasks = allTasks;
  } else {
    tasks = JSON.parse(localStorage.getItem(`tasks_${currentUser}`) || "[]");
  }

  // C·∫≠p nh·∫≠t giao di·ªán danh s√°ch
  currentPage = 1;
  filterTasks();

  // üîπ C·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t thao t√°c
  const addBtn = document.getElementById("addBtn");
  if (addBtn) {
    const disable = currentUser === "all";
    addBtn.disabled = disable;
    addBtn.style.opacity = disable ? "0.6" : "1";
    addBtn.style.cursor = disable ? "not-allowed" : "pointer";
  }

  const clearBtn = document.getElementById("clearBtn");
  if (clearBtn) clearBtn.disabled = currentUser === "all";
  const importInput = document.getElementById("importJsonInput");
  if (importInput) importInput.disabled = currentUser === "all";

  // üîπ Hi·ªÉn th·ªã th√¥ng b√°o
  showToast(`üë§ ƒê√£ chuy·ªÉn sang ng∆∞·ªùi d√πng: ${currentUser === "all" ? "T·∫•t c·∫£" : currentUser}`);
}


// Th√™m ng∆∞·ªùi d√πng m·ªõi
function addNewUser() {
  const name = document.getElementById("newUserName").value.trim();
  if (!name) {
    showToast("Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi d√πng!");
    return;
  }

  // L·∫•y danh s√°ch user t·ª´ localStorage
  let users = JSON.parse(localStorage.getItem("users")) || ["nhi", "quan", "all"];
  if (users.includes(name)) {
    showToast("T√™n ng∆∞·ªùi d√πng ƒë√£ t·ªìn t·∫°i!");
    return;
  }

  // L∆∞u user m·ªõi v√†o danh s√°ch
  users.push(name);
  localStorage.setItem("users", JSON.stringify(users));
  localStorage.setItem(`tasks_${name}`, JSON.stringify([]));

  // Th√™m v√†o dropdown
  const select = document.getElementById("userSelect");
  const option = document.createElement("option");
  option.value = name;
  option.textContent = name.charAt(0).toUpperCase() + name.slice(1);
  const allOption = select.querySelector("option[value='all']");
  if (allOption) select.insertBefore(option, allOption);
  else select.appendChild(option);

  // Chuy·ªÉn sang ng∆∞·ªùi m·ªõi
  currentUser = name;
  localStorage.setItem("currentUser", currentUser);

  // Reset d·ªØ li·ªáu tr√°nh d√≠nh d·ªØ li·ªáu c≈©
  tasks = [];
  saveToLocalStorage();

  // C·∫≠p nh·∫≠t UI
  select.value = name;
  changeUser();
  
  document.getElementById("newUserName").value = "";
  closeModal("addUserModal");
  currentPage = 1;
  filterTasks();

  showToast(`‚úÖ ƒê√£ th√™m ng∆∞·ªùi d√πng "${name}" v√† chuy·ªÉn sang ng∆∞·ªùi n√†y.`);
}


// X√≥a ng∆∞·ªùi d√πng hi·ªán t·∫°i
function deleteCurrentUser() {
  if (currentUser === "all") {
  showToast("‚ö†Ô∏è Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi d√πng 'T·∫•t c·∫£' v√¨ ƒë√¢y l√† ch·∫ø ƒë·ªô t·ªïng h·ª£p d·ªØ li·ªáu!");
  return;
  }

  if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng "${currentUser}" v√† to√†n b·ªô d·ªØ li·ªáu c·ªßa h·ªç kh√¥ng?`))
    return;

  let users = JSON.parse(localStorage.getItem("users")) || [];
  users = users.filter(u => u !== currentUser);
  localStorage.setItem("users", JSON.stringify(users));

  localStorage.removeItem(`tasks_${currentUser}`);

  showToast(`üóëÔ∏è ƒê√£ x√≥a ng∆∞·ªùi d√πng: ${currentUser}`);

  currentUser = "all";
  localStorage.setItem("currentUser", currentUser);

  closeModal("addUserModal");
  loadUsers();
  changeUser();
}

// --- G·ªçi khi load trang ---
document.addEventListener("DOMContentLoaded", loadUsers);

</script>
<script>
 // üì¢ Th√¥ng b√°o ngo√†i m√†n h√¨nh (c√≥ t∆∞∆°ng t√°c khi nh·∫•p)
function showSystemNotification(title, message, type = "info") {
  if (!("Notification" in window)) return;

  // üé® Bi·ªÉu t∆∞·ª£ng & √¢m thanh theo lo·∫°i
  const icons = {
    info: "https://cdn-icons-png.flaticon.com/512/906/906343.png",
    success: "https://cdn-icons-png.flaticon.com/512/190/190411.png",
    warning: "https://cdn-icons-png.flaticon.com/512/595/595067.png",
    error: "https://cdn-icons-png.flaticon.com/512/564/564619.png",
    task: "https://cdn-icons-png.flaticon.com/512/1828/1828817.png"
  };

  

  const icon = icons[type] || icons.info;
  

  // ‚úÖ N·∫øu c√≥ quy·ªÅn th√¨ hi·ªÉn th·ªã lu√¥n
  if (Notification.permission === "granted") {
    const noti = new Notification("‚ö†Ô∏è " + title, {
      body: message,
      icon: icon,
      badge: icon,
      silent: false,
      requireInteraction: true // gi·ªØ l·∫°i ƒë·∫øn khi b·∫•m ho·∫∑c ƒë√≥ng
    });

   

    // ‚è∞ T·ª± ƒë√≥ng sau 10 gi√¢y
    //setTimeout(() => noti.close(), 10000);

    // üñ±Ô∏è Khi ng∆∞·ªùi d√πng nh·∫•p v√†o th√¥ng b√°o
    noti.onclick = function (event) {
      event.preventDefault();
      // M·ªü ho·∫∑c chuy·ªÉn sang ph·∫ßn m·ªÅm (tab ch√≠nh)
      window.focus(); // ƒë∆∞a tab hi·ªán t·∫°i ra tr∆∞·ªõc
      window.location.href = "index_with_users_plus.html"; // ho·∫∑c ƒë∆∞·ªùng d·∫´n kh√°c c·ªßa ph·∫ßn m·ªÅm
      noti.close();
    };
  }

  // üö™ N·∫øu ch∆∞a xin quy·ªÅn
  else if (Notification.permission !== "denied") {
    Notification.requestPermission().then(permission => {
      if (permission === "granted") {
        showSystemNotification(title, message, type);
      }
    });
  }
}
</script>

<!-- Auto-sync to Firestore (injected by assistant) -->
<script type="module">
  import { setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  //const db = window.db;

  // Simple toast helper (uses existing showToast if present, otherwise fallback)
  function tinyToast(msg) {
    try { if (typeof showToast === 'function') return showToast(msg); } catch(e){}
    // fallback small temporary toast
    const c = document.getElementById('toastContainer') || document.body;
    const t = document.createElement('div');
    t.style = "position:fixed;right:20px;bottom:20px;background:#2e7d32;color:#fff;padding:8px 12px;border-radius:6px;z-index:99999;box-shadow:0 3px 8px rgba(0,0,0,0.2);font-size:13px";
    t.innerText = msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),3000);
  }

  let dataChanged = false;
  let syncInProgress = false;

  // mark changed
  function dataChangedFlagSet(){
    dataChanged = true;
    tryAutoSync();
  }

  // Try to auto sync if online
  function tryAutoSync(){
    if (navigator.onLine && dataChanged && !syncInProgress) {
      syncToFirestoreAll();
    }
  }

  // Override localStorage.setItem to mark changes (non-destructive)
  (function(){
    const origSet = localStorage.setItem.bind(localStorage);
    localStorage.setItem = function(k,v){
      origSet(k,v);
      if (k.startsWith('tasks_') || k === 'repairs' || k === 'notes' || k === 'noiDungGhiChu') {
        dataChangedFlagSet();
      }
      return true;
    };
  })();

  // Core: delete doc then set doc for each user document
  async function syncToFirestoreAll(){
    if (!db) {
      console.warn('Firestore not initialized');
      return;
    }
    if (syncInProgress) return;
    syncInProgress = true;
    tinyToast('üîÑ ƒê·ªìng b·ªô Firebase...');

    try {
      // collect all users from localStorage keys tasks_*
      const users = [];
      for (let i=0;i<localStorage.length;i++){
        const key = localStorage.key(i);
        if (key && key.startsWith('tasks_')) {
          users.push(key.replace('tasks_',''));
        }
      }
      // make unique
      const uniqUsers = Array.from(new Set(users));
      for (const username of uniqUsers) {
        const tasks = JSON.parse(localStorage.getItem('tasks_'+username) || '[]');
        const repairs = JSON.parse(localStorage.getItem('repairs') || '[]');
        // notes: prefer the big notes area 'noiDungGhiChu' if present, else 'notes' key
        const notes = localStorage.getItem('noiDungGhiChu') || localStorage.getItem('notes') || '';

        // Delete existing doc (best-effort) then set new
        try { await deleteDoc(doc(db, 'users', username)); } catch(e) { /* ignore */ }
        await setDoc(doc(db, 'users', username), {
          username,
          tasks,
          repairs,
          notes,
          lastSync: new Date().toISOString()
        });
      }

      tinyToast('‚úÖ ƒê·ªìng b·ªô Firebase th√†nh c√¥ng');
      dataChanged = false;
    } catch (err) {
      console.error('Sync error', err);
      tinyToast('‚ö†Ô∏è L·ªói ƒë·ªìng b·ªô Firebase');
    } finally {
      syncInProgress = false;
    }
  }

  // sync on online event and on load if online
  window.addEventListener('online', tryAutoSync);
  window.addEventListener('load', () => { tryAutoSync(); });

  // expose for manual control if needed
  window.syncToFirestoreAll = syncToFirestoreAll;
  window.dataChangedFlagSet = dataChangedFlagSet;
</script>
<!-- End auto-sync module -->


<!-- Two-way Firestore sync injected by assistant -->
<script type="module">
  import { getDocs, collection, onSnapshot, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const db = window.db;
  if (db) {
    let remoteApplying = false;
    let dataChanged = false;
    let syncTimer = null;
    const SYNC_DEBOUNCE_MS = 1200;

    function tinyShowToast(msg) {
      try { if (typeof showToast === 'function') { showToast(msg); return; } } catch(e) {}
      const c = document.getElementById('toastContainer') || document.body;
      const t = document.createElement('div');
      t.style = "position:fixed;right:20px;bottom:20px;background:#2e7d32;color:#fff;padding:8px 12px;border-radius:6px;z-index:99999;box-shadow:0 3px 8px rgba(0,0,0,0.2);font-size:13px";
      t.innerText = msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),3000);
    }

    function markDataChanged() {
      dataChanged = true;
      scheduleSync();
    }

    function scheduleSync() {
      if (!navigator.onLine) return;
      if (syncTimer) clearTimeout(syncTimer);
      syncTimer = setTimeout(() => {
        syncTimer = null;
        performFullUpload();
      }, SYNC_DEBOUNCE_MS);
    }

    (function(){
      try {
        const origSet = localStorage.setItem.bind(localStorage);
        localStorage.setItem = function(k,v){
          origSet(k,v);
          if (k && (k.startsWith('tasks_') || k === 'repairs' || k === 'notes' || k === 'noiDungGhiChu')) {
            markDataChanged();
          }
          return true;
        };
      } catch(e) {}
    })();

    async function loadAllFromFirebase() {
      if (!navigator.onLine) return;
      try {
        const colRef = collection(db, 'users');
        const snap = await getDocs(colRef);
        remoteApplying = true;
        snap.forEach(docSnap => {
          const data = docSnap.data() || {};
          const username = (data.username || docSnap.id || 'unknown').toString();
          try { localStorage.setItem(`tasks_${username}`, JSON.stringify(data.tasks || [])); } catch(e){}
        });
        tinyShowToast('‚òÅÔ∏è ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ Firebase');
        remoteApplying = false;
      } catch(e) { remoteApplying = false; }
    }

    let unsub = null;
    function subscribeAllUsersRealtime() {
      if (!navigator.onLine) return;
      try {
        if (unsub) { try { unsub(); } catch(e){} unsub = null; }
        const colRef = collection(db, 'users');
        unsub = onSnapshot(colRef, { includeMetadataChanges: false }, (querySnapshot) => {
         remoteApplying = true; // B·∫Øt ƒë·∫ßu √°p d·ª•ng d·ªØ li·ªáu remote
          let changed = false;
         querySnapshot.docChanges().forEach(change => {
         const id = change.doc.id;
        const data = change.doc.data() || {};
      const current = localStorage.getItem(`tasks_${id}`);
  const newVal = JSON.stringify(data.tasks || []);
  // Ch·ªâ ghi v√†o localStorage n·∫øu th·ª±c s·ª± kh√°c, tr√°nh trigger v√≤ng l·∫∑p
  if (current !== newVal) {
    localStorage.setItem(`tasks_${id}`, newVal);
    changed = true;
  }
});
if (changed) tinyShowToast('üîÅ Firebase c·∫≠p nh·∫≠t t·ª± ƒë·ªông');
remoteApplying = false;

        }, (err)=>{});
      } catch(e) {}
    }

    async function performFullUpload() {
      if (!navigator.onLine) return;
      if (remoteApplying) return;
      if (!dataChanged) return;
      dataChanged = false;
      try {
        const users = [];
        for (let i=0;i<localStorage.length;i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('tasks_')) {
            const username = key.replace('tasks_','');
            users.push(username);
          }
        }
        for (const username of users) {
          try {
            const tasks = JSON.parse(localStorage.getItem(`tasks_${username}`) || '[]');
            const repairs = JSON.parse(localStorage.getItem('repairs') || '[]');
            const notes = localStorage.getItem('noiDungGhiChu') || localStorage.getItem('notes') || '';
            const ref = doc(db, 'users', username);
            const existingSnap = await getDoc(ref);
            const existing = existingSnap.exists() ? existingSnap.data() : {};
            if (JSON.stringify(existing.tasks) !== JSON.stringify(tasks)) {
            await setDoc(ref, { username, tasks, repairs, notes, lastSync: new Date().toISOString() });
            }

          } catch(e) {}
        }
        tinyShowToast('‚úÖ ƒê·ªìng b·ªô Firebase th√†nh c√¥ng');
      } catch(e) {}
    }

    window.addEventListener('load', () => {
      if (navigator.onLine) {
        (async ()=>{
          await loadAllFromFirebase();
          subscribeAllUsersRealtime();
          if (dataChanged) scheduleSync();
        })();
      }
    });

    window.addEventListener('online', () => {
      (async ()=>{
        await loadAllFromFirebase();
        subscribeAllUsersRealtime();
        if (dataChanged) scheduleSync();
      })();
    });

    window._fire_sync_loadAllFromFirebase = loadAllFromFirebase;
    window._fire_sync_subscribeAllUsersRealtime = subscribeAllUsersRealtime;
    window._fire_sync_performFullUpload = performFullUpload;
  }
</script>
<!-- End two-way sync -->

</body>
</html>
