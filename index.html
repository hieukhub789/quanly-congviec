<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω c√¥ng vi·ªác</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #74ebd5, #acb6e5);
    }
    input, textarea {
      margin: 5px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input[type="text"] {
      width: 200px;
    }
    button {
      padding: 10px 18px;
      margin: 5px;
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #addBtn { background-color: #007bff; }
    #addBtn:hover { background-color: #0056b3; }

    #exportBtn { background-color: #28a745; }
    #exportBtn:hover { background-color: #1e7e34; }

    #clearBtn { background-color: #e74c3c; }
    #clearBtn:hover { background-color: #c0392b; }

    table {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    th {
      background-color: #f2f2f2;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 12px;
      width: 500px;
      max-height: none;
      overflow-y: visible;
    }
    #modalNote {
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      
    }
    .close {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }
    .modal-buttons button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      color: white;
    }
    .edit-btn { background-color: #ffc107; }
    .delete-btn { background-color: #dc3545; }
    /* T√πy ch·ªânh chi·ªÅu r·ªông c·ªôt trong b·∫£ng xu·∫•t */
  .export-table {
    table-layout: fixed;
  }

  .export-table th:nth-child(1),
  .export-table td:nth-child(1) {
       width: 6%;   /* STT */
  }

  .export-table th:nth-child(2),
  .export-table td:nth-child(2) {
       width: 22%;  /* C√¥ng vi·ªác */
  }

  .export-table th:nth-child(3),
  .export-table td:nth-child(3) {
    width: 44%;  /* Ghi ch√∫ - d√†i g·∫•p ƒë√¥i */
  }

  .export-table th:nth-child(4),
  .export-table td:nth-child(4) {
    width: 22%;  /* Tr·∫°ng th√°i */
  }

  .export-table th:nth-child(5),
  .export-table td:nth-child(5) {
    width: 22%;  /* Ng√†y nh·∫≠p */
  }

    .hide-when-capture {
      display: inline-block;
    }
    @media (max-width: 600px) {
      input, textarea {
        width: 100%;
      }
      .modal-content {
        width: 95%;
      }
      #addBtn, #exportBtn, #clearBtn {
        width: 48%;
        font-size: 14px;
      }
      th, td {
        font-size: 14px;
        padding: 8px;
      }
    }
    @media (min-width: 768px) {
      .modal-content { width: 600px; }
    }

    .input-wrapper {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .search-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 15px;
    }
    #searchInput {
      padding: 10px 15px;
      border: 2px solid #9b59b6;
      border-radius: 10px;
      width: 300px;
      font-size: 15px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    #searchInput:focus {
      border-color: #8e44ad;
      box-shadow: 0 0 8px rgba(142, 68, 173, 0.5);
    }

    #toast {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 16px;
      position: fixed;
      z-index: 1000;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      font-size: 16px;
      transition: visibility 0s, opacity 0.5s ease;
      opacity: 0;
    }
    #taskTable tbody tr {
  cursor: pointer;
  transition: background-color 0.2s ease;
}

#taskTable tbody tr:hover {
  background-color: #ced413;
}
#taskTable th:first-child,
#taskTable td:first-child {
  text-align: center;
  vertical-align: middle;
  width: 50px;
  max-width: 50px;
}
.export-table {
  table-layout: fixed;
}

.export-table th:first-child,
.export-table td:first-child {
  text-align: center;
  vertical-align: middle;
  width: 50px;
  max-width: 50px;
}
/* x√≥a */
.cancel-btn {
    background-color: #0090f0;
    border: none;
    color: black;
    padding: 8px 16px;
    margin: 4px;
    border-radius: 5px;
    cursor: pointer;
  }

  .cancel-btn:hover {
    background-color: #080707;
  }

  .delete-btn {
    background-color: #dc3545;
    color: white;
    padding: 8px 16px;
    border: none;
    margin: 4px;
    border-radius: 5px;
    cursor: pointer;
  }

  .delete-btn:hover {
    background-color: #c82333;
  }
  #modalTask, #modalNote {
    background-color: #e0e0e0; /* n·ªÅn x√°m m·∫∑c ƒë·ªãnh */
    padding: 8px;
    border-radius: 4px;
  }
  #taskTable th:nth-child(4),
#taskTable td:nth-child(4) {
  width: 120px;
  text-align: center;
}

.status-label {
  font-weight: bolder;
  color: #333;
  font-size: 14px;
  margin-bottom: 6px;
  display: inline-block;
  font-family: 'Segoe UI', sans-serif;
  margin-top: 20px;
}

#modalStatus {
  width: 160px;
  padding: 8px 12px;
  font-size: 14px;
  border: 1.8px solid #4a90e2;
  border-radius: 6px;
  background-color: #f9faff;
  color: #222;
  outline: none;
  cursor: not-allowed; /* Do disabled select show not-allowed cursor */
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#modalStatus:disabled {
  background-color: #e6e9f0;
  color: #888;
  border-color: #aab3cc;
}

#modalStatus:not(:disabled):focus {
  border-color: #357ae8;
  box-shadow: 0 0 5px rgba(53, 122, 232, 0.5);
}

#taskTable th:nth-child(5),
#taskTable td:nth-child(5) {
  width: 110px;
  text-align: center;
}

/* th√™m */


.filter-container {
    margin-bottom: 5px;
    font-family: Arial, sans-serif;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .filter-container label {
    font-weight: 600;
    color: #333;
  }

  .filter-container select {
    padding: 10px 15px;
    margin-left: 10px;
    margin-top: 5px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    cursor: pointer;
    transition: border-color 0.2s ease-in-out;
    border: 2px solid #9b59b6;
    border-radius: 10px;
  }

  .filter-container select:hover,
  .filter-container select:focus {
    border-color: #007BFF;
    outline: none;
  } 
  button:disabled {
  background-color: #ccc;   /* M√†u n·ªÅn x√°m */
  color: #666;              /* M√†u ch·ªØ nh·∫°t */
  cursor: not-allowed;      /* Con tr·ªè b·ªã ch·∫∑n */
  opacity: 0.7;             /* M·ªù nh·∫π */
}

/* th√¥ng b√°o m∆∞·ª£t */
.toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
}

.toast {
  background-color: #2e7d32;
  color: #fff;
  padding: 15px 20px;
  margin-top: 10px;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  min-width: 260px;
  opacity: 0;
  transform: translateX(100%);
  animation: slideIn 0.4s forwards, fadeOut 0.4s forwards 5s;
}

@keyframes slideIn {
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes fadeOut {
  to {
    opacity: 0;
    transform: translateX(-100%);
  }
}
  #repairPagination button {
    margin: 2px;
    padding: 5px 10px;
    border: none;
    border-radius: 5px;
    background-color: #080707;
    cursor: pointer;
  }

  #repairPagination button:hover:not(:disabled) {
    background-color: #bbb;
  }

  #repairPagination button:disabled {
    background-color: #080707;
    cursor: not-allowed;
    color: #888;
  }

  #repairPagination button.active-page {
    background-color: #007bff;
    color: white;
    font-weight: bold;
  }

  .ModalRepair {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  }
  .modal-repair-wrapper {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;   /* cƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
    justify-content: center; /* cƒÉn gi·ªØa theo chi·ªÅu ngang */
    z-index: 10000;
  }

  .modal-repair-wrapper.hidden {
    display: none;
  }

  .modal-repair-box {
    background: #ffffff;
    padding: 24px 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 420px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    animation: fadeSlideIn 0.2s ease-out;
    margin-left: 450px;
    margin-top: 70px;
    /* justify-content: center;
    text-align: center; */
  }

  .modal-repair-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 18px;
    text-align: center;
    color: #333;
  }

  .modal-repair-input {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 12px;
    font-size: 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    box-sizing: border-box;
  }

  .modal-repair-input:focus {
    border-color: #007bff;
    outline: none;
  }

  .modal-repair-actions {
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }

  .modal-repair-btn {
    flex: 1;
    padding: 10px;
    font-size: 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .modal-repair-btn.save {
    background-color: #28a745;
    color: white;
  }

  .modal-repair-btn.save:hover {
    background-color: #218838;
  }

  .modal-repair-btn.cancel {
    background-color: #dc3545;
    color: white;
  }

  .modal-repair-btn.cancel:hover {
    background-color: #c82333;
  }

  @keyframes fadeSlideIn {
    from {
      transform: translateY(-20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  @keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

#btnSuaGhiChu:hover {
  background-color: #0056b3 !important;
}

#modalGhiChu button:hover {
  opacity: 0.9;
}


/* Modal n·ªÅn */
.modal-ghichu {
  display: none;
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.4);
  justify-content: center;
  align-items: center;
  z-index: 9999;
  font-family: 'Segoe UI', sans-serif;
}

/* H·ªôp modal ch√≠nh */
.modal-ghichu-content {
  background: white;
  padding: 24px;
  width: 90%;
  max-width: 900px;
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
  animation: fadeIn 0.3s ease;
}

/* Ti√™u ƒë·ªÅ modal */
.modal-ghichu-content h2 {
  margin-top: 0;
  font-size: 20px;
  color: #333;
}
.ghichu-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 6px;
}
/* V√πng nh·∫≠p ghi ch√∫ */
.ghichu-textarea {
  width: 100%;
  height: 300px;
  padding: 20px 0px;
  padding-left: 10px;
  font-size: 15px;
  border: 1px solid #ccc;
  border-radius: 8px;
  resize: none;
  background-color: #f9f9f9;
  color: #000;
  outline: none;
  margin: 10px;
}

/* V√πng ch·ª©a n√∫t */
.ghichu-buttons {
  margin-top: 20px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* N√∫t s·ª≠a */
.btn-sua {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}
.btn-sua:hover {
  background-color: #0056b3;
}

/* N√∫t ƒë√≥ng */
.btn-dong {
  background-color: red;
  color: #000;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.2s;
}
.btn-dong:hover {
  background-color: #ccc;
}

/* Hi·ªáu ·ª©ng fade */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}



  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Firebase config & init (injected by assistant) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB3YYnW0BElIeoRW-pBAWrSyo74QE1-64I",
    authDomain: "hieu1-24be7.firebaseapp.com",
    databaseURL: "https://hieu1-24be7-default-rtdb.firebaseio.com",
    projectId: "hieu1-24be7",
    storageBucket: "hieu1-24be7.firebasestorage.app",
    messagingSenderId: "350859931788",
    appId: "1:350859931788:web:945d67c77d5cd2906c4ba9",
    measurementId: "G-VGP7L1QFX7"
  };

  const app = initializeApp(firebaseConfig);
  window.firebaseApp = app;
  window.db = getFirestore(app);
</script>
<!-- End Firebase init -->

</head>
<body>
  <h2 style="text-align: center; color: #2c3e50;">·ª®ng d·ª•ng Qu·∫£n l√Ω C√¥ng vi·ªác C√° nh√¢n v√† Nh√≥m</h2>
  <div class="toast-container" id="toastContainer"></div>
  <!-- Ghi ch√∫ nhanh -->


  <!-- --- USER SWITCH: start --- -->
  <div class="filter-container" style="margin-bottom: 12px; text-align:center;">
    <label for="userSelect" style="font-weight:bold; margin-right:8px;">Ng∆∞·ªùi d√πng:</label>
    <select id="userSelect" onchange="changeUser()" style="padding:8px 12px; border-radius:8px; border:2px solid #9b59b6;">
      <option value="nhi">Ms Nhi</option>
      <option value="quan">Mr Quan</option>
      <option value="all">T·∫•t c·∫£</option>
    </select>
  </div>
  <!-- --- USER SWITCH: end --- -->

  <div class="search-wrapper">
    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm c√¥ng vi·ªác ho·∫∑c ghi ch√∫..." oninput="filterTasks()" style="width: 410px;">
    
    <div class="filter-container">
  <!-- <label for="statusFilter">L·ªçc theo tr·∫°ng th√°i:</label> -->
  <select id="statusFilter">
    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i </option>
    <option value="Ch∆∞a l√†m">Ch∆∞a l√†m</option>
    <option value="ƒêang l√†m">ƒêang l√†m</option>
    <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
  </select>
  

  
  </div>
<!-- loc ng√†y -->
  <label for="startDate" style="margin-top: 10px; margin-left: 10px;font-size: larger;">T·ª´ ng√†y:</label>
<input type="text" style="width: 110px; padding: 5px; border: 2px solid #9b59b6; border-radius: 10px;"  id="startDate" placeholder="dd/mm/yyyy">

<label for="endDate" style="margin-top: 10px;margin-left: 10px; font-size: larger;">ƒê·∫øn ng√†y:</label>
<input type="text" id="endDate" style="width: 110px; padding: 5px; border: 2px solid #9b59b6; border-radius: 10px;"  placeholder="dd/mm/yyyy">

<button id="clearDateFilter"  type="button" style="background-color: red;">X√≥a l·ªçc ng√†y</button>

  
  </div>
  <div class="input-wrapper">
    <input type="text" id="taskInput" placeholder="Nh·∫≠p c√¥ng vi·ªác">
    <input type="text" id="noteInput" placeholder="Ghi ch√∫">
    <button id="addBtn" onclick="addTask()">Th√™m</button>
    <button id="exportBtn" onclick="showExportModal()">Xu·∫•t</button>
    <button id="clearBtn" onclick="showConfirmClearModal()">X√≥a</button>
    <button id="syncBtn" onclick="syncFromFirebase()" style="background-color:#8e44ad; color:white;">üîÑ ƒê·ªìng b·ªô t·ª´ Cloud</button>
    <button onclick="openModal('addUserModal')"  style="background: linear-gradient(135deg, #5dade2, #85c1e9); color: #050101;font-weight: 600; ">üë§‚ûï Ng∆∞·ªùi d√πng</button>
    <button id="lockBtn" onclick="lockScreen()" style="background-color: orange;">Kh√≥a</button>
    <button onclick="showWeatherModal()" style="background-color: #4ba3c7; color: white;">Th·ªùi ti·∫øt</button>
    <button onclick="showRepairModal()" style="background-color: #534bc7; color: white; "> S·ª≠a xe</button>
    <button onclick="window.open('grab_be.html', '_blank')" style="background-color: #FFD700; color: rgb(11, 11, 11);">
  Grab/Be
</button>
<button onclick="moModalGhiChu()" style="background-color: #c53f92; color: white; "> Ghi Ch√∫</button>

  <table id="taskTable">
    <thead>
      <tr>
        <th>STT</th>
        <th>C√¥ng vi·ªác</th>
        <th>Ghi ch√∫</th>
        <th>Tr·∫°ng th√°i</th> <!-- m·ªõi -->
        <th>Ng√†y nh·∫≠p</th> <!-- th√™m d√≤ng n√†y -->
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- ph√¢n trang -->
   <div id="paginationControls" style="margin-top: 10px; text-align: center;">
  <button id="prevPageBtn" style="color: #080707;" >‚¨ÖÔ∏è Tr∆∞·ªõc</button>
  <span id="paginationInfo" >Trang 1</span>
  <button id="nextPageBtn" style="color: #080707;">Sau ‚û°Ô∏è</button>
</div>


  <!-- Modal chi ti·∫øt -->
  <div id="detailModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('detailModal')">&times;</span>
    <h3>Chi ti·∫øt c√¥ng vi·ªác</h3>
    <p><strong>STT:</strong> <span id="modalStt"></span></p>
    <p><strong>C√¥ng vi·ªác:</strong></p>
    <div id="modalTask" contenteditable="false" style="background-color: #e0e0e0; border-radius: 6px; padding: 6px;"></div>
    <p><strong>Ghi ch√∫:</strong></p>
    <div id="modalNote" contenteditable="false" style="background-color: #e0e0e0; border-radius: 6px; padding: 6px;"></div>
   <label for="modalStatus" class="status-label">Tr·∫°ng th√°i:</label><br>
    <select id="modalStatus" disabled>
    <option value="Ch∆∞a l√†m">Ch∆∞a l√†m</option>
    <option value="ƒêang l√†m">ƒêang l√†m</option>
    <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
    </select>
    <div class="form-group" style="margin-top: 10px;">
  <label for="modalDate" style="display: block; font-weight: bold; font-size: 14px;">Ng√†y nh·∫≠p:</label>
  <input type="text" id="modalDate" class="form-control" 
         style="background-color:#e0e0e0; width: 140px;" readonly />
</div>
    
    <div class="modal-buttons">
      <button class="edit-btn" onclick="toggleEditTask()" id="editSaveBtn">S·ª≠a</button>
      <button class="delete-btn" onclick="openDeleteConfirmation()">X√≥a</button>
    </div>
  </div>
</div>

<!-- Modal th√™m ng∆∞·ªùi d√πng m·ªõi -->
<div id="addUserModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:350px; text-align:center;">
    <span class="close" onclick="closeModal('addUserModal')" style="float:right;">&times;</span>
    <h3>üë§ Th√™m ng∆∞·ªùi d√πng m·ªõi</h3>
    <input type="text" id="newUserName" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi d√πng..." 
           style="width:90%; padding:8px; border-radius:8px; border:1px solid #ccc;">
    <div class="modal-buttons" style="justify-content:center;">
      <button class="edit-btn" onclick="addNewUser()">Th√™m</button>
      <button class="delete-btn" onclick="deleteCurrentUser()">X√≥a ng∆∞·ªùi d√πng hi·ªán t·∫°i</button>
    </div>
  </div>
</div>


  <!-- Modal xu·∫•t -->
  <div id="exportModal" class="modal">
    <div class="modal-content" id="exportContent">
      <span class="close hide-when-capture" onclick="closeModal('exportModal')">&times;</span>
      <h3 id="exportTitle">DANH S√ÅCH C√îNG VI·ªÜC</h3>
      <button class="hide-when-capture" onclick="captureExportImage()" style="margin-top: 10px; padding: 6px 12px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">Ch·ª•p ·∫£nh</button>
      <button class="hide-when-capture" onclick="exportToJson()" style="margin-top: 10px; padding: 6px 12px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">Xu·∫•t d·ªØ li·ªáu ra JSON</button>
     <input type="file" id="importJsonInput" accept=".json" style="display: none;" onchange="handleJsonImport(event)">
<button class="hide-when-capture" onclick="document.getElementById('importJsonInput').click()" style="margin-top: 10px; padding: 6px 12px; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
  Nh·∫≠p t·ª´ file JSON
</button>
        <table class="export-table">
          <thead>
            <tr>
              <th>STT</th>
              <th>C√¥ng vi·ªác</th>
              <th>Ghi ch√∫</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Ng√†y nh·∫≠p</th>
            </tr>
          </thead>
          <tbody id="exportBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Modal x√°c nh·∫≠n xo√° -->
<div id="confirmDeleteModal" class="modal">
  <div class="modal-content">
    <h3>X√°c nh·∫≠n xo√°</h3>
    <p>B·∫°n c√≥ ch·∫Øc mu·ªën xo√° c√¥ng vi·ªác n√†y kh√¥ng?</p>
    <div class="modal-buttons">
      <button class="delete-btn" onclick="confirmDelete()">X√°c nh·∫≠n</button>
      <button class="cancel-btn" onclick="closeModal('confirmDeleteModal')">H·ªßy</button>
    </div>
  </div>
</div>

  <!-- Modal x√°c nh·∫≠n x√≥a t·∫•t c·∫£ -->
  <div id="confirmClearModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('confirmClearModal')">&times;</span>
      <h3>X√°c nh·∫≠n</h3>
      <p>B·∫°n c√≥ mu·ªën x√≥a to√†n b·ªô c√¥ng vi·ªác kh√¥ng?</p>
      <div class="modal-buttons">
        <button class="delete-btn" onclick="clearAllTasks()">X√≥a t·∫•t c·∫£</button>
        <button class="edit-btn" onclick="closeModal('confirmClearModal')">H·ªßy</button>
      </div>
    </div>
  </div>
  <!-- t√¥ng s·ªë c√¥ng vi·ªác -->
  <div id="footerInfo" style="display: flex; justify-content: space-between; margin-top: 20px;">
  <div id="taskCount" style="font-weight: bold;"></div>
  <div id="updateDate" style="margin: 4px 0; font-weight: bold; text-align: center;">Ng√†y c·∫≠p nh·∫≠t: --/--/----</div>
  <div id="completedCount" style="font-weight: bold;"></div>
</div>

<div id="weatherModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:9999;">
  <div style="background:#fff; width:90%; max-width:400px; margin:100px auto; padding:20px; border-radius:10px; position:relative;">
    <button onclick="closeWeatherModal()" style="position:absolute; top:10px; right:10px;">‚ùå</button>
    <h3>Th·ªùi ti·∫øt hi·ªán t·∫°i</h3>
    <div id="weatherContent">ƒêang t·∫£i...</div>
  </div>
</div>
<!-- Modal S·ª≠a xe -->
<div id="repairModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
  <div style="background: white; width: 90%; max-width: 800px; margin: 80px auto; padding: 20px; border-radius: 10px; position: relative;">
    <h3>Nh·∫≠p th√¥ng tin s·ª≠a xe</h3>
    <!-- √î t√¨m ki·∫øm -->
<input type="text" id="repairSearchInput" placeholder="T√¨m ki·∫øm..." oninput="renderRepairTable()" 
  style=" padding: 8px 10px; width: 300px; border-radius: 10px; border: 2px solid #9b59b6;">
  <button id="clearAllRepairsBtn" style="margin-top: 10px; background-color: red; color: white; padding: 6px 12px; border-radius: 6px;">
  üóëÔ∏è Xo√° t·∫•t c·∫£
</button>
<input type="file" id="importRepairInput" accept=".json" style="display: none;" onchange="handleRepairJsonImport(event)">

<button class="hide-when-capture" onclick="document.getElementById('importRepairInput').click()" style="margin-top: 10px; padding: 6px 12px; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
  Nh·∫≠p t·ª´ file JSON
</button>



    <!-- D√£y input -->
    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
      <input type="text" id="phutungInput" placeholder="Ph·ª• t√πng" style="flex: 1; min-width: 120px; padding: 8px 10px;border: 2px solid #9b59b6;">
      <input type="text" id="diadiemInput" placeholder="ƒê·ªãa ƒëi·ªÉm" style="flex: 1; min-width: 120px; padding: 8px 10px;border: 2px solid #9b59b6;">
      <input type="text" id="thoigianInput" placeholder="dd/mm/yyyy" style="flex: 1; min-width: 120px; padding: 8px 10px;border: 2px solid #9b59b6;">
      <input type="text" id="chiphiInput" placeholder="Chi ph√≠ (ƒë·ªìng)" style="flex: 1; min-width: 120px; padding: 8px 10px;border: 2px solid #9b59b6;">
      <button onclick="addRepairRow()" style="background-color: #2ecc71; color: white; padding: 6px 12px; border: 2px solid; border-radius: 10px;">Nh·∫≠p</button>
    </div>

    <!-- B·∫£ng hi·ªÉn th·ªã -->
    <table border="1" width="100%" style="border-collapse: collapse; text-align: center;">
      <thead style="background-color: #eee;">
        <tr>
          <th style="width: 50px;">STT</th>
          <th>Ph·ª• t√πng</th>
          <th>ƒê·ªãa ƒëi·ªÉm</th>
          <th>Th·ªùi gian</th>
          <th>Chi ph√≠</th>
        </tr>
      </thead>
      <tbody id="repairTableBody">
        <!-- D·ªØ li·ªáu s·∫Ω th√™m v√†o ƒë√¢y -->
      </tbody>
    </table>
    <div id="repairPagination" style="margin-top: 10px; text-align: center;"></div>

     <p id="totalCost" style="margin-top: 10px; font-weight: bold;">T·ªïng chi ph√≠: 0 VND</p>

    <br />
    <button onclick="closeRepairModal()" style="background-color: #e74c3c; color: white; padding: 8px 16px; border: none; border-radius: 5px;">ƒê√≥ng</button>
  </div>
  <!-- luu lai -->
  <div id="confirmModal" class="ModalRepair" style="display:none;">
  <div class="modal-content" style="padding: 20px; border-radius: 8px; background-color: #fff;">
    <p id="confirmMessage"></p>
    <div style="text-align: right; margin-top: 20px;">
      <button id="confirmYes" style="background-color: red; color: white; padding: 6px 12px; border-radius: 6px;">Xo√°</button>
      <button id="confirmNo" style="margin-left: 10px; padding: 6px 12px; border-radius: 6px; background-color: #0056b3;">Hu·ª∑</button>
    </div>
  </div>
</div>
</div>


<div id="editRepairModal" class="modal-repair-wrapper hidden">
  <div class="modal-repair-box">
    <h2 class="modal-repair-title">üõ†Ô∏è S·ª≠a th√¥ng tin s·ª≠a ch·ªØa</h2>

    <input id="editPhutungInput" class="modal-repair-input" placeholder="Ph·ª• t√πng ƒë√£ thay">
    <input id="editDiadiemInput" class="modal-repair-input" placeholder="ƒê·ªãa ƒëi·ªÉm s·ª≠a ch·ªØa">
    <input id="editThoigianInput" class="modal-repair-input" placeholder="Ng√†y s·ª≠a (dd/mm/yyyy)">
    <input id="editChiphiInput" class="modal-repair-input" placeholder="Chi ph√≠ (ƒë·ªìng)">

    <div class="modal-repair-actions">
      <button onclick="saveEditedRepair()" class="modal-repair-btn save">üíæ L∆∞u</button>
      <button onclick="closeEditRepairModal()" class="modal-repair-btn cancel">‚ùå H·ªßy</button>
    </div>
  </div>
</div>

<!-- ghi ch√∫ -->
 <!-- Modal Ghi Ch√∫ ƒê·∫πp -->
<div id="modalGhiChu" class="modal-ghichu">
  <div class="modal-ghichu-content">
    <h2>üìù Ghi Ch√∫</h2>
    <textarea id="noiDungGhiChu" readonly class="ghichu-textarea"></textarea>
    <div class="ghichu-footer">
    <div id="thoiGianLuu" style="font-size: 13px; color: #666; margin-top: 6px;">
      üïí Ch∆∞a c√≥ l·∫ßn l∆∞u n√†o
    </div>
    <div class="ghichu-buttons">
      <button id="btnSuaGhiChu" onclick="batCheDoSuaGhiChu()" class="btn-sua">‚úèÔ∏è S·ª≠a</button>
      <button onclick="dongModalGhiChu()" class="btn-dong">ƒê√≥ng</button>
    </div>
    </div>
  </div>
</div>
  <!-- Toast -->
  <div id="toast"></div>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
    let currentDetailIndex = -1;
    let isStorageFull = false;
    let isEditing = false;

    let currentPage = 1;
    const tasksPerPage = 10;

    function saveToLocalStorage() {
  try {
    // Kh√¥ng l∆∞u khi ƒëang ·ªü ch·∫ø ƒë·ªô "T·∫•t c·∫£"
    if (currentUser === "all") {
      console.warn("ƒêang ·ªü ch·∫ø ƒë·ªô 'T·∫•t c·∫£' ‚Äî kh√¥ng l∆∞u d·ªØ li·ªáu.");
      return;
    }

    // L∆∞u ri√™ng t·ª´ng ng∆∞·ªùi d√πng
    localStorage.setItem(`tasks_${currentUser}`, JSON.stringify(tasks));

    enableAddButton(); // b·∫≠t l·∫°i n√∫t n·∫øu l∆∞u th√†nh c√¥ng
  } catch (e) {
    if (e.name === "QuotaExceededError" || e.name === "NS_ERROR_DOM_QUOTA_REACHED") {
      showToast("B·ªô nh·ªõ ƒë√£ ƒë·∫ßy! Kh√¥ng th·ªÉ l∆∞u th√™m c√¥ng vi·ªác.");
      disableAddButton(); // v√¥ hi·ªáu h√≥a n√∫t th√™m
    } else {
      console.error("L·ªói l∆∞u localStorage:", e);
    }
  }
}

// v√¥ hi·ªáu qu√° n√∫t th√™m
function disableAddButton() {
  const btn = document.getElementById("addBtn");
  if (btn) btn.disabled = true;
}

function enableAddButton() {
  const btn = document.getElementById("addBtn");
  if (btn) btn.disabled = false;
}

//th√™m t√≠nh nƒÉng danh s√°ch xu·∫•t
    function renderTable() {
      filterTasks();
      
    }
function filterTasks() {
  // === 0. ƒê·ªìng b·ªô window.tasks t·ª´ localStorage (quan tr·ªçng) ===
  const user = window.currentUser || localStorage.getItem("currentUser");
  const storedTasks = JSON.parse(localStorage.getItem(`tasks_${user}`) || "[]");
  window.tasks = storedTasks;
  

  // === 1. L·∫•y c√°c input (an to√†n n·∫øu ph·∫ßn t·ª≠ ch∆∞a t·ªìn t·∫°i) ===
  const keywordInputEl = document.getElementById("searchInput");
  const statusFilterEl = document.getElementById("statusFilter");
  const startDateEl = document.getElementById("startDate");
  const endDateEl = document.getElementById("endDate");
  const tableBody = document.querySelector("#taskTable tbody");

  const keywordInput = (keywordInputEl?.value || "").toLowerCase();
  const selectedStatus = (statusFilterEl?.value) || "";
  const startDateStr = startDateEl?.value || "";
  const endDateStr = endDateEl?.value || "";

  if (!tableBody) return;
  tableBody.innerHTML = "";

  const statusPriority = {
    "ƒêang l√†m": 1,
    "Ch∆∞a l√†m": 2,
    "Ho√†n th√†nh": 3
  };

  function parseDDMMYYYY(dateStr) {
    if (!dateStr || !dateStr.includes("/")) return null;
    const parts = dateStr.split("/");
    const day = parts[0].padStart(2, "0");
    const month = parts[1].padStart(2, "0");
    const year = parts[2];
    return new Date(`${year}-${month}-${day}`);
  }

  const startDate = startDateStr ? parseDDMMYYYY(startDateStr) : null;
  const endDate = endDateStr ? parseDDMMYYYY(endDateStr) : null;

  // T√°ch t·ª´ kh√≥a
  const keywords = keywordInput
    .split(/[,\s]+/)
    .filter(k => k.length > 0);

  const isAndSearch = !keywordInput.includes(",");

  // L·ªçc t·ª´ window.tasks (ƒë√£ ƒë·ªìng b·ªô ·ªü tr√™n)
  const filteredTasks = (window.tasks || []).filter(taskObj => {
    const text = `${(taskObj.task || "").toLowerCase()} ${(taskObj.note || "").toLowerCase()}`;

    const taskMatch = keywords.length === 0
      ? true
      : isAndSearch
        ? keywords.every(word => text.includes(word))
        : keywords.some(word => text.includes(word));

    const statusMatch =
      selectedStatus === "" ||
      (taskObj.status || "").trim().toLowerCase() === selectedStatus.toLowerCase();

    const taskDateStr = taskObj.date || "";
    let dateMatch = true;

    if ((startDate || endDate) && taskDateStr.includes("/")) {
      const taskDate = parseDDMMYYYY(taskDateStr);
      if (startDate && taskDate < startDate) dateMatch = false;
      if (endDate && taskDate > endDate) dateMatch = false;
    }

    return taskMatch && statusMatch && dateMatch;
  });

  // S·∫Øp x·∫øp: pinned > status > date
  filteredTasks.sort((a, b) => {
    if (a.pinned && !b.pinned) return -1;
    if (!a.pinned && b.pinned) return 1;

    const statusA = (a.status || "").trim();
    const statusB = (b.status || "").trim();
    const priorityA = statusPriority[statusA] || 99;
    const priorityB = statusPriority[statusB] || 99;
    if (priorityA !== priorityB) return priorityA - priorityB;

    const dateA = a.date ? parseDDMMYYYY(a.date) : new Date(0);
    const dateB = b.date ? parseDDMMYYYY(b.date) : new Date(0);
    return dateB - dateA;
  });

  // Ph√¢n trang
  const totalPages = Math.ceil(filteredTasks.length / tasksPerPage);
  if (currentPage > totalPages) currentPage = totalPages || 1;
  const startIndex = (currentPage - 1) * tasksPerPage;
  const paginatedTasks = filteredTasks.slice(startIndex, startIndex + tasksPerPage);

  paginatedTasks.forEach((taskObj, idx) => {
    const row = document.createElement("tr");

    let color = "";
    switch ((taskObj.status || "").trim().toLowerCase()) {
      case "ho√†n th√†nh": color = "green"; break;
      case "ch∆∞a l√†m": color = "red"; break;
      case "ƒëang l√†m": color = "#000000"; break;
      default: color = "black";
    }

    row.innerHTML = `
      <td>${startIndex + idx + 1}</td>
      <td>${taskObj.pinned ? "üìå " : ""}${taskObj.task}</td>
      <td>${taskObj.note}</td>
      <td style="color: ${color}; font-weight: bold;">${taskObj.status || ""}</td>
      <td>${taskObj.date || ""}</td>
    `;

    // T√¨m index th·ª±c c·ªßa task trong window.tasks (an to√†n h∆°n indexOf khi objects l√† c√πng tham chi·∫øu)
    const realIndex = window.tasks.indexOf(taskObj);

    row.querySelector("td:nth-child(2)").oncontextmenu = (e) => {
      e.preventDefault();
      if (typeof togglePin === "function") togglePin(realIndex);
    };

    row.onclick = (e) => {
      if (e.target.tagName.toLowerCase() === "button") return;
      if (typeof showDetails === "function") showDetails(realIndex);
    };

    tableBody.appendChild(row);
     
  });
  if (filteredTasks.length === 0) {
    const emptyRow = document.createElement("tr");
    emptyRow.innerHTML = `
      <td colspan="5" style="text-align:center; color: black; font-style: italic;">
        (Kh√¥ng c√≥ c√¥ng vi·ªác n√†o)
      </td>`;
    tableBody.appendChild(emptyRow);
  }

  // C·∫≠p nh·∫≠t ph√¢n trang UI
  const paginationInfoEl = document.getElementById("paginationInfo");
  if (paginationInfoEl) paginationInfoEl.textContent = `Trang ${currentPage} / ${totalPages || 1}`;

  const prevBtn = document.getElementById("prevPageBtn");
  const nextBtn = document.getElementById("nextPageBtn");
  if (prevBtn) prevBtn.disabled = currentPage === 1;
  if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;

  // Th·ªëng k√™
  const taskCountEl = document.getElementById("taskCount");
  if (taskCountEl) taskCountEl.textContent = `T·ªïng c√¥ng vi·ªác: ${filteredTasks.length}`;
  const completedCount = filteredTasks.filter(task => (task.status || "").toLowerCase().trim() === "ho√†n th√†nh").length;
  const completedCountEl = document.getElementById("completedCount");
  if (completedCountEl) completedCountEl.textContent = `Ho√†n th√†nh: ${completedCount}`;

  const today = new Date();
  const formattedDate = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth()+1).padStart(2, '0')}/${today.getFullYear()}`;
  const updateDateEl = document.getElementById("updateDate");
  if (updateDateEl) updateDateEl.textContent = `Ng√†y c·∫≠p nh·∫≠t: ${formattedDate}`;
}


function togglePin(index) {
  tasks[index].pinned = !tasks[index].pinned;
  saveToLocalStorage();
  filterTasks();
}
function isLocalStorageFull(data) {
  try {
    // th·ª≠ l∆∞u d·ªØ li·ªáu t·∫°m
    localStorage.setItem("__test__", data);
    localStorage.removeItem("__test__");
    return false; // ch∆∞a ƒë·∫ßy
  } catch (e) {
    return true; // ƒë·∫ßy
  }
}



  function addTask() {
  const task = document.getElementById("taskInput").value.trim();
  const note = document.getElementById("noteInput").value.trim();

  if (isStorageFull) {
    showToast("Kh√¥ng th·ªÉ th√™m v√¨ b·ªô nh·ªõ ƒë√£ ƒë·∫ßy.");
    return;
  }

  if (task === "") {
    alert("Vui l√≤ng nh·∫≠p c√¥ng vi·ªác!");
    return;
  }

  const newTask = {
    task,
    note,
    status: "Ch∆∞a l√†m",
    date: new Date().toLocaleDateString("vi-VN"),
    pinned: false // üÜï m·∫∑c ƒë·ªãnh c√¥ng vi·ªác m·ªõi ch∆∞a ghim
  };

  const tempData = JSON.stringify([newTask, ...tasks]);

  if (isLocalStorageFull(tempData)) {
    showToast("B·ªô nh·ªõ g·∫ßn ƒë·∫ßy! Kh√¥ng th·ªÉ th√™m c√¥ng vi·ªác.");
    disableAddButton();
    return;
  }

  tasks.unshift(newTask);
  saveToLocalStorage();
  filterTasks();
  // üîÑ C·∫≠p nh·∫≠t bi·∫øn to√†n c·ª•c ƒë·ªÉ UI ph·∫£n √°nh ngay
window.tasks = JSON.parse(localStorage.getItem(`tasks_${currentUser}`) || "[]");

// üîÅ V·∫Ω l·∫°i b·∫£ng
if (typeof window.filterTasks === "function") {
  window.filterTasks();
}


  document.getElementById("taskInput").value = "";
  document.getElementById("noteInput").value = "";
  showToast("ƒê√£ th√™m c√¥ng vi·ªác m·ªõi.");
  

  
}



  function deleteTask(index) {
  const user = window.currentUser || localStorage.getItem("currentUser");
  if (!user || user === "all") {
    showToast("‚ùå Kh√¥ng th·ªÉ x√≥a trong ch·∫ø ƒë·ªô 'T·∫•t c·∫£'!");
    return;
  }

  if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√¥ng vi·ªác n√†y kh√¥ng?")) return;

  // üîπ L·∫•y danh s√°ch hi·ªán t·∫°i ƒë√∫ng user
  const tasks = JSON.parse(localStorage.getItem(`tasks_${user}`) || "[]");

  if (!tasks[index]) {
    showToast("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác ƒë·ªÉ x√≥a!");
    return;
  }

  // üîπ X√≥a task theo index
  tasks.splice(index, 1);

  // üîπ L∆∞u l·∫°i local
  localStorage.setItem(`tasks_${user}`, JSON.stringify(tasks));

  // üîπ C·∫≠p nh·∫≠t to√†n c·ª•c v√† refresh UI
  window.tasks = tasks;

  // üîπ ƒê√≥ng modal (n·∫øu c√≥)
  const modal = document.getElementById("detailModal");
  if (modal) modal.style.display = "none";

  // üîÅ C·∫≠p nh·∫≠t l·∫°i danh s√°ch
  if (typeof window.filterTasks === "function") window.filterTasks();

  // ‚úÖ Th√¥ng b√°o
  showToast("üóëÔ∏è ƒê√£ x√≥a c√¥ng vi·ªác th√†nh c√¥ng!");
}




   function editTask(index) {
  const user = window.currentUser || localStorage.getItem("currentUser");
  if (!user || user === "all") {
    showToast("‚ö†Ô∏è Kh√¥ng th·ªÉ s·ª≠a trong ch·∫ø ƒë·ªô 'T·∫•t c·∫£'!");
    return;
  }

  // üîπ L·∫•y task hi·ªán t·∫°i t·ª´ b·ªô nh·ªõ RAM
  const taskObj = window.tasks[index];
  if (!taskObj) {
    showToast("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác ƒë·ªÉ s·ª≠a!");
    return;
  }

  // üîπ Prompt ƒë·ªÉ nh·∫≠p d·ªØ li·ªáu m·ªõi
  const newTask = prompt("S·ª≠a c√¥ng vi·ªác:", taskObj.task);
  if (newTask === null) return;

  const newNote = prompt("S·ª≠a ghi ch√∫:", taskObj.note);
  if (newNote === null) return;

  // üîπ C·∫≠p nh·∫≠t l·∫°i trong bi·∫øn RAM
  window.tasks[index] = {
    ...taskObj,
    task: newTask.trim(),
    note: newNote.trim(),
  };

  // üîπ L∆∞u l·∫°i localStorage
  localStorage.setItem(`tasks_${user}`, JSON.stringify(window.tasks));

  // üîπ C·∫≠p nh·∫≠t l·∫°i bi·∫øn to√†n c·ª•c t·ª´ localStorage (ƒë·∫£m b·∫£o ƒë·ªìng b·ªô)
  window.tasks = JSON.parse(localStorage.getItem(`tasks_${user}`) || "[]");

  // üîπ G·ªçi l·∫°i UI render
  if (typeof window.filterTasks === "function") window.filterTasks();

  // üîπ ƒê√≥ng modal (n·∫øu c√≥)
  closeModal("detailModal");

  // üîπ Toast b√°o th√†nh c√¥ng
  showToast("‚úèÔ∏è ƒê√£ c·∫≠p nh·∫≠t c√¥ng vi·ªác!");
}



    function showDetails(index) {
  currentDetailIndex = index;
  const task = tasks[index];

  document.getElementById("modalStt").innerText = index + 1;
  document.getElementById("modalTask").innerText = task.task;
  document.getElementById("modalNote").innerText = task.note;
  document.getElementById("modalDate").value = task.date || "";


  // G√°n tr·∫°ng th√°i v√†o dropdown
  const modalStatus = document.getElementById("modalStatus");
  const status = (task.status || "").trim().toLowerCase();
  const validStatuses = ["ch∆∞a l√†m", "ƒëang l√†m", "ho√†n th√†nh"];
  modalStatus.value = validStatuses.includes(status) ? capitalize(status) : "Ch∆∞a l√†m";

  // Reset ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
  const taskDiv = document.getElementById("modalTask");
  const noteDiv = document.getElementById("modalNote");
  const editBtn = document.getElementById("editSaveBtn");

  taskDiv.contentEditable = "false";
  noteDiv.contentEditable = "false";
  taskDiv.style.backgroundColor = "#e0e0e0";
  noteDiv.style.backgroundColor = "#e0e0e0";
  modalStatus.disabled = true;
  editBtn.textContent = "S·ª≠a";
  isEditing = false;

  document.getElementById("detailModal").style.display = "block";
}

// H√†m h·ªó tr·ª£ vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu
function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}



function showExportModal() {
  const exportBody = document.getElementById("exportBody");
  exportBody.innerHTML = "";

  const today = new Date();
  const formattedDateTime = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()} - ${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}`;
  document.getElementById("exportTitle").innerText = `DANH S√ÅCH C√îNG VI·ªÜC ${formattedDateTime}`;

  const keyword = document.getElementById("searchInput").value.toLowerCase();
  const selectedStatus = document.getElementById("statusFilter").value;
  const startDateStr = document.getElementById("startDate").value;
  const endDateStr = document.getElementById("endDate").value;

  function parseDDMMYYYY(dateStr) {
    const parts = dateStr.split("/");
    const day = parts[0].padStart(2, "0");
    const month = parts[1].padStart(2, "0");
    const year = parts[2];
    return new Date(`${year}-${month}-${day}`);
  }

  const startDate = startDateStr ? parseDDMMYYYY(startDateStr) : null;
  const endDate = endDateStr ? parseDDMMYYYY(endDateStr) : null;

  const filteredTasks = tasks.filter(task => {
    const taskMatch =
      task.task.toLowerCase().includes(keyword) ||
      task.note.toLowerCase().includes(keyword);

    const statusMatch =
      selectedStatus === "" ||
      (task.status || "").trim().toLowerCase() === selectedStatus.toLowerCase();

    let dateMatch = true;
    if ((startDate || endDate) && task.date && task.date.includes("/")) {
      const taskDate = parseDDMMYYYY(task.date);
      if (startDate && taskDate < startDate) dateMatch = false;
      if (endDate && taskDate > endDate) dateMatch = false;
    }

    return taskMatch && statusMatch && dateMatch;
  });

  const statusOrder = { 'ƒëang l√†m': 1, 'ch∆∞a l√†m': 2, 'ho√†n th√†nh': 3 };
  filteredTasks.sort((a, b) => {
    return (statusOrder[(a.status || '').toLowerCase()] || 99) - (statusOrder[(b.status || '').toLowerCase()] || 99);
  });

  filteredTasks.forEach((task, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${task.task}</td>
      <td>${task.note}</td>
      <td>${task.status || ""}</td>
      <td>${task.date || ""}</td> 
    `;
    exportBody.appendChild(row);
  });


      

  document.getElementById("exportModal").style.display = "block";
}

    function captureExportImage() {
      const exportContent = document.querySelector("#exportModal .modal-content");
      const originalMaxHeight = exportContent.style.maxHeight;

      document.querySelectorAll(".hide-when-capture").forEach(el => el.style.display = "none");

      exportContent.style.maxHeight = "none";
      exportContent.style.overflow = "visible";

      html2canvas(exportContent, {
        backgroundColor: "#fff",
        scale: 2,
        useCORS: true
      }).then(canvas => {
        const link = document.createElement("a");
        link.download = "danh_sach_cong_viec.jpg";
        link.href = canvas.toDataURL("image/jpeg");
        link.click();

        exportContent.style.maxHeight = originalMaxHeight || "80vh";
        exportContent.style.overflow = "auto";
        document.querySelectorAll(".hide-when-capture").forEach(el => el.style.display = "inline-block");
      });
      document.getElementById("exportModal").style.display = "none";

    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = "none";
    }

    function showConfirmClearModal() {
      document.getElementById("confirmClearModal").style.display = "block";
    }

    function clearAllTasks() {
  if (tasks.length === 0) {
    showToast("Kh√¥ng c√≥ c√¥ng vi·ªác n√†o ƒë·ªÉ x√≥a.");
    closeModal('confirmClearModal')
    return;
  }

  // T·∫°o file backup tr∆∞·ªõc khi x√≥a
  const backupBlob = new Blob([JSON.stringify(tasks, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(backupBlob);
  link.download = `backup_cong_viec_${new Date().toLocaleDateString("vi-VN").replace(/\//g, "-")}.json`;
  link.click();

  // X√≥a to√†n b·ªô
  tasks = [];
  saveToLocalStorage();
  closeModal('confirmClearModal');
  filterTasks();

  showToast("ƒê√£ x√≥a to√†n b·ªô c√¥ng vi·ªác! File backup ƒë√£ ƒë∆∞·ª£c t·∫£i v·ªÅ.");
}

   


  function showToast(message) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerText = message;
  container.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 7000);
}


    // window.onclick = function(event) {
    //   if (event.target.classList.contains("modal")) {
    //     event.target.style.display = "none";
    //   }
    // }
    window.addEventListener("keydown", function(event) {
    if (event.key === "Escape") {
      document.querySelectorAll(".modal").forEach(modal => {
      modal.style.display = "none";
        });
      }
    });

    //window.onload = renderTable;
    document.getElementById("statusFilter").addEventListener("change", filterTasks);


function toggleEditTask() {
  const taskDiv = document.getElementById("modalTask");
  const noteDiv = document.getElementById("modalNote");
  const modalStatus = document.getElementById("modalStatus");
  const editSaveBtn = document.getElementById("editSaveBtn");

  if (!isEditing) {
    // B·∫≠t ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
    taskDiv.contentEditable = "true";
    noteDiv.contentEditable = "true";
    taskDiv.style.backgroundColor = "#fff";
    noteDiv.style.backgroundColor = "#fff";
    modalStatus.disabled = false;

    editSaveBtn.textContent = "L∆∞u";
    isEditing = true;
  } else {
    // L∆∞u thay ƒë·ªïi
    const updatedTask = taskDiv.innerText.trim();
    const updatedNote = noteDiv.innerText.trim();
    const updatedStatus = modalStatus.value;

    if (updatedTask === "") {
      alert("C√¥ng vi·ªác kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
      return;
    }

    // C·∫≠p nh·∫≠t ƒë√∫ng c√¥ng vi·ªác hi·ªán t·∫°i
    tasks[currentDetailIndex].task = updatedTask;
    tasks[currentDetailIndex].note = updatedNote;
    tasks[currentDetailIndex].status = updatedStatus;

    saveToLocalStorage();
    filterTasks();
    showDetails(currentDetailIndex);

    editSaveBtn.textContent = "S·ª≠a";
    isEditing = false;

    // ƒê√≥ng kh√≥a ch·ªânh s·ª≠a
    taskDiv.contentEditable = "false";
    noteDiv.contentEditable = "false";
    taskDiv.style.backgroundColor = "#e0e0e0";
    noteDiv.style.backgroundColor = "#e0e0e0";
    modalStatus.disabled = true;
  }
}
  // x√≥a chi ti·∫øt
  function openDeleteConfirmation() {
    document.getElementById("confirmDeleteModal").style.display = "block";
  }

  function confirmDelete() {
    tasks.splice(currentDetailIndex, 1);
    saveToLocalStorage();
    filterTasks();
    closeModal("detailModal");
    closeModal("confirmDeleteModal");
    showToast("ƒê√£ xo√° c√¥ng vi·ªác!");
    if (currentDetailIndex === -1) return;
  }

  // function closeModal(id) {
  //   document.getElementById(id).style.display = "none";
  // }

  function editField(spanElement, field) {
  const originalValue = spanElement.innerText;
  const input = document.createElement("input");
  input.value = originalValue;
  input.classList.add("edit-input");
  spanElement.replaceWith(input);
  input.focus();

  input.addEventListener("blur", () => saveEdit(input, field));
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") saveEdit(input, field);
  });
}

function saveEdit(inputElement, field) {
  const newValue = inputElement.value.trim();
  const span = document.createElement("span");
  span.classList.add("editable-field");
  span.setAttribute("ondblclick", `editField(this, '${field}')`);
  span.innerText = newValue;

  inputElement.replaceWith(span);

  const taskIndex = spanIndex;
  if (tasks[taskIndex]) {
    tasks[taskIndex][field] = newValue;
    saveTasks();
    filterTasks(document.getElementById("searchInput").value);
  }
}

function exportToJson() {
  let tasksData = [];

  if (currentUser === "all") {
    // G·ªôp d·ªØ li·ªáu c·ªßa t·∫•t c·∫£ ng∆∞·ªùi d√πng (t·ª± ƒë·ªông)
    tasksData = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith("tasks_") && key !== "tasks_all") {
        const data = JSON.parse(localStorage.getItem(key) || "[]");
        tasksData = tasksData.concat(data);
      }
    }
  } else {
    tasksData = JSON.parse(localStorage.getItem(`tasks_${currentUser}`) || "[]");
  }

  const blob = new Blob([JSON.stringify(tasksData, null, 2)], { type: "application/json" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);

  // üîπ T·∫°o t√™n file t·ª± ƒë·ªông theo ng∆∞·ªùi d√πng
  const fileName =
    currentUser === "all"
      ? "tasks_all.json"
      : `tasks_${currentUser}.json`;

  link.download = fileName;
  link.click();
  document.getElementById("exportModal").style.display = "none";

}


  </script>
  <script>
  flatpickr("#startDate", {
    dateFormat: "d/m/Y",
    onChange: filterTasks
  });

  flatpickr("#endDate", {
    dateFormat: "d/m/Y",
    onChange: filterTasks
  });
  document.getElementById("clearDateFilter").addEventListener("click", () => {
  // X√≥a gi√° tr·ªã 2 input ng√†y
  document.getElementById("startDate")._flatpickr.clear();  // D√πng Flatpickr API clear()
  document.getElementById("endDate")._flatpickr.clear();

  // G·ªçi l·∫°i h√†m l·ªçc ƒë·ªÉ hi·ªÉn th·ªã t·∫•t c·∫£
  filterTasks();
});

document.getElementById("prevPageBtn").addEventListener("click", () => {
  if (currentPage > 1) {
    currentPage--;
    filterTasks();
  }
});

document.getElementById("nextPageBtn").addEventListener("click", () => {
  currentPage++;
  filterTasks();
});
// update file Json
function handleJsonImport(event) {
  const file = event.target.files[0];
  if (!file) return;

  if (currentUser === "all") {
    showToast("‚ùå Kh√¥ng th·ªÉ nh·∫≠p d·ªØ li·ªáu trong ch·∫ø ƒë·ªô 'T·∫•t c·∫£'!");
    event.target.value = ""; // reset input
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) throw new Error("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá");

      // L·∫•y danh s√°ch hi·ªán t·∫°i c·ªßa ng∆∞·ªùi d√πng ƒëang ch·ªçn
      const currentTasks = JSON.parse(localStorage.getItem(`tasks_${currentUser}`) || "[]");
      const merged = [...currentTasks];

      // L·ªçc tr√πng (tr√πng task + note + date)
      data.forEach(task => {
        const exists = merged.some(
          t =>
            t.task === task.task &&
            t.note === task.note &&
            t.date === task.date
        );
        if (!exists) merged.push(task);
      });

     localStorage.setItem(`tasks_${currentUser}`, JSON.stringify(merged));
 showToast(`‚úÖ ƒê√£ nh·∫≠p d·ªØ li·ªáu cho ${currentUser} (${data.length} d√≤ng, ${merged.length - currentTasks.length} m·ªõi)`);
document.getElementById("exportModal").style.display = "none";

  // ƒê·ªìng b·ªô l·∫°i sau khi localStorage ghi xong
  setTimeout(() => {
  tasks = JSON.parse(localStorage.getItem(`tasks_${currentUser}`) || "[]");
  if (typeof filterTasks === "function") filterTasks();
  }, 0);


    } catch (err) {
      console.error(err);
      showToast("‚ùå L·ªói khi ƒë·ªçc file JSON!");
    }
  };
  reader.readAsText(file);
}


function isValidTask(task) {
  return task &&
         typeof task === "object" &&
         task.task &&
         task.status &&
         ["Ch∆∞a l√†m", "ƒêang l√†m", "Ho√†n th√†nh"].includes(task.status) &&
         task.date;
}

function generateTaskKey(task) {
  // ƒê·∫£m b·∫£o note lu√¥n l√† chu·ªói
  return `${task.task}|${task.note || ""}|${task.date}`;
}
</script>

<!-- Modal ƒëƒÉng nh·∫≠p -->
<div id="unlockModal" class="modal" style="display: block;background-color: rgba(0, 0, 0, 0.4); 
  backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);  z-index: 9999 ; margin-bottom: 100px;">
  <div style="margin: 8% auto; padding: 45px; background-color: #f2f2f2; border-radius: 16px; width: 300px; text-align: center;  border-color: red; ">
    <img src="anh_ngau.jpg" alt="avatar" style="width: 75px; height: 75px; border-radius: 50%; object-fit: cover; margin-bottom: 16px;">
    <h2 style="color: #080707; font-size: 20px; margin-bottom: 20px;">Hi·∫øu</h2>
    <input type="password" id="unlockInput" placeholder="Nh·∫≠p m√£ kh√≥a" style="width: 80%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: solid; font-size: 14px;">
    <button onclick="checkUnlockCode()" style="background-color: #dba334; color: rgb(10, 1, 1); padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">M·ªû</button>
    <p id="unlockError" style="color: red; display: none;">Sai m√£ kh√≥a!</p>
  </div>
</div>

<script>

  function lockScreen() {
    const modal = document.getElementById("unlockModal");
    modal.style.display = "block";
    document.getElementById("unlockInput").value = "";
    document.getElementById("unlockError").style.display = "none";
    // document.body.style.overflow = "hidden"; // Kho√° cu·ªôn
  }
  function checkUnlockCode() {
    const code = document.getElementById("unlockInput").value.trim();
    if (code === "Hieu7894") {
      document.getElementById("unlockModal").style.display = "none";
    } else {
      document.getElementById("unlockError").style.display = "block";
    }
  }

  // C·∫•m thao t√°c b√™n ngo√†i khi ch∆∞a m·ªü kh√≥a
  document.addEventListener("DOMContentLoaded", () => {
    document.body.style.overflow = "hidden"; // ·∫®n cu·ªôn
    const interval = setInterval(() => {
      if (document.getElementById("unlockModal").style.display === "none") {
        document.body.style.overflow = "auto"; // M·ªü cu·ªôn
        clearInterval(interval);
      }
    }, 100);

    document.getElementById("unlockInput").addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        checkUnlockCode();
      }})
  });

  // üö´ Ch·∫∑n ESC khi modal ƒëang m·ªü
  document.addEventListener("keydown", function (event) {
    const modal = document.getElementById("unlockModal");
    if (modal && modal.style.display === "block" && event.key === "Escape") {
      event.preventDefault();
      event.stopPropagation();
    }
  });
  let inactivityTimer;
  // t·ª± ƒë·ªông kho√° m√†n h√¨nh sau 5p

function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    lockScreen();
  },  30* 60 * 1000); // 5 ph√∫t = 300.000 ms
}

// Theo d√µi c√°c ho·∫°t ƒë·ªông c·ªßa ng∆∞·ªùi d√πng
['mousemove', 'keydown', 'scroll', 'click'].forEach(event => {
  document.addEventListener(event, resetInactivityTimer);
});

// Kh·ªüi ƒë·ªông b·ªô ƒë·∫øm ngay khi trang load
document.addEventListener("DOMContentLoaded", resetInactivityTimer);

</script>
<script>

  

  function remindUnfinishedTasks() {
  const chuaLamDates = tasks
    .filter(task => (task.status || "").trim().toLowerCase() === "ch∆∞a l√†m")
    .map(task => task.date || "ch∆∞a r√µ ng√†y");

  const dangLamDates = tasks
    .filter(task => (task.status || "").trim().toLowerCase() === "ƒëang l√†m")
    .map(task => task.date || "ch∆∞a r√µ ng√†y");

  if (chuaLamDates.length > 0 || dangLamDates.length > 0) {
    let message = "üîî Ch√∫ √Ω:";

    if (chuaLamDates.length > 0) {
      const uniqueChuaLam = [...new Set(chuaLamDates)].join(", ");
      message += `\n ${chuaLamDates.length} c√¥ng vi·ªác ch∆∞a l√†m ng√†y ${uniqueChuaLam}`;
    }

    if (dangLamDates.length > 0) {
      const uniqueDangLam = [...new Set(dangLamDates)].join(", ");
      message += `\n ${dangLamDates.length} c√¥ng vi·ªác ƒëang l√†m ng√†y ${uniqueDangLam}`;
    }

    showToast(message);
    showSystemNotification("Nh·∫Øc nh·ªü c√¥ng vi·ªác", message);
    
  }
}



window.onload = () => {
  renderTable();
  remindUnfinishedTasks(); 
  // T·ª± ƒë·ªông nh·∫Øc sau m·ªói 60 gi√¢y
  setInterval(remindUnfinishedTasks, 6000000 ); // 60,000ms = 60s
};

</script>
<script>
function showWeatherModal() {
  const modal = document.getElementById("weatherModal");
  const content = document.getElementById("weatherContent");
  modal.style.display = "block";
  content.innerHTML = "ƒêang l·∫•y v·ªã tr√≠...";

  const API_KEY = "158d60200cbd4115b67e68cb32ad7561"; // thay b·∫±ng key ƒë√£ x√°c nh·∫≠n

  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&lang=vi&units=metric`)
          .then(res => res.json())
          .then(data => {
            const name = data.name;
            const country = data.sys.country;
            const temp = data.main.temp.toFixed(1);
            const humidity = data.main.humidity;
            const wind = data.wind.speed;
            const description = data.weather[0].description;

            // üß© Ki·ªÉm tra d·ªØ li·ªáu m∆∞a
            const rain = data.rain ? (data.rain["1h"] || data.rain["3h"] || 0) : 0;
            const rainText = rain > 0 
              ? `üåßÔ∏è C√≥ m∆∞a (${rain} mm/h)` 
              : "üå§Ô∏è Kh√¥ng m∆∞a";

            // ü™Ñ Hi·ªÉn th·ªã k·∫øt qu·∫£
            content.innerHTML = `
              <p><strong>üìç ƒê·ªãa ƒëi·ªÉm:</strong> ${name}, ${country}</p>
              <p><strong>üå°Ô∏è Nhi·ªát ƒë·ªô:</strong> ${temp}¬∞C</p>
              <p><strong>üíß ƒê·ªô ·∫©m:</strong> ${humidity}%</p>
              <p><strong>üí® Gi√≥:</strong> ${wind} m/s</p>
              <p><strong>üå•Ô∏è Tr·∫°ng th√°i:</strong> ${description}</p>
              <p><strong>üåßÔ∏è M∆∞a:</strong> ${rainText}</p>
            `;
          })
          .catch(err => {
            console.error(err);
            content.innerHTML = "Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt.";
          });
      },
      (error) => {
        console.warn(error);
        content.innerHTML = "Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠. H√£y cho ph√©p truy c·∫≠p v·ªã tr√≠ ƒë·ªÉ xem th·ªùi ti·∫øt.";
      }
    );
  } else {
    content.innerHTML = "Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.";
  }
}


function closeWeatherModal() {
  document.getElementById("weatherModal").style.display = "none";
}
// B·∫•m ESC ƒë·ªÉ t·∫Øt modal
document.addEventListener("keydown", function (event) {
  if (event.key === "Escape") {
    closeWeatherModal();
  }
});

</script>



<script>

// =============================
//  REPAIR MODULE (FULL JS FILE)
// =============================
// T·ªëi ∆∞u ‚Äî ch·∫°y theo t·ª´ng user, auto sync Firebase, ph√¢n trang, search, edit, delete
// =============================

let editingRepairIndex = -1;
let currentEditingIndex = -1;
let repairs = [];
let repairPage = 1;
const repairRowsPerPage = 5;

// =============================
//  FORMAT CHI PH√ç KHI NH·∫¨P (INPUT CH√çNH)
// =============================
const chiphiInput = document.getElementById("chiphiInput");
if (chiphiInput) {
  chiphiInput.addEventListener("input", function (e) {
    const input = e.target;
    const rawValue = input.value;
    const oldCursor = input.selectionStart;
    const digits = rawValue.replace(/\D/g, "");

    if (!digits) return (input.value = "");

    const formatted = digits.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

    let digitCountBeforeCursor = 0;
    for (let i = 0; i < oldCursor; i++) {
      if (/\d/.test(rawValue[i])) digitCountBeforeCursor++;
    }

    input.value = formatted;

    let newCursor = 0;
    let digitSeen = 0;
    for (let i = 0; i < formatted.length; i++) {
      if (/\d/.test(formatted[i])) digitSeen++;
      if (digitSeen === digitCountBeforeCursor) {
        newCursor = i + 1;
        break;
      }
    }

    setTimeout(() => input.setSelectionRange(newCursor, newCursor), 0);
  });
}

// =============================
//  SHOW MODAL + LOAD DATA USER
// =============================
async function showRepairModal() {
  window.__preventAutoSync = true;  // ‚õî ch·∫∑n sync t·∫°m th·ªùi

  document.getElementById("repairModal").style.display = "block";

  const username =
    window.currentUser ||
    localStorage.getItem("selectedUser") ||
    localStorage.getItem("currentUser") ||
    "default";

  let cloudRepairs =
    typeof window.syncRepairFromCloud === "function"
      ? await window.syncRepairFromCloud(username)
      : [];

  let localRepairs = JSON.parse(localStorage.getItem(`repairs_${username}`) || "[]");

  if (!localRepairs.length) {
    repairs = cloudRepairs;
  } else {
    const existingKeys = new Set(
      localRepairs.map(r => `${r.phutung}-${r.diadiem}-${r.thoigian}-${r.chiphi}`)
    );
    const newFromCloud = cloudRepairs.filter(
      r => !existingKeys.has(`${r.phutung}-${r.diadiem}-${r.thoigian}-${r.chiphi}`)
    );
    repairs = localRepairs.concat(newFromCloud);
  }

  localStorage.setItem(`repairs_${username}`, JSON.stringify(repairs));

  repairPage = 1;
  renderRepairTable();

  window.__preventAutoSync = false; // ‚úî b·∫≠t l·∫°i sync
}

window.showRepairModal = showRepairModal;



function closeRepairModal() {
  document.getElementById("repairModal").style.display = "none";
}

// =============================
//  ADD + EDIT REPAIR ROW
// =============================
function addRepairRow() {
  const username =
    window.currentUser ||
    localStorage.getItem("selectedUser") ||
    localStorage.getItem("currentUser") ||
    "default";

  const phutung = document.getElementById("phutungInput").value.trim();
  const diadiem = document.getElementById("diadiemInput").value.trim();
  const thoigian = document.getElementById("thoigianInput").value.trim();
  const chiphi = document.getElementById("chiphiInput").value.trim();

  const dateRegex = /^(0?[1-9]|[12][0-9]|3[01])\/(0?[1-9]|1[0-2])\/\d{4}$/;
  if (!phutung || !diadiem || !thoigian || !chiphi)
    return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
  if (!dateRegex.test(thoigian))
    return alert("Ng√†y sai ƒë·ªãnh d·∫°ng dd/mm/yyyy!");

  const parsedChiPhi = parseInt(chiphi.replace(/\./g, ""));

  if (editingRepairIndex >= 0) {
    repairs[editingRepairIndex] = {
      phutung,
      diadiem,
      thoigian,
      chiphi: parsedChiPhi,
    };
    showToast("‚úèÔ∏è ƒê√£ s·ª≠a th√¥ng tin!");
    editingRepairIndex = -1;
  } else {
    repairs.unshift({ phutung, diadiem, thoigian, chiphi: parsedChiPhi });
    showToast("‚úÖ ƒê√£ th√™m m·ªõi th√¥ng tin!");
  }

  localStorage.setItem(`repairs_${username}`, JSON.stringify(repairs));
  if (typeof dataChangedFlagSet === "function") dataChangedFlagSet();

  repairPage = 1;
  renderRepairTable();

  document.getElementById("phutungInput").value = "";
  document.getElementById("diadiemInput").value = "";
  document.getElementById("thoigianInput").value = "";
  document.getElementById("chiphiInput").value = "";
}

// =============================
// LOAD REPAIRS CHO USER
// =============================
function loadRepairsForUser() {
  const username =
    window.currentUser ||
    localStorage.getItem("selectedUser") ||
    localStorage.getItem("currentUser") ||
    "default";

  repairs = JSON.parse(localStorage.getItem(`repairs_${username}`) || "[]");
  renderRepairTable();
}

// =============================
//  RENDER TABLE + SEARCH + SORT + PAGE
// =============================
function renderRepairTable() {
  const username =
    window.currentUser ||
    localStorage.getItem("selectedUser") ||
    localStorage.getItem("currentUser") ||
    "default";

  repairs = JSON.parse(localStorage.getItem(`repairs_${username}`) || "[]");

  const tbody = document.getElementById("repairTableBody");
  tbody.innerHTML = "";

  const searchText = (document.getElementById("repairSearchInput")?.value || "").toLowerCase();

  const filteredRepairs = repairs.filter(item => {
    const pt = item.phutung?.toLowerCase() || "";
    const dd = item.diadiem?.toLowerCase() || "";
    const tg = item.thoigian?.toLowerCase() || "";
    const cp = item.chiphi?.toString() || "";
    return pt.includes(searchText) || dd.includes(searchText) || tg.includes(searchText) || cp.includes(searchText);
  });

  filteredRepairs.sort((a, b) => {
    const [d1, m1, y1] = a.thoigian.split("/").map(Number);
    const [d2, m2, y2] = b.thoigian.split("/").map(Number);
    return new Date(y2, m2 - 1, d2) - new Date(y1, m1 - 1, d1);
  });

  const total = filteredRepairs.reduce((sum, item) => sum + item.chiphi, 0);

  const startIndex = (repairPage - 1) * repairRowsPerPage;
  const paginatedRepairs = filteredRepairs.slice(startIndex, startIndex + repairRowsPerPage);

  paginatedRepairs.forEach((item, displayIndex) => {
    const row = document.createElement("tr");

    const originalIndex = repairs.findIndex(r =>
      r.phutung === item.phutung &&
      r.diadiem === item.diadiem &&
      r.thoigian === item.thoigian &&
      r.chiphi === item.chiphi
    );

    row.addEventListener("contextmenu", e => {
      e.preventDefault();
      editRepair(originalIndex);
    });

    row.addEventListener("dblclick", () => confirmDelete1(originalIndex));

    row.innerHTML = `
      <td>${startIndex + displayIndex + 1}</td>
      <td>${item.phutung}</td>
      <td>${item.diadiem}</td>
      <td>${item.thoigian}</td>
      <td>${item.chiphi.toLocaleString("vi-VN")} VND</td>
    `;

    tbody.appendChild(row);
  });

  document.getElementById("totalCost").textContent = `T·ªïng chi ph√≠: ${total.toLocaleString("vi-VN")} VND`;
  renderRepairPagination(filteredRepairs.length);
}

// =============================
//  PH√ÇN TRANG
// =============================
function renderRepairPagination(totalItems) {
  const pageCount = Math.ceil(totalItems / repairRowsPerPage);
  const container = document.getElementById("repairPagination");
  container.innerHTML = "";

  if (pageCount <= 1) return;

  const createButton = (text, page, disabled = false, active = false) => {
    const btn = document.createElement("button");
    btn.textContent = text;
    btn.disabled = disabled;
    if (active) btn.className = "active-page";
    btn.onclick = () => {
      repairPage = page;
      renderRepairTable();
    };
    container.appendChild(btn);
  };

  createButton("¬´", 1, repairPage === 1);
  createButton("<", repairPage - 1, repairPage === 1);

  const visibleRange = 2;
  let start = Math.max(1, repairPage - visibleRange);
  let end = Math.min(pageCount, repairPage + visibleRange);

  for (let i = start; i <= end; i++) createButton(i, i, false, i === repairPage);

  createButton(">", repairPage + 1, repairPage === pageCount);
  createButton("¬ª", pageCount, repairPage === pageCount);
}

// =============================
//  DELETE + EDIT
// =============================
function confirmDelete1(index) {
  const username =
    window.currentUser ||
    localStorage.getItem("currentUser") ||
    "default";

  const item = repairs[index];
  const message = `B·∫°n c√≥ ch·∫Øc mu·ªën xo√° d√≤ng sau?\n- Ph·ª• t√πng: ${item.phutung}\n- Chi ph√≠: ${item.chiphi.toLocaleString("vi-VN")} VND`;

  showConfirmModal(message, () => {
    repairs.splice(index, 1);
    showToast("üóëÔ∏è ƒê√£ xo√° ph·ª• t√πng s·ª≠a ch·ªØa");

    localStorage.setItem(`repairs_${username}`, JSON.stringify(repairs));
    if (typeof dataChangedFlagSet === "function") dataChangedFlagSet();

    if ((repairPage - 1) * repairRowsPerPage >= repairs.length) repairPage = Math.max(1, repairPage - 1);
    renderRepairTable();
  });
}

function editRepair(index) {
  const item = repairs[index];
  currentEditingIndex = index;

  document.getElementById("editPhutungInput").value = item.phutung;
  document.getElementById("editDiadiemInput").value = item.diadiem;
  document.getElementById("editThoigianInput").value = item.thoigian;
  document.getElementById("editChiphiInput").value = item.chiphi.toLocaleString("vi-VN");

  showEditRepairModal();
}

function showEditRepairModal() {
  const modal = document.getElementById("editRepairModal");
  if (modal) modal.style.display = "block";
}

function saveEditedRepair() {
  const pt = document.getElementById("editPhutungInput").value.trim();
  const dd = document.getElementById("editDiadiemInput").value.trim();
  const tg = document.getElementById("editThoigianInput").value.trim();
  const cp = document.getElementById("editChiphiInput").value.trim();

  const parsedCost = parseInt(cp.replace(/\./g, ""));
  const dateRegex = /^(0?[1-9]|[12][0-9]|3[01])\/(0?[1-9]|1[0-2])\/\d{4}$/;

  if (!pt || !dd || !tg || !cp) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
  if (!dateRegex.test(tg)) return alert("Sai ƒë·ªãnh d·∫°ng ng√†y. D√πng dd/mm/yyyy.");

  repairs[currentEditingIndex] = {
    phutung: pt,
    diadiem: dd,
    thoigian: tg,
    chiphi: parsedCost,
  };

  saveRepairs();
  renderRepairTable();
  closeEditRepairModal();
}
// Import JSON repairs
function handleRepairJsonImport(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function(e) {
    try {
      const jsonData = JSON.parse(e.target.result);

      if (!Array.isArray(jsonData)) {
        alert("‚ùå File JSON kh√¥ng h·ª£p l·ªá! ƒê·ªãnh d·∫°ng ph·∫£i l√† m·∫£ng []");
        return;
      }

      // L·∫•y user hi·ªán t·∫°i
      const username = window.currentUser || localStorage.getItem("currentUser") || "nhi";

      // L∆∞u v√†o localStorage theo t·ª´ng user
      localStorage.setItem(`repairs_${username}`, JSON.stringify(jsonData));

      // C·∫≠p nh·∫≠t bi·∫øn repairs ƒëang d√πng trong UI
      window.repairs = jsonData;

      // Render l·∫°i b·∫£ng
      if (typeof renderRepairTable === "function") {
        renderRepairTable();
      }

      showToast("üì• Import danh s√°ch s·ª≠a ch·ªØa th√†nh c√¥ng!");

      console.log("üì• IMPORTED REPAIRS:", jsonData);
    } catch (err) {
      console.error("Import JSON error:", err);
      alert("‚ùå File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng JSON!");
    }
  };

  reader.readAsText(file);
}


function closeEditRepairModal() {
  document.getElementById("editRepairModal").style.display = "none";
  currentEditingIndex = -1;
}

// Format trong modal edit
const editChiPhiInput = document.getElementById("editChiphiInput");
if (editChiPhiInput) {
  editChiPhiInput.addEventListener("input", function (e) {
    const digits = e.target.value.replace(/\D/g, "");
    e.target.value = digits.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  });
}

// =============================
//  SAVE + BACKUP + IMPORT
// =============================
function saveRepairs() {
  const username =
    window.currentUser ||
    localStorage.getItem("selectedUser") ||
    localStorage.getItem("currentUser") ||
    "default";

  localStorage.setItem(`repairs_${username}`, JSON.stringify(repairs));
  if (typeof dataChangedFlagSet === "function") dataChangedFlagSet();
}

function downloadBackupFile(data, filename = "repair-backup.json") {
  const blob = new Blob([JSON.stringify(data, null, 2)], {
    type: "application/json",
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// =============================
//  CLEAR ALL
// =============================
document.getElementById("clearAllRepairsBtn").addEventListener("click", function () {
  if (repairs.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xo√°.");

  showConfirmModal("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° to√†n b·ªô d·ªØ li·ªáu s·ª≠a ch·ªØa?", () => {
    const now = new Date().toISOString().replace(/[:.]/g, "-");
    const filename = `repair-backup-${now}.json`;

    downloadBackupFile(repairs, filename);

    repairs = [];
    saveRepairs();
    renderRepairTable();
    showToast("üóëÔ∏è ƒê√£ xo√° to√†n b·ªô & l∆∞u file backup");
  });
});

// =============================
//  CONFIRM MODAL
// =============================
let confirmAction = null;

function showConfirmModal(message, onConfirm) {
  document.getElementById("confirmMessage").textContent = message;
  document.getElementById("confirmModal").style.display = "flex";
  confirmAction = onConfirm;
}

document.getElementById("confirmYes").onclick = function () {
  if (typeof confirmAction === "function") confirmAction();
  document.getElementById("confirmModal").style.display = "none";
};

document.getElementById("confirmNo").onclick = function () {
  document.getElementById("confirmModal").style.display = "none";
};

// ESC ƒë√≥ng modal

</script>
<script type="module">
import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// üß† L∆∞u tr·∫°ng th√°i ch·ªânh s·ª≠a
window.cheDoSuaGhiChu = false;

// üß© H√†m m·ªü modal ghi ch√∫
window.moModalGhiChu = async function () {
  const user = window.currentUser || localStorage.getItem("currentUser") || "all";
  const textarea = document.getElementById("noiDungGhiChu");

  if (!user || user === "all") {
    showToast("‚ö†Ô∏è Kh√¥ng th·ªÉ m·ªü ghi ch√∫ trong ch·∫ø ƒë·ªô 'T·∫•t c·∫£'");
    return;
  }

  // üîπ T·∫£i ghi ch√∫ t·ª´ local tr∆∞·ªõc
  const daLuu = localStorage.getItem(`ghiChu_${user}`) || "";
  const thoiGianLuu = localStorage.getItem(`ghiChu_lastSaved_${user}`);
  textarea.value = daLuu;
  textarea.setAttribute("readonly", true);
  textarea.classList.add("readonly-field");
  cheDoSuaGhiChu = false;
  document.getElementById("btnSuaGhiChu").textContent = "‚úèÔ∏è S·ª≠a";
  document.getElementById("modalGhiChu").style.display = "flex";
  capNhatThoiGianLuu(thoiGianLuu);

  // üîπ Th·ª≠ ƒë·ªìng b·ªô t·ª´ Firebase (n·∫øu c√≥)
  try {
    const ref = doc(window.db, "users", user);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const data = snap.data();
      const cloudNote = data.notes || "";
      if (cloudNote !== daLuu) {
        textarea.value = cloudNote;
        localStorage.setItem(`ghiChu_${user}`, cloudNote);
      }
    }
  } catch (err) {
    console.warn("Kh√¥ng t·∫£i ƒë∆∞·ª£c ghi ch√∫ t·ª´ Firebase:", err);
  }
};

// üß© ƒê√≥ng modal
window.dongModalGhiChu = function () {
  document.getElementById("modalGhiChu").style.display = "none";
};

// üß© B·∫≠t ch·∫ø ƒë·ªô s·ª≠a ho·∫∑c l∆∞u
window.batCheDoSuaGhiChu = async function () {
  const user = window.currentUser || localStorage.getItem("currentUser");
  const textarea = document.getElementById("noiDungGhiChu");

  if (!user || user === "all") {
    showToast("‚ö†Ô∏è Kh√¥ng th·ªÉ l∆∞u trong ch·∫ø ƒë·ªô 'T·∫•t c·∫£'");
    return;
  }

  if (!cheDoSuaGhiChu) {
    // ‚úèÔ∏è Chuy·ªÉn sang ch·∫ø ƒë·ªô s·ª≠a
    textarea.removeAttribute("readonly");
    textarea.classList.remove("readonly-field");
    textarea.focus();
    cheDoSuaGhiChu = true;
    document.getElementById("btnSuaGhiChu").textContent = "üíæ L∆∞u";
  } else {
    // üíæ L∆∞u ghi ch√∫ v√†o local + Firebase
    const noiDung = textarea.value.trim();
    const thoiGianHienTai = new Date().toLocaleString("vi-VN");

    localStorage.setItem(`ghiChu_${user}`, noiDung);
    localStorage.setItem(`ghiChu_lastSaved_${user}`, thoiGianHienTai);
    capNhatThoiGianLuu(thoiGianHienTai);

    // üîÑ ƒê·ªìng b·ªô l√™n Firestore
    try {
      await setDoc(doc(window.db, "users", user), { notes: noiDung }, { merge: true });
      showToast("‚úÖ Ghi ch√∫ ƒë√£ ƒë∆∞·ª£c l∆∞u & ƒë·ªìng b·ªô Cloud.");
    } catch (err) {
      console.error("L·ªói l∆∞u ghi ch√∫ l√™n Firebase:", err);
      showToast("‚ö†Ô∏è L∆∞u c·ª•c b·ªô th√†nh c√¥ng, nh∆∞ng ch∆∞a ƒë·ªìng b·ªô ƒë∆∞·ª£c Cloud!");
    }

    textarea.setAttribute("readonly", true);
    textarea.classList.add("readonly-field");
    cheDoSuaGhiChu = false;
    document.getElementById("btnSuaGhiChu").textContent = "‚úèÔ∏è S·ª≠a";

    // Hi·ªáu ·ª©ng highlight khi l∆∞u
    textarea.classList.add("highlight-save");
    setTimeout(() => textarea.classList.remove("highlight-save"), 500);
  }
};

// üß© C·∫≠p nh·∫≠t th·ªùi gian l∆∞u hi·ªÉn th·ªã
window.capNhatThoiGianLuu = function (thoiGian) {
  const lbl = document.getElementById("thoiGianLuu");
  lbl.textContent = thoiGian
    ? `üïí L·∫ßn l∆∞u g·∫ßn nh·∫•t: ${thoiGian}`
    : "üïí Ch∆∞a c√≥ l·∫ßn l∆∞u n√†o";
};

// ‚å®Ô∏è ƒê√≥ng modal khi b·∫•m ESC
document.addEventListener("keydown", (event) => {
  const modal = document.getElementById("modalGhiChu");
  if (event.key === "Escape" && modal.style.display === "flex") {
    dongModalGhiChu();
  }
});
</script>

<!-- --- USER SWITCH SCRIPT: start --- -->
<script>
 currentUser = localStorage.getItem("currentUser") || "nhi";

// Chuy·ªÉn d·ªØ li·ªáu c≈© sang Nhi n·∫øu c√≥
if (localStorage.getItem("tasks") && !localStorage.getItem("tasks_nhi")) {
  localStorage.setItem("tasks_nhi", localStorage.getItem("tasks"));
  localStorage.removeItem("tasks");
}

// --- H√†m n·∫°p d·ªØ li·ªáu theo ng∆∞·ªùi d√πng ---
function getTasksByUser(user) {
  if (user === "all") {
    const nhi = JSON.parse(localStorage.getItem("tasks_nhi") || "[]");
    const quan = JSON.parse(localStorage.getItem("tasks_quan") || "[]");
    return [...nhi, ...quan];
  } else {
    return JSON.parse(localStorage.getItem("tasks_" + user) || "[]");
  }
}

function loadUserTasks() {
  tasks = getTasksByUser(currentUser);
  if (typeof filterTasks === "function") filterTasks();
}

// --- Ghi d·ªØ li·ªáu ---
function saveToLocalStorage() {
  if (currentUser === "all") return;
  localStorage.setItem("tasks_" + currentUser, JSON.stringify(tasks));
}

// --- Chuy·ªÉn ng∆∞·ªùi d√πng ---
function changeUser() {
  const select = document.getElementById("userSelect");
  if (!select) return;

  currentUser = select.value;
  localStorage.setItem("currentUser", currentUser);
  // Reset v·ªÅ trang ƒë·∫ßu (n·∫øu c√≥ ph√¢n trang)
  currentPage = 1;
  // ‚úÖ G·∫Øn v√†o window ƒë·ªÉ c√°c file kh√°c th·∫•y
  window.currentUser = select.value;

  // L∆∞u v√†o localStorage
  localStorage.setItem("currentUser", window.currentUser);
  // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
  filterTasks();
  updateUIForUser();

  // üîπ C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t "Th√™m"
  const addBtn = document.getElementById("addBtn"); // ƒë√∫ng id trong file c·ªßa b·∫°n
  if (addBtn) {
    const disable = currentUser === "all";
    addBtn.disabled = disable;
    addBtn.style.opacity = disable ? "0.6" : "1";
    addBtn.style.cursor = disable ? "not-allowed" : "pointer";
  }

  // üîπ (T√πy ch·ªçn) c·∫≠p nh·∫≠t c√°c n√∫t kh√°c
  const clearBtn = document.getElementById("clearBtn");
  if (clearBtn) clearBtn.disabled = currentUser === "all";
  const importInput = document.getElementById("importJsonInput");
  if (importInput) importInput.disabled = currentUser === "all";

  showToast(`ƒê√£ chuy·ªÉn sang: ${currentUser === "all" ? "T·∫•t c·∫£" : currentUser}`);
  loadUserTasks();
  // üîÅ T·ª± ƒë·ªông ƒë·ªìng b·ªô d·ªØ li·ªáu t·ª´ Firebase khi ƒë·ªïi user
if (typeof window.syncFromFirebase === "function" && currentUser !== "all") {
  window.syncFromFirebase();
}


}


// --- B·∫£o v·ªá khi ·ªü ch·∫ø ƒë·ªô t·∫•t c·∫£ ---
function editableCheck() {
  if (currentUser === "all") {
    showToast("‚ùå Ch·∫ø ƒë·ªô 'T·∫•t c·∫£' ch·ªâ xem - kh√¥ng th·ªÉ ch·ªânh s·ª≠a.");
    closeModal('confirmDeleteModal');
    return false;
  }
  return true;
}

// --- Ghi ƒë√® c√°c h√†m th√™m / s·ª≠a / x√≥a ƒë·ªÉ ki·ªÉm tra ng∆∞·ªùi d√πng ---
const origAddTask = typeof addTask === "function" ? addTask : null;
if (origAddTask) {
  addTask = function() {
    if (!editableCheck()) return;
    origAddTask();
  };
}

if (typeof toggleEditTask === "function") {
  const orig = toggleEditTask;
  toggleEditTask = function() {
    if (!editableCheck()) return;
    orig();
  };
}

if (typeof confirmDelete === "function") {
  const orig = confirmDelete;
  confirmDelete = function() {
    if (!editableCheck()) return;
    orig();
  };
}

// --- C·∫≠p nh·∫≠t khi trang t·∫£i ---
document.addEventListener("DOMContentLoaded", () => {
  const select = document.getElementById("userSelect");
  if (select) select.value = currentUser;
  document.getElementById("addBtn").disabled = (currentUser === "all");
  loadUserTasks();
});
</script>
<!-- --- USER SWITCH SCRIPT: end --- -->
<script>
  // --- QU·∫¢N L√ù NG∆Ø·ªúI D√ôNG ƒê·ªòNG ---
let currentUser = localStorage.getItem("currentUser") || "nhi";

// Kh·ªüi t·∫°o danh s√°ch ng∆∞·ªùi d√πng m·∫∑c ƒë·ªãnh
function loadUsers() {
  let users = JSON.parse(localStorage.getItem("users")) || ["nhi", "quan", "all"];
  const select = document.getElementById("userSelect");
  select.innerHTML = "";

  // T·∫°o c√°c option t·ª´ danh s√°ch
  users.forEach(u => {
    const opt = document.createElement("option");
    opt.value = u;
    opt.textContent = (u === "nhi") ? "Ms Nhi" :
                      (u === "quan") ? "Mr Quan" :
                      (u === "all") ? "T·∫•t c·∫£" : u;
    select.appendChild(opt);
  });

  // Th√™m option ƒë·∫∑c bi·ªát ƒë·ªÉ th√™m user m·ªõi
  const addOpt = document.createElement("option");
  addOpt.value = "__add_new__";
  addOpt.textContent = "‚ûï Th√™m ng∆∞·ªùi d√πng m·ªõi";
  select.appendChild(addOpt);

  // Ch·ªçn l·∫°i ng∆∞·ªùi d√πng hi·ªán t·∫°i
  select.value = currentUser;
}

// Khi ƒë·ªïi ng∆∞·ªùi d√πng
function changeUser() {
  const select = document.getElementById("userSelect");
  const value = select.value;

  if (value === "__add_new__") {
    // N·∫øu ch·ªçn "Th√™m ng∆∞·ªùi d√πng m·ªõi"
    select.value = currentUser;
    document.getElementById("addUserModal").style.display = "block";
    document.getElementById("newUserName").value = "";
    return;
  }

  currentUser = value;
  localStorage.setItem("currentUser", currentUser);

  // üîπ L·∫•y d·ªØ li·ªáu ƒë√∫ng theo user
  if (currentUser === "all") {
    const users = JSON.parse(localStorage.getItem("users")) || [];
    let allTasks = [];
    users.forEach(u => {
      if (u !== "all") {
        const data = JSON.parse(localStorage.getItem(`tasks_${u}`) || "[]");
        allTasks = allTasks.concat(data);
      }
    });
    tasks = allTasks;
  } else {
    tasks = JSON.parse(localStorage.getItem(`tasks_${currentUser}`) || "[]");
  }

  // C·∫≠p nh·∫≠t giao di·ªán danh s√°ch
  currentPage = 1;
  filterTasks();

  // üîπ C·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c n√∫t thao t√°c
  const addBtn = document.getElementById("addBtn");
  if (addBtn) {
    const disable = currentUser === "all";
    addBtn.disabled = disable;
    addBtn.style.opacity = disable ? "0.6" : "1";
    addBtn.style.cursor = disable ? "not-allowed" : "pointer";
  }

  const clearBtn = document.getElementById("clearBtn");
  if (clearBtn) clearBtn.disabled = currentUser === "all";
  const importInput = document.getElementById("importJsonInput");
  if (importInput) importInput.disabled = currentUser === "all";

  // üîπ Hi·ªÉn th·ªã th√¥ng b√°o
  showToast(`üë§ ƒê√£ chuy·ªÉn sang ng∆∞·ªùi d√πng: ${currentUser === "all" ? "T·∫•t c·∫£" : currentUser}`);
}


// Th√™m ng∆∞·ªùi d√πng m·ªõi
function addNewUser() {
  const name = document.getElementById("newUserName").value.trim();
  if (!name) {
    showToast("Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi d√πng!");
    return;
  }

  // L·∫•y danh s√°ch user t·ª´ localStorage
  let users = JSON.parse(localStorage.getItem("users")) || ["nhi", "quan", "all"];
  if (users.includes(name)) {
    showToast("T√™n ng∆∞·ªùi d√πng ƒë√£ t·ªìn t·∫°i!");
    return;
  }

  // L∆∞u user m·ªõi v√†o danh s√°ch
  users.push(name);
  localStorage.setItem("users", JSON.stringify(users));
  localStorage.setItem(`tasks_${name}`, JSON.stringify([]));

  // Th√™m v√†o dropdown
  const select = document.getElementById("userSelect");
  const option = document.createElement("option");
  option.value = name;
  option.textContent = name.charAt(0).toUpperCase() + name.slice(1);
  const allOption = select.querySelector("option[value='all']");
  if (allOption) select.insertBefore(option, allOption);
  else select.appendChild(option);

  // Chuy·ªÉn sang ng∆∞·ªùi m·ªõi
  currentUser = name;
  localStorage.setItem("currentUser", currentUser);

  // Reset d·ªØ li·ªáu tr√°nh d√≠nh d·ªØ li·ªáu c≈©
  tasks = [];
  saveToLocalStorage();

  // C·∫≠p nh·∫≠t UI
  select.value = name;
  changeUser();
  
  document.getElementById("newUserName").value = "";
  closeModal("addUserModal");
  currentPage = 1;
  filterTasks();

  showToast(`‚úÖ ƒê√£ th√™m ng∆∞·ªùi d√πng "${name}" v√† chuy·ªÉn sang ng∆∞·ªùi n√†y.`);
}


// X√≥a ng∆∞·ªùi d√πng hi·ªán t·∫°i
function deleteCurrentUser() {
  if (currentUser === "all") {
  showToast("‚ö†Ô∏è Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi d√πng 'T·∫•t c·∫£' v√¨ ƒë√¢y l√† ch·∫ø ƒë·ªô t·ªïng h·ª£p d·ªØ li·ªáu!");
  return;
  }

  if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng "${currentUser}" v√† to√†n b·ªô d·ªØ li·ªáu c·ªßa h·ªç kh√¥ng?`))
    return;

  let users = JSON.parse(localStorage.getItem("users")) || [];
  users = users.filter(u => u !== currentUser);
  localStorage.setItem("users", JSON.stringify(users));

  localStorage.removeItem(`tasks_${currentUser}`);

  showToast(`üóëÔ∏è ƒê√£ x√≥a ng∆∞·ªùi d√πng: ${currentUser}`);

  currentUser = "all";
  localStorage.setItem("currentUser", currentUser);

  closeModal("addUserModal");
  loadUsers();
  changeUser();
}

// --- G·ªçi khi load trang ---
document.addEventListener("DOMContentLoaded", loadUsers);

</script>
<script>
 // üì¢ Th√¥ng b√°o ngo√†i m√†n h√¨nh (c√≥ t∆∞∆°ng t√°c khi nh·∫•p)
function showSystemNotification(title, message, type = "info") {
  if (!("Notification" in window)) return;

  // üé® Bi·ªÉu t∆∞·ª£ng & √¢m thanh theo lo·∫°i
  const icons = {
    info: "https://cdn-icons-png.flaticon.com/512/906/906343.png",
    success: "https://cdn-icons-png.flaticon.com/512/190/190411.png",
    warning: "https://cdn-icons-png.flaticon.com/512/595/595067.png",
    error: "https://cdn-icons-png.flaticon.com/512/564/564619.png",
    task: "https://cdn-icons-png.flaticon.com/512/1828/1828817.png"
  };

  

  const icon = icons[type] || icons.info;
  

  // ‚úÖ N·∫øu c√≥ quy·ªÅn th√¨ hi·ªÉn th·ªã lu√¥n
  if (Notification.permission === "granted") {
    const noti = new Notification("‚ö†Ô∏è " + title, {
      body: message,
      icon: icon,
      badge: icon,
      silent: false,
      requireInteraction: true // gi·ªØ l·∫°i ƒë·∫øn khi b·∫•m ho·∫∑c ƒë√≥ng
    });

   

    // ‚è∞ T·ª± ƒë√≥ng sau 10 gi√¢y
    //setTimeout(() => noti.close(), 10000);

    // üñ±Ô∏è Khi ng∆∞·ªùi d√πng nh·∫•p v√†o th√¥ng b√°o
    noti.onclick = function (event) {
      event.preventDefault();
      // M·ªü ho·∫∑c chuy·ªÉn sang ph·∫ßn m·ªÅm (tab ch√≠nh)
      window.focus(); // ƒë∆∞a tab hi·ªán t·∫°i ra tr∆∞·ªõc
      window.location.href = "index_with_users_plus.html"; // ho·∫∑c ƒë∆∞·ªùng d·∫´n kh√°c c·ªßa ph·∫ßn m·ªÅm
      noti.close();
    };
  }

  // üö™ N·∫øu ch∆∞a xin quy·ªÅn
  else if (Notification.permission !== "denied") {
    Notification.requestPermission().then(permission => {
      if (permission === "granted") {
        showSystemNotification(title, message, type);
      }
    });
  }
}
</script>

<!-- Auto-sync to Firestore (injected by assistant) -->
<script type="module">
  import { setDoc, doc, deleteDoc, getDoc, getDocs  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const db = window.db;

  // Simple toast helper (uses existing showToast if present, otherwise fallback)
  function tinyToast(msg) {
    try { if (typeof showToast === 'function') return showToast(msg); } catch(e){}
    // fallback small temporary toast
    const c = document.getElementById('toastContainer') || document.body;
    const t = document.createElement('div');
    t.style = "position:fixed;right:20px;bottom:20px;background:#2e7d32;color:#fff;padding:8px 12px;border-radius:6px;z-index:99999;box-shadow:0 3px 8px rgba(0,0,0,0.2);font-size:13px";
    t.innerText = msg;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),3000);
  }

  let dataChanged = false;
  let syncInProgress = false;

  // mark changed
  function dataChangedFlagSet(){
    dataChanged = true;
    tryAutoSync();
  }

  // Try to auto sync if online
  function tryAutoSync(){
    if (navigator.onLine && dataChanged && !syncInProgress) {
      syncToFirestoreAll();
    }
  }

  // Override localStorage.setItem to mark changes (non-destructive)
  (function(){
    const origSet = localStorage.setItem.bind(localStorage);
    localStorage.setItem = function(k,v){
      origSet(k,v);
      if (k.startsWith('tasks_') || k === 'repairs' || k === 'notes' || k === 'noiDungGhiChu') {
        dataChangedFlagSet();
      }
      return true;
    };
  })();

  // Core: delete doc then set doc for each user document
  async function syncToFirestoreAll(){
    if (!db) {
      console.warn('Firestore not initialized');
      return;
    }
    if (window.__preventAutoSync) return;// ch·∫∑n moda sua xe

    if (syncInProgress) return;
    syncInProgress = true;
    tinyToast('üîÑ ƒê·ªìng b·ªô Firebase...');

   try {
  // collect all users from localStorage keys tasks_*
  const users = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith("tasks_")) {
      users.push(key.replace("tasks_", ""));
    }
  }

  // make unique
  const uniqUsers = Array.from(new Set(users));

  // üîÑ ƒê·ªìng b·ªô t·ª´ng user an to√†n (merge, kh√¥ng ghi ƒë√® ghi ch√∫)
  for (const username of uniqUsers) {
    const tasks = JSON.parse(localStorage.getItem("tasks_" + username) || "[]");
     const repairs = JSON.parse(localStorage.getItem("repairs_" + username) || "[]");


    // üîπ L·∫•y ghi ch√∫ theo user (∆∞u ti√™n per-user)
    const perUserNoteKey = `ghiChu_${username}`;
    const localNote =
      localStorage.getItem(perUserNoteKey) ||
      localStorage.getItem("noiDungGhiChu") ||
      localStorage.getItem("notes") ||
      "";

    const userRef = doc(db, "users", username);
    try {
      const snap = await getDoc(userRef);
      const cloudData = snap.exists() ? snap.data() : {};

      // üî∏ Ch·ªçn ghi ch√∫ cu·ªëi c√πng h·ª£p l√Ω nh·∫•t
      let finalNote = cloudData.notes || "";
      if (localNote && localNote.trim() !== "") {
        finalNote = localNote; // Local c√≥ n·ªôi dung th√¨ ∆∞u ti√™n
      } else if (!localNote && cloudData.notes) {
        // Local tr·ªëng, Cloud c√≥ ‚Üí gi·ªØ Cloud v√† c·∫≠p nh·∫≠t local
        localStorage.setItem(perUserNoteKey, cloudData.notes);
        finalNote = cloudData.notes;
      }

      // ---- AN TO√ÄN CHO TASKS & NOTES ----
const payload = {
  username,
  tasks,             // gi·ªØ nguy√™n
  notes: finalNote,  // gi·ªØ nguy√™n
  lastSync: new Date().toISOString(),
};

// ---- FIX KH√îNG GHI ƒê√à REPAIRS ----
// Ch·ªâ ghi l√™n Cloud n·∫øu local c√≥ d·ªØ li·ªáu th·∫≠t
if (Array.isArray(repairs) && repairs.length > 0) {
  payload.repairs = repairs;
}

// ---- Ghi merge ----
await setDoc(userRef, payload, { merge: true });


      console.log(`‚úÖ ƒê·ªìng b·ªô user ${username}: note="${finalNote}"`);
    } catch (e) {
      console.warn("‚ö†Ô∏è L·ªói ƒë·ªìng b·ªô user", username, e);
    }
  }

  tinyToast("‚úÖ ƒê·ªìng b·ªô Firebase th√†nh c√¥ng");
  dataChanged = false;
} catch (err) {
  console.error("Sync error", err);
  tinyToast("‚ö†Ô∏è L·ªói ƒë·ªìng b·ªô Firebase");
} finally {
  syncInProgress = false;
}

  }

  // sync on online event and on load if online
  window.addEventListener('online', tryAutoSync);
  window.addEventListener('load', () => { tryAutoSync(); });

  // expose for manual control if needed
  window.syncToFirestoreAll = syncToFirestoreAll;
  window.dataChangedFlagSet = dataChangedFlagSet;


  
</script>
<script type="module">
  import { getFirestore, doc, getDoc } 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // üîÑ ƒê·ªìng b·ªô t·ª´ Firestore v·ªÅ Local
  window.syncFromFirebase = async function() {
    const user = localStorage.getItem("currentUser") || window.currentUser || "nhi";
    window.currentUser = user;
    console.log("üë§ ƒê·ªìng b·ªô d·ªØ li·ªáu cho user:", user);

    // üîπ Truy c·∫≠p document: users/{user}
    const userDocRef = doc(window.db, "users", user);
    console.log("üìÇ Truy c·∫≠p Firestore document:", `users/${user}`);

    try {
      const docSnap = await getDoc(userDocRef);

      if (!docSnap.exists()) {
        tinyShowToast("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ng∆∞·ªùi d√πng n√†y tr√™n Cloud!");
        return;
      }

      // üîπ L·∫•y m·∫£ng tasks trong document
      const data = docSnap.data();
      const cloudTasks = Array.isArray(data.tasks) ? data.tasks : [];
      console.log("üì• D·ªØ li·ªáu t·∫£i t·ª´ Firebase:", cloudTasks);

      // üîπ L·∫•y d·ªØ li·ªáu local hi·ªán t·∫°i
      const localTasks = JSON.parse(localStorage.getItem(`tasks_${user}`) || "[]");

      // üîπ So s√°nh v√† g·ªôp (merge)
      const merged = [...localTasks];
      let addedCount = 0;

      cloudTasks.forEach(cloudTask => {
        const exists = localTasks.some(
          local =>
            local.task === cloudTask.task &&
            (local.note || "") === (cloudTask.note || "") &&
            local.date === cloudTask.date
        );
        if (!exists) {
          merged.push(cloudTask);
          addedCount++;
        }
      });

      // üîπ C·∫≠p nh·∫≠t l·∫°i Local n·∫øu c√≥ d·ªØ li·ªáu m·ªõi
      // üîπ C·∫≠p nh·∫≠t l·∫°i LocalStorage (n·∫øu c√≥ d·ªØ li·ªáu m·ªõi)
if (addedCount > 0) {
  localStorage.setItem(`tasks_${user}`, JSON.stringify(merged));
  window.tasks = merged;
} else {
  // n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu m·ªõi, v·∫´n c·∫ßn ƒë·ªìng b·ªô window.tasks t·ª´ local
  window.tasks = JSON.parse(localStorage.getItem(`tasks_${user}`) || "[]");
}
// üÜï üîπ ƒê·ªìng b·ªô ghi ch√∫ (notes)
if (data.notes !== undefined) {
  localStorage.setItem("ghiChu", data.notes || "");
  console.log("üóíÔ∏è ƒê√£ c·∫≠p nh·∫≠t ghi ch√∫ t·ª´ Firebase:", data.notes);
}

// ‚úÖ Lu√¥n c·∫≠p nh·∫≠t giao di·ªán
if (typeof window.filterTasks === "function") window.filterTasks();
window.tasks = JSON.parse(localStorage.getItem(`tasks_${user}`) || "[]");

  // üîπ Log ki·ªÉm tra
  console.log("üß© Ki·ªÉm tra window.tasks sau sync:", window.tasks);

  // ‚úÖ Lu√¥n render l·∫°i danh s√°ch
  if (typeof window.filterTasks === "function") {
    console.log("üîÅ G·ªçi filterTasks() ƒë·ªÉ c·∫≠p nh·∫≠t UI");
    window.filterTasks();
  } else {
    console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y h√†m filterTasks!");
  }

tinyShowToast(
  addedCount > 0
    ? `‚úÖ ƒê·ªìng b·ªô th√†nh c√¥ng ‚Äî th√™m ${addedCount} c√¥ng vi·ªác m·ªõi.`
    : "‚òÅÔ∏è D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t, kh√¥ng c√≥ g√¨ m·ªõi."
);

    } catch (err) {
      console.error(err);
      tinyShowToast("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ Firebase!");
    }
  };

  // üîî Th√¥ng b√°o nh·ªè g·ªçn
  window.tinyShowToast = function(msg) {
    const el = document.createElement("div");
    el.textContent = msg;
    Object.assign(el.style, {
      position: "fixed",
      bottom: "20px",
      right: "20px",
      background: "#2ecc71",
      color: "white",
      padding: "10px 15px",
      borderRadius: "8px",
      boxShadow: "0 2px 10px rgba(0,0,0,0.3)",
      zIndex: 9999,
      fontWeight: "bold"
    });
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3500);
  };
</script>
<!-- th√™m user xo√° user -->
<script type="module">
import { 
  collection, getDocs, setDoc, doc, deleteDoc, getDoc 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ======================================================
   üîπ 1. T·∫°o user m·∫∑c ƒë·ªãnh n·∫øu Firebase tr·ªëng
====================================================== */
async function initDefaultUsers() {
  const usersCol = collection(window.db, "users");
  const snapshot = await getDocs(usersCol);

  if (snapshot.empty) {
    const defaults = [
      { username: "Ms Nhi" },
      { username: "Mr Quan" },
      { username: "Hieu" }
    ];
    for (const u of defaults) {
      await setDoc(doc(usersCol, u.username), {
        username: u.username,
        tasks: [],
        repairs: [],
        notes: "",
        lastSync: new Date().toISOString()
      });
    }
    console.log("‚úÖ ƒê√£ kh·ªüi t·∫°o danh s√°ch user m·∫∑c ƒë·ªãnh trong Firebase.");
  }
}

/* ======================================================
   üîπ 2. T·∫£i danh s√°ch user t·ª´ Firebase
====================================================== */
async function loadUsersFromFirebase(selectAfterLoad = null) {
  const userSelect = document.getElementById("userSelect");
  if (!userSelect) return;

  userSelect.innerHTML = "";

  try {
    const usersCol = collection(window.db, "users");
    const snapshot = await getDocs(usersCol);
    const users = [];

    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      if (data.username) users.push(data.username);
    });

    users.sort((a, b) => a.localeCompare(b, "vi"));

    // T·∫°o option cho t·ª´ng user
    users.forEach((name) => {
      const opt = document.createElement("option");
      opt.value = name.trim();
      opt.textContent = name.trim();
      userSelect.appendChild(opt);
    });

    // Th√™m option "T·∫•t c·∫£"
    const allOpt = document.createElement("option");
    allOpt.value = "all";
    allOpt.textContent = "T·∫•t c·∫£";
    userSelect.appendChild(allOpt);

    // Ch·ªçn user ph√π h·ª£p sau khi load
    const lastUser = selectAfterLoad || localStorage.getItem("currentUser") || users[0] || "all";
    userSelect.value = lastUser;

    if (typeof window.changeUser === "function") {
      window.changeUser();
    }

    console.log("‚úÖ ƒê√£ t·∫£i danh s√°ch user t·ª´ Firebase:", users);
  } catch (err) {
    console.error("‚ùå L·ªói khi t·∫£i user t·ª´ Firebase:", err);
  }
}

/* ======================================================
   üîπ 3. Th√™m user m·ªõi
====================================================== */
window.addNewUser = async function () {
  const input = document.getElementById("newUserName");
  const newName = input.value.trim();
  if (!newName) {
    alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi d√πng!");
    return;
  }

  const usersCol = collection(window.db, "users");
  const newDocRef = doc(usersCol, newName);

  try {
    // ki·ªÉm tra tr√πng
    const existing = await getDoc(newDocRef);
    if (existing.exists()) {
      showToast(`‚ö†Ô∏è User "${newName}" ƒë√£ t·ªìn t·∫°i!`);
      input.value = "";
      closeModal("addUserModal");
      return;
    }

    // t·∫°o m·ªõi
    await setDoc(newDocRef, {
      username: newName,
      tasks: [],
      repairs: [],
      notes: "",
      lastSync: new Date().toISOString()
    });

    showToast(`‚úÖ ƒê√£ th√™m user "${newName}" l√™n Firebase.`);
    input.value = "";
    closeModal("addUserModal");

    // t·∫£i l·∫°i danh s√°ch user v√† ch·ªçn user m·ªõi
    await loadUsersFromFirebase(newName);

  } catch (err) {
    console.error("‚ùå L·ªói khi th√™m user:", err);
    showToast("‚ùå Kh√¥ng th·ªÉ th√™m user m·ªõi!");
  }
};

/* ======================================================
   üîπ 4. X√≥a user hi·ªán t·∫°i
====================================================== */
window.deleteCurrentUser = async function () {
  const userSelect = document.getElementById("userSelect");
  const currentUser = userSelect.value;

  if (!currentUser || currentUser === "all") {
    showToast("‚ö†Ô∏è Kh√¥ng th·ªÉ xo√° ch·∫ø ƒë·ªô 'T·∫•t c·∫£'");
    return;
  }

  if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën xo√° user "${currentUser}"?`)) return;

  try {
    await deleteDoc(doc(window.db, "users", currentUser));
    localStorage.removeItem(`tasks_${currentUser}`);

    showToast(`üóëÔ∏è ƒê√£ xo√° user "${currentUser}" kh·ªèi Firebase.`);
    closeModal("addUserModal");

    // t·∫£i l·∫°i danh s√°ch user, ch·ªçn user ƒë·∫ßu ti√™n
    await loadUsersFromFirebase();

  } catch (err) {
    console.error("‚ùå L·ªói khi xo√° user:", err);
    showToast("‚ùå Kh√¥ng th·ªÉ xo√° user n√†y!");
  }
};

/* ======================================================
   üîπ 5. T·ª± ƒë·ªông kh·ªüi ƒë·ªông khi m·ªü trang
====================================================== */
window.addEventListener("DOMContentLoaded", async () => {
  await initDefaultUsers();
  await loadUsersFromFirebase();
});
</script>
<script>
window.openModal = function(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = "block";
};

window.closeModal = function(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = "none";
};
</script>


<script type="module">
import {
  getFirestore, collection, doc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

window.db = getFirestore();

// üîÑ L·∫§Y D·ªÆ LI·ªÜU S·ª¨A XE T·ª™ CLOUD ‚Üí MERGE ‚Üí L∆ØU LOCAL
async function syncRepairFromCloud(username) {
    if (!db) {
        console.error("Firestore ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o!");
        return;
    }

    const userRef = doc(db, "users", username);
    const snap = await getDoc(userRef);

    let cloudRepairs = [];
    if (snap.exists()) {
        const cloudData = snap.data();
        cloudRepairs = Array.isArray(cloudData.repairs) ? cloudData.repairs : [];
    }

    // L·∫•y local
    const localKey = `repairs_${username}`;
    const localRepairs = JSON.parse(localStorage.getItem(localKey) || "[]");

    // Merge KH√îNG tr√πng
    const merged = mergeRepairs(localRepairs, cloudRepairs);

    // L∆∞u local
    localStorage.setItem(localKey, JSON.stringify(merged));

    console.log("üîÑ Merge s·ª≠a xe xong:", merged);
    return merged;
}
window.syncRepairFromCloud = syncRepairFromCloud;

// ---- Merge chu·∫©n nh·∫•t ----
function genKey(r) {
    return `${r.phutung}|${r.diadiem}|${r.thoigian}|${r.chiphi}`;
}

function mergeRepairs(localArr, cloudArr) {
    const map = new Map();

    localArr.forEach(r => map.set(genKey(r), r));
    cloudArr.forEach(r => map.set(genKey(r), r));

    return Array.from(map.values());
}
</script>



<!-- End auto-sync module -->
</body>
</html>
