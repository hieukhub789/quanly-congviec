<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω ƒë∆°n Grab / Be</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
   tbody tr:hover {
  background-color: #fff3cd; /* v√†ng nh·∫°t */
  }

  tr:nth-child(even) {
  background-color: #fafafa;
  }

  tbody tr:hover {
  background-color: #fff3cd;
  }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    .form-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      max-width: 1000px;
      margin: 0 auto 30px;
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: bold;
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="number"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .full-row {
      grid-column: span 3;
      text-align: center;
    }

    button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #0056b3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #f0f0f0;
    }

    tr:nth-child(even) {
      background-color: #fafafa;
    }

    #searchInput {
      width: 100%;
      max-width: 300px;
      padding: 12px;
      margin: 0 auto 16px;
      display: block;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
    }

    .modal-content input {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-top: 8px;
    }

    @media (max-width: 768px) {
      .form-container {
        grid-template-columns: 1fr;
      }

      .full-row {
        grid-column: span 1;
      }
    }

    .readonly-field {
      background-color: #e0e0e0;
    }

    .toast {
  position: fixed;
  top: 20px;
  right: -400px;
  background-color: #28a745;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  font-size: 16px;
  z-index: 2000;
  transition: right 0.5s ease;
}
.toast.show {
  right: 20px;
}

.modal-content.modal-lichsu {
  background-color: #fff;
  width: 90vw;
  max-width: 1200px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 0 15px rgba(0,0,0,0.2);
  text-align: center;
}

/* Ti√™u ƒë·ªÅ modal */
.modal-title {
  margin-bottom: 15px;
  font-size: 20px;
}

/* B·∫£ng l·ªãch s·ª≠ */
.lichsu-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 15px;
  text-align: left;
}

.lichsu-table th, .lichsu-table td {
  padding: 8px;
  border: 1px solid #ccc;
}

.lichsu-table thead {
  background-color: #f0f0f0;
}

/* N√∫t ƒë√≥ng */
.modal-footer {
  margin-top: 20px;
}

.btn-dong {
  padding: 8px 16px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-dong:hover {
  background-color: #0056b3;
}

.btn-xoa-tatca {
  padding: 8px 16px;
  background-color: #dc3545;
  color: white;
  border: none;
  border-radius: 4px;
  margin-right: 10px;
  cursor: pointer;
}

.btn-xoa-tatca:hover {
  background-color: #b52a37;
}
.btn-xuat-csv {
  padding: 6px 3px;
  background-color: #651fb1;
  color: white;
  border: none;
  margin-top: 8px;
  border-radius: 4px;
  margin-right: 10px;
  cursor: pointer;
}

.btn-xuat-csv:hover {
  background-color: #2fd2e4;
}
.so-am {
  color: red;
  font-weight: bold;
}

  </style>
  <!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

</head>
<body>

<h2>Qu·∫£n l√Ω ƒë∆°n Grab / Be</h2>

<div class="form-container">
  <div class="form-group"><label>Ng√†y g·ª≠i</label><input type="text" id="ngayGui" placeholder="dd/mm/yyyy"></div>
  <div class="form-group"><label>Ng∆∞·ªùi nh·∫≠n</label><input type="text" id="nguoiNhan"></div>
  <div class="form-group"><label>ƒê·ªãa ch·ªâ</label><input type="text" id="diaChi"></div>
  <div class="form-group"><label>SƒêT</label><input type="text" id="sdt" oninput="this.value=this.value.replace(/[^0-9]/g,'')"></div>
  <div class="form-group"><label>C∆∞·ªõc ph√≠</label><input type="text" id="cuocPhi" oninput="dinhDangCuocPhi(this)"></div>
  <div class="form-group"><label>N·ªôi dung</label><input type="text" id="noiDung"></div>
 <div class="form-group" style="position: relative;">
  <label>S·ªë ti·ªÅn nh·∫≠n</label>
  <input type="text" id="stn" readonly class="readonly-field" />

  <span id="lockIcon" onclick="moKhoa()" style="position:absolute; right:10px; top: 30px;cursor:pointer; margin-bottom: 10px; ">
    üîí
  </span>
</div>


  <div class="full-row">
    <button onclick="themDon()">Th√™m ƒë∆°n</button>
    <button onclick="hienModalXacNhan('tatca')" style="background-color: #dc3545;">Xo√° to√†n b·ªô d·ªØ li·ªáu</button>
    <button onclick="document.getElementById('jsonInput').click()" style="background-color: #28a745;">Nh·∫≠p JSON</button>
  <button onclick="xuatFileJson()" style="background-color: rgb(45, 11, 215);">Xu·∫•t JSON</button>
  <button onclick="moLichSuModal()">L·ªãch s·ª≠ thay ƒë·ªïi ti·ªÅn nh·∫≠n</button>

  <input type="file" id="jsonInput" accept=".json" style="display:none" onchange="nhapFileJson(event)">
  </div>
</div>

<input type="text" id="searchInput" oninput="timKiemDon()" placeholder="T√¨m ki·∫øm theo t√™n, ƒë·ªãa ch·ªâ, n·ªôi dung...">
<div style="text-align: center; margin-bottom: 10px;">
  <label>
    T·ª´ ng√†y:
    <input type="text" id="startDate" placeholder="T·ª´ ng√†y (dd/mm/yyyy)"  oninput="timKiemDon()">
  </label>
  <label style="margin-left: 10px;">
    ƒê·∫øn ng√†y:
    <input type="text" id="endDate" placeholder="ƒê·∫øn ng√†y (dd/mm/yyyy) "  oninput="timKiemDon()">
  </label>
  <button onclick="xoaLocNgay()" style="margin-left: 10px;">Xo√° l·ªçc ng√†y</button>
</div>



<table>
  <thead>
    <tr>
      <th>STT</th>
      <th>Ng√†y g·ª≠i</th>
      <th>Ng∆∞·ªùi nh·∫≠n</th>
      <th>ƒê·ªãa ch·ªâ</th>
      <th>SƒêT</th>
      <th>C∆∞·ªõc ph√≠</th>
      <th>N·ªôi dung</th>
    </tr>
  </thead>
  <tbody id="bangDon"></tbody>
</table>


<div style="text-align: center; margin-top: 20px;">
  <button onclick="chuyenTrang(-1)">‚Üê Tr∆∞·ªõc</button>
  <span id="thongTinTrang" style="margin: 0 10px;"></span>
  <button onclick="chuyenTrang(1)">Sau ‚Üí</button>
</div>
<div id="thongKeDon" style="margin-top: 10px; font-weight: bold; text-align: left; font-size: 16px; color: #333;">
  T·ªïng s·ªë ƒë∆°n h√†ng: 0
</div>
<div id="tongTienNhan" style="text-align:right; font-weight:bold; margin-top:10px;">
  T·ªïng s·ªë ti·ªÅn nh·∫≠n: 0 VND
</div>
<div id="tongCuocPhi" style="text-align:right; font-weight:bold; margin-top:4px;">
  T·ªïng c∆∞·ªõc ph√≠: 0 VND
</div>
<div id="soTienConLai" style="text-align:right; font-weight:bold; margin-top:4px;">
  S·ªë ti·ªÅn c√≤n l·∫°i: 0 VND
</div>




<!-- Modal chi ti·∫øt -->
<div id="chiTietModal" class="modal">
  <div class="modal-content">
    <h3>Chi ti·∫øt ƒë∆°n</h3>
    <label>Ng√†y g·ª≠i</label><input id="ctNgayGui" readonly>
    <label>Ng∆∞·ªùi nh·∫≠n</label><input id="ctNguoiNhan" readonly>
    <label>ƒê·ªãa ch·ªâ</label><input id="ctDiaChi" readonly>
    <label>SƒêT</label><input id="ctSdt" readonly>
    <label>C∆∞·ªõc ph√≠</label><input id="ctCuocPhi" readonly oninput="dinhDangSo(this)">
    <label>N·ªôi dung</label><input id="ctNoiDung" readonly>
    <div style="text-align:right; margin-top:10px;">
      <button id="btnLuu" onclick="luuChinhSua()" style="display:none; background-color:#28a745; color:white;">L∆∞u</button>
      <button id="btnSua" onclick="batChinhSua()">S·ª≠a</button>
      <button onclick="hienModalXacNhan('don')" style="background-color:#dc3545; color:white;">Xo√°</button>
      <button onclick="dongModal()">ƒê√≥ng</button>
    </div>
  </div>
</div>

<!-- Modal x√°c nh·∫≠n -->
<div id="modalXacNhan" class="modal">
  <div class="modal-content" style="text-align:center;">
    <p id="noiDungXacNhan" style="font-size:18px;"></p>
    <button onclick="thucHienXoa()" style="background-color:#dc3545; color:white;">Xo√°</button>
    <button onclick="dongModalXacNhan()">Hu·ª∑</button>
  </div>
</div>

<!-- modal m·ªü kh√≥a -->
<div id="unlockModal" class="modal">
  <div class="modal-content" style="text-align:center;">
    <h3>üîê Nh·∫≠p m·∫≠t kh·∫©u & l√Ω do thay ƒë·ªïi</h3>
    <input type="password" id="unlockPassword" placeholder="M·∫≠t kh·∫©u..." />
    <input type="text" id="lyDoThayDoi" placeholder="L√Ω do thay ƒë·ªïi..." style="margin-top:10px;" />
    <div style="margin-top:15px;">
      <button onclick="xacNhanMoKhoaTien()">X√°c nh·∫≠n</button>
      <button onclick="dongUnlockModal()">Hu·ª∑</button>
    </div>
  </div>
</div>

<!-- Modal l·ªãch s·ª≠ thay ƒë·ªïi ti·ªÅn nh·∫≠n -->
<div id="lichSuModal" class="modal">
  <div class="modal-content modal-lichsu">
    <h3 class="modal-title">üìú L·ªãch s·ª≠ thay ƒë·ªïi ti·ªÅn nh·∫≠n</h3>
    <table class="lichsu-table">
      <thead>
        <tr>
          <th>Th·ªùi gian</th>
          <th>Ti·ªÅn c≈©</th>
          <th>Ti·ªÅn m·ªõi</th>
          <th>L√Ω do</th>
        </tr>
      </thead>
      <tbody id="lichSuTableBody">
        <!-- d·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
      </tbody>
    </table>
    <div class="modal-footer">
      <button class="btn-xuat-csv" onclick="xuatLichSuJSON()">üì§ Xu·∫•t CSV</button>
      <button class="btn-xoa-tatca" onclick="xoaTatCaLichSu()"> Xo√° t·∫•t c·∫£</button>
      <button onclick="dongLichSuModal()" class="btn-dong">ƒê√≥ng</button>
    </div>
  </div>
</div>




<div id="toast" class="toast">Th√¥ng b√°o</div>


<script>
let dsDon = JSON.parse(localStorage.getItem("dsDon")) || [];
let chiSoHienTai = -1;
let cheDoXoa = "";
let ketQuaTimKiem = [];
let trangHienTai = 1;
const soDongMoiTrang = 10;
let tienNhanLucMoKhoa = null;
let lyDoMoKhoa = ""; // üÜï l∆∞u l·∫°i l√Ω do nh·∫≠p

function capNhatTongSoTien() {
  const value = document.getElementById("stn").value;
  const soTien = parseInt(value.replace(/[^0-9]/g, ""), 10) || 0;
  localStorage.setItem("soTienNhan", soTien);

  document.getElementById("tongTienNhan").textContent = `T·ªïng s·ªë ti·ªÅn nh·∫≠n: ${soTien.toLocaleString()} VND`;

  capNhatTongCuocPhiVaTienConLai(); // g·ªçi h√†m t√≠nh th√™m
  

}
function capNhatTongCuocPhiVaTienConLai() {
  const tongCuoc = ketQuaTimKiem.reduce((sum, don) => sum + (parseInt(don.cuocPhi) || 0), 0);
  const soTienNhan = parseInt(localStorage.getItem("soTienNhan") || "0", 10);
  const conLai = soTienNhan - tongCuoc;

 document.getElementById("tongCuocPhi").textContent = `T·ªïng c∆∞·ªõc ph√≠: ${tongCuoc.toLocaleString()} VND`;
  const soTienConLaiEl = document.getElementById("soTienConLai");
  soTienConLaiEl.textContent = `S·ªë ti·ªÅn c√≤n l·∫°i: ${conLai.toLocaleString()} VND`;

  if (conLai < 0) {
    soTienConLaiEl.classList.add("so-am");
  } else {
    soTienConLaiEl.classList.remove("so-am");
  }
}


function hienThiBang(data) {
  const tbody = document.getElementById("bangDon");
  tbody.innerHTML = "";

  data.forEach((don, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${(trangHienTai - 1) * soDongMoiTrang + index + 1}</td>
      <td>${don.ngayGui}</td>
      <td>${don.nguoiNhan}</td>
      <td>${don.diaChi}</td>
      <td>${don.sdt}</td>
      <td>${Number(don.cuocPhi).toLocaleString()}</td>
      <td>${don.noiDung}</td>
    `;

    row.onclick = () => moModalChiTiet(don); // truy·ªÅn object
    tbody.appendChild(row);
  });
}


function themDon() {
  const don = {
    ngayGui: document.getElementById("ngayGui").value.trim(),
    nguoiNhan: document.getElementById("nguoiNhan").value.trim(),
    diaChi: document.getElementById("diaChi").value.trim(),
    sdt: document.getElementById("sdt").value.trim(),
    cuocPhi: document.getElementById("cuocPhi").value.replace(/\D/g, ""),
    noiDung: document.getElementById("noiDung").value.trim()
  };

  if (!don.ngayGui || !don.noiDung ||  !don.cuocPhi) {
    hienToast("Vui l√≤ng Vui l√≤ng nh·∫≠p n·ªôi dung v√† c∆∞·ªõc ph√≠ v√† ng√†y");
    return;
  }

  dsDon.unshift(don);
  localStorage.setItem("dsDon", JSON.stringify(dsDon));
  timKiemDon();
  ["ngayGui","nguoiNhan","diaChi","sdt","cuocPhi","noiDung"].forEach(id => document.getElementById(id).value = "");
  capNhatTongCuocPhiVaTienConLai();
  hienToast("‚úîÔ∏è ƒê√£ th√™m ƒë∆°n th√†nh c√¥ng!");

}

function timKiemDon() {
  const kw = document.getElementById("searchInput").value.toLowerCase();
  const startDateStr = document.getElementById("startDate").value;
  const endDateStr = document.getElementById("endDate").value;

  const startDate = startDateStr ? chuyenNgayVNVeDate(startDateStr) : null;
  const endDate = endDateStr ? chuyenNgayVNVeDate(endDateStr) : null;


  localStorage.setItem("boLoc", JSON.stringify({
    keyword: kw,
    startDate: startDateStr,
    endDate: endDateStr
  }));    

  ketQuaTimKiem = dsDon
    .slice()
    .sort((a, b) => {
    const dateA = chuyenNgayVNVeDate(a.ngayGui);
    const dateB = chuyenNgayVNVeDate(b.ngayGui);
    return dateB - dateA; // m·ªõi ‚Üí c≈©
    })
    .filter(d => {
      const ngayDon = chuyenNgayVNVeDate(d.ngayGui);

      const textMatch =
        (d.nguoiNhan || "").toLowerCase().includes(kw) ||
        (d.diaChi || "").toLowerCase().includes(kw) ||
        (d.sdt || "").toLowerCase().includes(kw) ||
        (d.noiDung || "").toLowerCase().includes(kw)||
        (d.ngayGui || "").toLowerCase().includes(kw) ||
        (d.cuocPhi || "").toLowerCase().includes(kw);

      const dateMatch =
        (!startDate || (ngayDon && ngayDon >= startDate)) &&
        (!endDate || (ngayDon && ngayDon <= endDate));

      return textMatch && dateMatch;
    });

  trangHienTai = 1;
  hienThiTrang();
  capNhatTongSoDon();
}



function chuyenNgayVNVeDate(ngayVN) {
  const [dd, mm, yyyy] = ngayVN.split("/").map(x => parseInt(x, 10));
  return new Date(yyyy, mm - 1, dd); // Th√°ng trong JS b·∫Øt ƒë·∫ßu t·ª´ 0
}


function xoaLocNgay() {
  document.getElementById("startDate").value = "";
  document.getElementById("endDate").value = "";
  timKiemDon();
  
}

function chuanHoaNgay(chuoi) {
  const parts = chuoi.split("/");
  if (parts.length !== 3) return new Date("Invalid Date");
  const [day, month, year] = parts;
  return new Date(`${year}-${month}-${day}`);
}


function hienThiTrang() {
  const batDau = (trangHienTai - 1) * soDongMoiTrang;
  const ketThuc = batDau + soDongMoiTrang;
  const duLieuTrang = ketQuaTimKiem.slice(batDau, ketThuc);
  hienThiBang(duLieuTrang);
  capNhatTongSoDon();
  const tongTrang = Math.ceil(ketQuaTimKiem.length / soDongMoiTrang);
  document.getElementById("thongTinTrang").textContent = `Trang ${trangHienTai} / ${tongTrang}`;
  capNhatTongCuocPhiVaTienConLai();

}

function chuyenTrang(huong) {
  const tongTrang = Math.ceil(ketQuaTimKiem.length / soDongMoiTrang);
  if ((huong === -1 && trangHienTai > 1) || (huong === 1 && trangHienTai < tongTrang)) {
    trangHienTai += huong;
    hienThiTrang();
  }
}

function moModalChiTiet(don) {
  ["NgayGui","NguoiNhan","DiaChi","Sdt","CuocPhi","NoiDung"].forEach(f => {
  const input = document.getElementById("ct" + f);
  let val = don[f.charAt(0).toLowerCase() + f.slice(1)];

  // üëâ ƒê·ªãnh d·∫°ng ri√™ng cho c∆∞·ªõc ph√≠
  if (f === "CuocPhi") {
    val = Number(val || 0).toLocaleString("vi-VN") ;
  }

  input.value = val;
  input.setAttribute("readonly", true);
  input.classList.add("readonly-field");
});


  // t√¨m ƒë√∫ng ch·ªâ s·ªë trong dsDon ƒë·ªÉ s·ª≠a/xo√° sau n√†y
  chiSoHienTai = dsDon.findIndex(d =>
    d.ngayGui === don.ngayGui &&
    d.nguoiNhan === don.nguoiNhan &&
    d.diaChi === don.diaChi &&
    d.sdt === don.sdt &&
    d.cuocPhi === don.cuocPhi &&
    d.noiDung === don.noiDung
  );

  document.getElementById("btnSua").style.display = "inline-block";
  document.getElementById("btnLuu").style.display = "none";
  document.getElementById("chiTietModal").style.display = "flex";
}


function dongModal() {
  document.getElementById("chiTietModal").style.display = "none";
  chiSoHienTai = -1;
}

function batChinhSua() {
  ["ctNgayGui", "ctNguoiNhan", "ctDiaChi", "ctSdt", "ctCuocPhi", "ctNoiDung"].forEach(id => {
    const input = document.getElementById(id);
    input.removeAttribute("readonly");
    input.classList.remove("readonly-field");

    // ‚úÖ ƒê·ªãnh d·∫°ng l·∫°i c∆∞·ªõc ph√≠ khi chuy·ªÉn sang ch·∫ø ƒë·ªô s·ª≠a
    if (id === "ctCuocPhi") {
      const raw = input.value.replace(/[^\d]/g, "");
      input.value = Number(raw).toLocaleString("vi-VN");
    }
  });

  document.getElementById("btnSua").style.display = "none";
  document.getElementById("btnLuu").style.display = "inline-block";
}


function luuChinhSua() {
  if (chiSoHienTai < 0) return;

  // ‚ö†Ô∏è L√†m s·∫°ch c∆∞·ªõc ph√≠ tr∆∞·ªõc khi l∆∞u
  const rawCuocPhi = document.getElementById("ctCuocPhi").value.replace(/[^\d]/g, "");

  const capNhat = {
    ngayGui: document.getElementById("ctNgayGui").value.trim(),
    nguoiNhan: document.getElementById("ctNguoiNhan").value.trim(),
    diaChi: document.getElementById("ctDiaChi").value.trim(),
    sdt: document.getElementById("ctSdt").value.trim(),
    cuocPhi: rawCuocPhi,
    noiDung: document.getElementById("ctNoiDung").value.trim()
  };

  if (!capNhat.ngayGui || !capNhat.noiDung  || !capNhat.cuocPhi) {
    hienToast("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin tr∆∞·ªõc khi l∆∞u!");
    return;
  }

  // L∆∞u l·∫°i
  dsDon[chiSoHienTai] = capNhat;
  localStorage.setItem("dsDon", JSON.stringify(dsDon));
  timKiemDon();
  capNhatTongCuocPhiVaTienConLai();

  // Reset l·∫°i readonly
  ["ctNgayGui", "ctNguoiNhan", "ctDiaChi", "ctSdt", "ctCuocPhi", "ctNoiDung"].forEach(id => {
    const input = document.getElementById(id);
    input.setAttribute("readonly", true);
    input.classList.add("readonly-field");
  });

  document.getElementById("btnLuu").style.display = "none";
  document.getElementById("btnSua").style.display = "inline-block";
}





function hienModalXacNhan(loai) {
  cheDoXoa = loai;
  document.getElementById("noiDungXacNhan").textContent =
    loai === "don" ? "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° ƒë∆°n n√†y?" : "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° to√†n b·ªô d·ªØ li·ªáu?";
  document.getElementById("modalXacNhan").style.display = "flex";
}

function dongModalXacNhan() {
  document.getElementById("modalXacNhan").style.display = "none";
}

function thucHienXoa() {
  if (cheDoXoa === "don" && chiSoHienTai >= 0) {
    dsDon.splice(chiSoHienTai, 1);
    hienToast("üóëÔ∏è ƒê√£ xo√° ƒë∆°n!");
  } else if (cheDoXoa === "tatca") {
    // üîÅ Backup tr∆∞·ªõc khi xo√°
    const dataBackup = localStorage.getItem("dsDon");
    if (dataBackup) {
      const blob = new Blob([dataBackup], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "backup_don_grab_be.json";
      a.click();
      URL.revokeObjectURL(url);
      hienToast("üíæ ƒê√£ l∆∞u b·∫£n backup tr∆∞·ªõc khi xo√°!", "#ffc107");
    }

    // üßπ Xo√° to√†n b·ªô
    dsDon = [];
  }

  localStorage.setItem("dsDon", JSON.stringify(dsDon));
  timKiemDon();
  dongModal();
  dongModalXacNhan();
  cheDoXoa = "";
  capNhatTongCuocPhiVaTienConLai();
}




function capNhatTongSoTien() {
  const value = document.getElementById("stn").value;
  const soTien = parseInt(value.replace(/[^0-9]/g, ""), 10) || 0;
  localStorage.setItem("soTienNhan", soTien);
  document.getElementById("tongTienNhan").textContent = `T·ªïng s·ªë ti·ªÅn nh·∫≠n: ${soTien.toLocaleString()} ƒë`;
  capNhatTongCuocPhiVaTienConLai(); // g·ªçi h√†m t√≠nh th√™m
}

window.onload = () => {
  ketQuaTimKiem = dsDon;

  // ‚úÖ Load s·ªë ti·ªÅn nh·∫≠n t·ª´ localStorage
  const tienNhan = parseInt(localStorage.getItem("soTienNhan") || "0", 10);
  const stnInput = document.getElementById("stn");
  stnInput.value = tienNhan.toLocaleString("vi-VN");

  // üõ†Ô∏è G·∫Øn ƒë·ªãnh d·∫°ng khi nh·∫≠p
  stnInput.removeEventListener("input", stnInput._dinhDang);
  stnInput._dinhDang = () => dinhDangSoTienNhan(stnInput);
  stnInput.addEventListener("input", stnInput._dinhDang);

  // ‚úÖ Hi·ªÉn th·ªã t·ªïng
  document.getElementById("tongTienNhan").textContent = `T·ªïng s·ªë ti·ªÅn nh·∫≠n: ${tienNhan.toLocaleString()} VND`;

  // ‚úÖ Kh√¥i ph·ª•c b·ªô l·ªçc n·∫øu c√≥
  const boLoc = JSON.parse(localStorage.getItem("boLoc") || "{}");
  if (boLoc.keyword !== undefined) document.getElementById("searchInput").value = boLoc.keyword;
  if (boLoc.startDate) document.getElementById("startDate").value = boLoc.startDate;
  if (boLoc.endDate) document.getElementById("endDate").value = boLoc.endDate;

  // ‚úÖ G·ªçi l·∫°i t√¨m ki·∫øm v·ªõi b·ªô l·ªçc ƒë√£ kh√¥i ph·ª•c
  timKiemDon();
  capNhatTongCuocPhiVaTienConLai();
};




let daMoKhoaTienNhan = false;
function moKhoa() {
  const stnInput = document.getElementById("stn");

  if (!daMoKhoaTienNhan) {
    // ƒêang b·ªã kho√° ‚Üí m·ªü kho√°
    document.getElementById("unlockModal").style.display = "flex";
    document.getElementById("unlockPassword").value = "";
    document.getElementById("lyDoThayDoi").value = "";
  } else {
    // ƒêang m·ªü ‚Üí B·∫§M L·∫†I ƒë·ªÉ kho√° l·∫°i

    // üîπ L·∫•y s·ªë ti·ªÅn m·ªõi sau khi ng∆∞·ªùi d√πng ƒë√£ s·ª≠a
    const tienMoi = parseInt((stnInput.value || "0").replace(/\D/g, ""), 10) || 0;

    // N·∫øu c√≥ thay ƒë·ªïi so v·ªõi l√∫c m·ªü
    if (tienMoi !== tienNhanLucMoKhoa) {
      const lichSu = JSON.parse(localStorage.getItem("lichSuTienNhan") || "[]");
      lichSu.unshift({
        thoiGian: new Date().toLocaleString("vi-VN"),
        tienCu: tienNhanLucMoKhoa,
        tienMoi: tienMoi,
        lyDo: lyDoMoKhoa || "Kh√¥ng r√µ l√Ω do",
      });
      localStorage.setItem("lichSuTienNhan", JSON.stringify(lichSu));
    }

    // ‚úÖ L∆∞u ti·ªÅn m·ªõi
    localStorage.setItem("soTienNhan", tienMoi);
    document.getElementById("tongTienNhan").textContent = `T·ªïng s·ªë ti·ªÅn nh·∫≠n: ${tienMoi.toLocaleString()} VND`;
    capNhatTongCuocPhiVaTienConLai();

    // Kho√° l·∫°i input
    stnInput.setAttribute("readonly", true);
    stnInput.classList.add("readonly-field");
    document.getElementById("lockIcon").textContent = "üîí";

    daMoKhoaTienNhan = false;
    tienNhanLucMoKhoa = null;
  }
}



function dongUnlockModal() {
  document.getElementById("unlockModal").style.display = "none";
  document.getElementById("unlockPassword").value = "";
  document.getElementById("lyDoThayDoi").value = "";
}


function kiemTraMatKhau() {
  const pass = document.getElementById("unlockPassword").value;
  if (pass === "78945607") {
    daMoKhoaTienNhan = true;
    const stnInput = document.getElementById("stn");
    stnInput.removeAttribute("readonly");
    stnInput.classList.remove("readonly-field");
    document.getElementById("lockIcon").textContent = "üîì";

    // G·∫Øn ƒë·ªãnh d·∫°ng m·ªói l·∫ßn nh·∫≠p
    stnInput.removeEventListener("input", stnInput._dinhDang);
    stnInput._dinhDang = () => dinhDangSoTienNhan(stnInput);
    stnInput.addEventListener("input", stnInput._dinhDang);

    dongUnlockModal();
  } else {
    hienToast("Sai m·∫≠t kh·∫©u!");
  }
}

function nhapFileJson(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (Array.isArray(data)) {
        const existingSet = new Set(dsDon.map(d => JSON.stringify(d)));
        const newData = data.filter(d => !existingSet.has(JSON.stringify(d)));

        if (newData.length === 0) {
          hienToast("‚ÑπÔ∏è D·ªØ li·ªáu ƒë√£ t·ªìn t·∫°i, kh√¥ng c√≥ ƒë∆°n m·ªõi.");
          return;
        }

        dsDon = [...newData, ...dsDon]; // th√™m l√™n ƒë·∫ßu
        localStorage.setItem("dsDon", JSON.stringify(dsDon));
        hienToast(`üì• ƒê√£ th√™m ${newData.length} ƒë∆°n t·ª´ JSON.`);
        timKiemDon();
      } else {
        hienToast("‚ùå D·ªØ li·ªáu JSON kh√¥ng h·ª£p l·ªá.");
      }
    } catch (err) {
      hienToast("‚ùå L·ªói khi ƒë·ªçc file JSON.");
    }
  };
  reader.readAsText(file);
}



function xuatFileJson() {
  const blob = new Blob([JSON.stringify(dsDon, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "don_grab_be.json";
  a.click();
  URL.revokeObjectURL(url);
  hienToast("üì§ Xu·∫•t JSON th√†nh c√¥ng!");

}
// th√¥ng b√°o
function hienToast(message, color = "#28a745") {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.style.backgroundColor = color;
  toast.classList.add("show");

  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000);
}
</script>
<script>
  flatpickr("#startDate", {
  dateFormat: "d/m/Y",
  allowInput: true
});
flatpickr("#endDate", {
  dateFormat: "d/m/Y",
  allowInput: true
});
flatpickr("#ngayGui", {
  dateFormat: "d/m/Y",
  allowInput: true
});
function dinhDangCuocPhi(input) {
  // L∆∞u l·∫°i v·ªã tr√≠ con tr·ªè
  const cursorPos = input.selectionStart;
  const oldLength = input.value.length;

  // Xo√° d·∫•u ch·∫•m/ngƒÉn c√°ch n·∫øu c√≥
  let rawValue = input.value.replace(/\D/g, ""); // ch·ªâ gi·ªØ s·ªë

  // Format l·∫°i
  if (rawValue) {
    input.value = parseInt(rawValue, 10).toLocaleString("vi-VN");
  } else {
    input.value = "";
  }

  // C·∫≠p nh·∫≠t l·∫°i v·ªã tr√≠ con tr·ªè (ƒë·ªÉ kh√¥ng b·ªã nh·∫£y lung tung)
  const newLength = input.value.length;
  const newPos = cursorPos + (newLength - oldLength);
  input.setSelectionRange(newPos, newPos);
}
function dinhDangSoTienNhan(input) {
  // Ghi nh·ªõ v·ªã tr√≠ con tr·ªè (tu·ª≥ ch·ªçn)
  const selectionStart = input.selectionStart;

  // L·∫•y gi√° tr·ªã s·ªë thu·∫ßn
  const rawValue = input.value.replace(/\D/g, "");
  if (!rawValue) {
    input.value = "";
    return;
  }

  // ‚úÖ C·∫≠p nh·∫≠t input hi·ªÉn th·ªã
  const tienMoi = parseInt(rawValue, 10);
  input.value = tienMoi.toLocaleString("vi-VN");

  // Kh√¥ng ghi v√†o localStorage ·ªü ƒë√¢y n·ªØa ‚ùå
  // Kh√¥ng c·∫≠p nh·∫≠t t·ªïng ·ªü ƒë√¢y ‚ùå

  // ƒê∆∞a con tr·ªè v·ªÅ cu·ªëi (tu·ª≥ ch·ªçn)
  input.setSelectionRange(input.value.length, input.value.length);
}


function dinhDangSo(input) {
  let value = input.value.replace(/\D/g, "");
  if (value) input.value = Number(value).toLocaleString("vi-VN");
}
function capNhatTongSoDon() {
  document.getElementById("thongKeDon").textContent = `T·ªïng s·ªë ƒë∆°n h√†ng: ${ketQuaTimKiem.length}`;
}

function xacNhanMoKhoaTien() {
  const pass = document.getElementById("unlockPassword").value;
  const lyDo = document.getElementById("lyDoThayDoi").value.trim();

  if (pass !== "78945607") return hienToast("‚ùå Sai m·∫≠t kh·∫©u!");
  if (!lyDo) return hienToast("‚ö†Ô∏è Vui l√≤ng nh·∫≠p l√Ω do!");

  daMoKhoaTienNhan = true;
  lyDoMoKhoa = lyDo;

  const stnInput = document.getElementById("stn");
  stnInput.removeAttribute("readonly");
  stnInput.classList.remove("readonly-field");
  document.getElementById("lockIcon").textContent = "üîì";

  // üîπ Ghi nh·ªõ s·ªë ti·ªÅn c≈© t·∫°i th·ªùi ƒëi·ªÉm m·ªü kho√°
  tienNhanLucMoKhoa = parseInt((stnInput.value || "0").replace(/\D/g, ""), 10) || 0;

  dongUnlockModal();
  hienToast("‚úÖ ƒê√£ m·ªü kho√° ti·ªÅn nh·∫≠n!");
}


function moLichSuModal() {
  const lichSu = JSON.parse(localStorage.getItem("lichSuTienNhan") || "[]");
  const tbody = document.getElementById("lichSuTableBody");
  tbody.innerHTML = "";

  if (lichSu.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Ch∆∞a c√≥ l·ªãch s·ª≠ thay ƒë·ªïi</td></tr>`;
  } else {
    lichSu.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.thoiGian}</td>
        <td>${(item.tienCu || 0).toLocaleString("vi-VN")} ƒë</td>
        <td>${item.tienMoi !== null ? Number(item.tienMoi).toLocaleString("vi-VN") + " ƒë" : "-"}</td>
        <td>${item.lyDo}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.getElementById("lichSuModal").style.display = "flex";
}
function dongLichSuModal() {
  document.getElementById("lichSuModal").style.display = "none";
}

function xoaTatCaLichSu() {
  if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° to√†n b·ªô l·ªãch s·ª≠ thay ƒë·ªïi ti·ªÅn nh·∫≠n kh√¥ng?")) {
    // Xo√° d·ªØ li·ªáu
    localStorage.removeItem("lichSuTienNhan");

    // Xo√° n·ªôi dung b·∫£ng th·ªß c√¥ng
    const tbody = document.getElementById("lichSuTableBody");
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Ch∆∞a c√≥ l·ªãch s·ª≠ thay ƒë·ªïi</td></tr>`;

    // ƒê√≥ng modal
    document.getElementById("lichSuModal").style.display = "none";

    // Th√¥ng b√°o
    hienToast("üóëÔ∏è ƒê√£ xo√° to√†n b·ªô l·ªãch s·ª≠!");
  }
}
function xuatLichSuJSON() {
  const lichSu = JSON.parse(localStorage.getItem("lichSuTienNhan") || "[]");
  if (lichSu.length === 0) return hienToast("üìÇ Kh√¥ng c√≥ l·ªãch s·ª≠ ƒë·ªÉ xu·∫•t!");

  // Chuy·ªÉn th√†nh JSON
  const jsonData = JSON.stringify(lichSu, null, 2);

  const blob = new Blob([jsonData], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "lich_su_tien_nhan.json"; // ƒê·ªïi sang .json
  a.click();
  URL.revokeObjectURL(url);

  hienToast("üì§ ƒê√£ xu·∫•t l·ªãch s·ª≠ ti·ªÅn nh·∫≠n (JSON)!");
}




</script>
</body>
</html>
